require('dotenv').config();
const path = require('path');
const { Client, GatewayIntentBits, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle, SlashCommandBuilder, REST, Routes, ModalBuilder, TextInputBuilder, TextInputStyle, AttachmentBuilder, StringSelectMenuBuilder } = require('discord.js');
const connectDB = require('./database/connection');
const User = require('./models/User');
const { generateVerificationCode, sendVerificationEmail } = require('./services/emailService');
const huntingAreas = require('./data/huntingAreas');

// ìƒì  ì•„ì´í…œ ë°ì´í„° (ë ˆë²¨ ì‹œìŠ¤í…œ í¬í•¨)
const shopItems = [
    {
        id: 'basic_sword',
        name: 'ê¸°ë³¸ ê²€',
        type: 'weapon',
        rarity: 'ë…¸ë©€',
        level: 1,
        price: 500,
        stats: { attack: 10, defense: 0, hp: 0, mp: 0 },
        description: 'ëª¨í—˜ê°€ë¥¼ ìœ„í•œ ê¸°ë³¸ì ì¸ ê²€ì…ë‹ˆë‹¤.'
    },
    {
        id: 'basic_armor',
        name: 'ê¸°ë³¸ ê°‘ì˜·',
        type: 'armor',
        rarity: 'ë…¸ë©€',
        level: 1,
        price: 800,
        stats: { attack: 0, defense: 15, hp: 50, mp: 0 },
        description: 'ê¸°ë³¸ì ì¸ ë°©ì–´ë ¥ì„ ì œê³µí•˜ëŠ” ê°‘ì˜·ì…ë‹ˆë‹¤.'
    },
    {
        id: 'steel_sword',
        name: 'ê°•ì²  ê²€',
        type: 'weapon',
        rarity: 'ë ˆì–´',
        level: 10,
        price: 2000,
        stats: { attack: 25, defense: 0, hp: 0, mp: 0 },
        description: 'ë‹¨ë‹¨í•œ ê°•ì² ë¡œ ë§Œë“  ê²€ì…ë‹ˆë‹¤.'
    },
    {
        id: 'health_potion',
        name: 'ì²´ë ¥ í¬ì…˜',
        type: 'consumable',
        rarity: 'ë…¸ë©€',
        level: 1,
        price: 100,
        stats: { attack: 0, defense: 0, hp: 100, mp: 0 },
        description: 'ì²´ë ¥ì„ íšŒë³µì‹œì¼œì£¼ëŠ” í¬ì…˜ì…ë‹ˆë‹¤.'
    },
    {
        id: 'mana_potion',
        name: 'ë§ˆë‚˜ í¬ì…˜',
        type: 'consumable',
        rarity: 'ë…¸ë©€',
        level: 1,
        price: 100,
        stats: { attack: 0, defense: 0, hp: 0, mp: 50 },
        description: 'ë§ˆë‚˜ë¥¼ íšŒë³µì‹œì¼œì£¼ëŠ” í¬ì…˜ì…ë‹ˆë‹¤.'
    }
];

// ìƒì  ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì •ì˜ (ì „ì—­ìœ¼ë¡œ ì‚¬ìš©)
const SHOP_CATEGORIES = {
    weapon: {
        name: 'ë¬´ê¸°',
        emoji: 'âš”ï¸',
        gif: 'kim_shop_weapon.png',
        items: [
            // ğŸŒ¸ ì¼ë°˜ ë“±ê¸‰ - ê½ƒì ì„¸íŠ¸
            { 
                name: 'ê½ƒì ì¹¼', 
                rarity: 'ì¼ë°˜', 
                price: 500, 
                type: 'weapon',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ê½ƒì˜ í˜ì´ ê¹ƒë“  ê¸°ë³¸ ë¬´ê¸°ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [15, 25], 
                    defense: [5, 10], 
                    dodge: [0, 0], 
                    luck: [0, 0] 
                }
            },
            { 
                name: 'ê½ƒë‹¤ë°œ ë„ë¼', 
                rarity: 'ì¼ë°˜', 
                price: 600, 
                type: 'weapon',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ê½ƒë‹¤ë°œì²˜ëŸ¼ ì•„ë¦„ë‹µì§€ë§Œ ê°•ë ¥í•œ ë„ë¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [25, 35], 
                    defense: [3, 8], 
                    dodge: [-2, -2], 
                    luck: [0, 0] 
                }
            },
            { 
                name: 'ê½ƒí–¥ê¸° í™œ', 
                rarity: 'ì¼ë°˜', 
                price: 550, 
                type: 'weapon',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ê½ƒí–¥ê¸°ê°€ í¼ì§€ë©° í–‰ìš´ì„ ë¶€ë¥´ëŠ” í™œì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [18, 28], 
                    defense: [0, 0], 
                    dodge: [0, 0], 
                    luck: [5, 10] 
                }
            },
            // â­ ê³ ê¸‰ ë“±ê¸‰ - ë³„ë¹› ì„¸íŠ¸
            { 
                name: 'ë³„ë¹› ì¹¼', 
                rarity: 'ê³ ê¸‰', 
                price: 2500, 
                type: 'weapon',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ë³„ì˜ í˜ì´ ê¹ƒë“  ë¬´ê¸°ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [50, 70], 
                    defense: [15, 25], 
                    dodge: [3, 3], 
                    luck: [0, 0] 
                }
            },
            { 
                name: 'ìœ ì„± ë„ë¼', 
                rarity: 'ê³ ê¸‰', 
                price: 2800, 
                type: 'weapon',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ìœ ì„±ì˜ íŒŒê´´ë ¥ì´ ë‹´ê¸´ ê°•ë ¥í•œ ë„ë¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [70, 95], 
                    defense: [10, 20], 
                    dodge: [-3, -3], 
                    luck: [5, 5] 
                }
            },
            { 
                name: 'ì€í•˜ í™œ', 
                rarity: 'ê³ ê¸‰', 
                price: 2600, 
                type: 'weapon',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ì€í•˜ì˜ ì‹ ë¹„ë¡œìš´ í˜ì„ ë‹´ì€ í™œì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [55, 75], 
                    defense: [0, 0], 
                    dodge: [8, 8], 
                    luck: [12, 20] 
                }
            },
            // ğŸ”¥ ë ˆì–´ ë“±ê¸‰ - ë“œë˜ê³¤ ì„¸íŠ¸
            { 
                name: 'ë“œë˜ê³¤ í‚¬ëŸ¬', 
                rarity: 'ë ˆì–´', 
                price: 12000, 
                type: 'weapon',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ìš©ì„ ì²˜ì¹˜í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ ë¬´ê¸°ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [120, 180], 
                    defense: [40, 60], 
                    dodge: [0, 0], 
                    luck: [8, 8] 
                }
            },
            { 
                name: 'ìš©ì˜ ë¶„ë…¸ ë„ë¼', 
                rarity: 'ë ˆì–´', 
                price: 15000, 
                type: 'weapon',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ë¶„ë…¸ê°€ ë‹´ê¸´ íŒŒê´´ì ì¸ ë„ë¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [180, 250], 
                    defense: [25, 45], 
                    dodge: [-5, -5], 
                    luck: [10, 10] 
                }
            },
            { 
                name: 'ë“œë˜ê³¤ë¸Œë ˆìŠ¤ í™œ', 
                rarity: 'ë ˆì–´', 
                price: 13000, 
                type: 'weapon',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ë¸Œë ˆìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹ ë¹„í•œ í™œì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [140, 200], 
                    defense: [0, 0], 
                    dodge: [15, 15], 
                    luck: [20, 35] 
                }
            },
            // ğŸŒ™ ì—í”½ ë“±ê¸‰ - ì‹œê³µ ì„¸íŠ¸
            { 
                name: 'ì‹œê°„ì˜ ì¹¼', 
                rarity: 'ì—í”½', 
                price: 50000, 
                type: 'weapon',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ì‹œê°„ì„ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ì‹ ë¹„í•œ ëŠ¥ë ¥ì´ ë‹´ê¸´ ì¹¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [300, 450], 
                    defense: [100, 150], 
                    dodge: [20, 20], 
                    luck: [15, 15] 
                }
            },
            { 
                name: 'ê³µê°„ ì ˆë‹¨ ë„ë¼', 
                rarity: 'ì—í”½', 
                price: 60000, 
                type: 'weapon',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ê³µê°„ì„ ì ˆë‹¨í•  ìˆ˜ ìˆëŠ” ì°¨ì› ì¡°ì‘ ë„ë¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [450, 650], 
                    defense: [80, 120], 
                    dodge: [-8, -8], 
                    luck: [20, 20] 
                }
            },
            { 
                name: 'ì°¨ì› í™œ', 
                rarity: 'ì—í”½', 
                price: 55000, 
                type: 'weapon',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ë‹¤ë¥¸ ì°¨ì›ì—ì„œ í™”ì‚´ì„ ì†Œí™˜í•˜ëŠ” ì‹ ë¹„í•œ í™œì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [350, 500], 
                    defense: [0, 0], 
                    dodge: [30, 30], 
                    luck: [40, 60] 
                }
            },
            // âœ¨ ë ˆì „ë“œë¦¬ ë“±ê¸‰ - ê°•í™”ì™• ì„¸íŠ¸
            { 
                name: 'ê°•í™”ì™•ì˜ ì¹¼', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 200000, 
                type: 'weapon',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ê°•í™”ì˜ ì™œì´ ë˜ì–´ ì „ì„¤ì´ ëœ ìµœê°•ì˜ ì¹¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [600, 900], 
                    defense: [200, 300], 
                    dodge: [30, 30], 
                    luck: [25, 25] 
                }
            },
            { 
                name: 'ì ˆëŒ€ íŒŒê´´ ë„ë¼', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 250000, 
                type: 'weapon',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ëª¨ë“  ê²ƒì„ íŒŒê´´í•  ìˆ˜ ìˆëŠ” ì ˆëŒ€ì ì¸ í˜ì˜ ë„ë¼ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [900, 1300], 
                    defense: [150, 250], 
                    dodge: [-10, -10], 
                    luck: [35, 35] 
                }
            },
            { 
                name: 'ìš´ëª… ì§€ë°° í™œ', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 220000, 
                type: 'weapon',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ìš´ëª…ì„ ì§€ë°°í•˜ì—¬ ì ˆëŒ€ì ì¸ ì‚¬ê²©ì„ ë³´ì¥í•˜ëŠ” ì „ì„¤ì˜ í™œì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [700, 1000], 
                    defense: [0, 0], 
                    dodge: [50, 50], 
                    luck: [60, 90] 
                }
            }
        ]
    },
    helmet: {
        name: 'í—¬ë©§',
        emoji: 'â›‘ï¸',
        gif: 'kim_shop_hood.png',
        items: [
            // ğŸŒ¸ ì¼ë°˜ ë“±ê¸‰ - ê½ƒì ì„¸íŠ¸
            { 
                name: 'ê½ƒ í™”ê´€', 
                rarity: 'ì¼ë°˜', 
                price: 400, 
                type: 'helmet',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ê½ƒììœ¼ë¡œ ë§Œë“  ì•„ë¦„ë‹¤ìš´ ë¨¸ë¦¬ ì¥ì‹ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [8, 15], 
                    dodge: [3, 6], 
                    luck: [0, 0] 
                }
            },
            // â­ ê³ ê¸‰ ë“±ê¸‰ - ë³„ë¹› ì„¸íŠ¸
            { 
                name: 'ë³„ìë¦¬ ê´€', 
                rarity: 'ê³ ê¸‰', 
                price: 2000, 
                type: 'helmet',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ë³„ìë¦¬ì˜ ì¶•ë³µì´ ë‹´ê¸´ ì‹ ë¹„í•œ ê´€ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [20, 35], 
                    dodge: [8, 15], 
                    luck: [5, 5] 
                }
            },
            // ğŸ”¥ ë ˆì–´ ë“±ê¸‰ - ë“œë˜ê³¤ ì„¸íŠ¸
            { 
                name: 'ìš© íˆ¬êµ¬', 
                rarity: 'ë ˆì–´', 
                price: 10000, 
                type: 'helmet',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ë¹„ëŠ˜ë¡œ ë§Œë“  ê°•ë ¥í•œ ë°©ì–´ë ¥ì˜ íˆ¬êµ¬ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [50, 80], 
                    dodge: [15, 25], 
                    luck: [10, 10] 
                }
            },
            // ğŸŒ™ ì—í”½ ë“±ê¸‰ - ì‹œê³µ ì„¸íŠ¸
            { 
                name: 'ì‹œê³µê°„ ê´€', 
                rarity: 'ì—í”½', 
                price: 40000, 
                type: 'helmet',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ì‹œê³µê°„ì„ ì¡°ì‘í•  ìˆ˜ ìˆëŠ” ì‹ ë¹„í•œ í˜ì´ ë‹´ê¸´ ê´€ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [120, 180], 
                    dodge: [25, 40], 
                    luck: [20, 20] 
                }
            },
            // âœ¨ ë ˆì „ë“œë¦¬ ë“±ê¸‰ - ê°•í™”ì™• ì„¸íŠ¸
            { 
                name: 'ê°•í™”ì™• ê´€', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 180000, 
                type: 'helmet',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ê°•í™”ì˜ ì™•ì´ ì°©ìš©í•˜ëŠ” ìµœê³ ê¸‰ ëŒ€ë§ˆë²•ì‚¬ì˜ ê´€ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [250, 380], 
                    dodge: [40, 60], 
                    luck: [35, 35] 
                }
            }
        ]
    },
    armor: {
        name: 'ê°‘ì˜·',
        emoji: 'ğŸ›¡ï¸',
        gif: 'kim_shop_armor.png',
        items: [
            // ğŸŒ¸ ì¼ë°˜ ë“±ê¸‰ - ê½ƒì ì„¸íŠ¸
            { 
                name: 'ê½ƒì ì˜·', 
                rarity: 'ì¼ë°˜', 
                price: 450, 
                type: 'armor',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ê½ƒììœ¼ë¡œ ë§Œë“  ê°€ë²¼ìš´ ë°©ì–´êµ¬ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [10, 20], 
                    dodge: [2, 4], 
                    luck: [0, 0] 
                }
            },
            // â­ ê³ ê¸‰ ë“±ê¸‰ - ë³„ë¹› ì„¸íŠ¸
            { 
                name: 'ë³„ë¹› ê°‘ì˜·', 
                rarity: 'ê³ ê¸‰', 
                price: 2200, 
                type: 'armor',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ë³„ë¹›ì´ ë°˜ì§ì´ëŠ” ì‹ ë¹„ë¡œìš´ ê°‘ì˜·ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [30, 50], 
                    dodge: [5, 10], 
                    luck: [3, 3] 
                }
            },
            // ğŸ”¥ ë ˆì–´ ë“±ê¸‰ - ë“œë˜ê³¤ ì„¸íŠ¸
            { 
                name: 'ë“œë˜ê³¤ ìŠ¤ì¼€ì¼ ê°‘ì˜·', 
                rarity: 'ë ˆì–´', 
                price: 11000, 
                type: 'armor',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ë¹„ëŠ˜ë¡œ ë§Œë“  ë‹¨ë‹¨í•œ ê°‘ì˜·ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [80, 120], 
                    dodge: [10, 18], 
                    luck: [8, 8] 
                }
            },
            // ğŸŒ™ ì—í”½ ë“±ê¸‰ - ì‹œê³µ ì„¸íŠ¸
            { 
                name: 'ì‹œê³µê°„ ê°‘ì˜·', 
                rarity: 'ì—í”½', 
                price: 45000, 
                type: 'armor',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ì‹œê³µê°„ì˜ ì™œê³¡ìœ¼ë¡œ ê³µê²©ì„ ë°©ì–´í•˜ëŠ” ê°‘ì˜·ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [150, 230], 
                    dodge: [20, 35], 
                    luck: [15, 15] 
                }
            },
            // âœ¨ ë ˆì „ë“œë¦¬ ë“±ê¸‰ - ê°•í™”ì™• ì„¸íŠ¸
            { 
                name: 'ê°•í™”ì™•ì˜ ê°‘ì˜·', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 190000, 
                type: 'armor',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ê°•í™”ì˜ ì ˆëŒ€ìê°€ ì°©ìš©í•˜ëŠ” ìµœê°•ì˜ ê°‘ì˜·ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [300, 450], 
                    dodge: [35, 55], 
                    luck: [30, 30] 
                }
            }
        ]
    },
    gloves: {
        name: 'ì¥ê°‘',
        emoji: 'ğŸ§¤',
        gif: 'kim_shop_gloves.png',
        items: [
            // ğŸŒ¸ ì¼ë°˜ ë“±ê¸‰ - ê½ƒì ì„¸íŠ¸
            { 
                name: 'ê½ƒì ì¥ê°‘', 
                rarity: 'ì¼ë°˜', 
                price: 350, 
                type: 'gloves',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ë¶€ë“œëŸ¬ìš´ ê½ƒììœ¼ë¡œ ë§Œë“  ì¥ê°‘ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [3, 8], 
                    defense: [5, 10], 
                    dodge: [5, 8], 
                    luck: [2, 2] 
                }
            },
            // â­ ê³ ê¸‰ ë“±ê¸‰ - ë³„ë¹› ì„¸íŠ¸
            { 
                name: 'ë³„ë¹› ì¥ê°‘', 
                rarity: 'ê³ ê¸‰', 
                price: 1800, 
                type: 'gloves',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ë³„ì˜ í˜ì´ ê¹ƒë“  ë¯¼ì²©í•œ ì¥ê°‘ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [10, 20], 
                    defense: [15, 25], 
                    dodge: [12, 20], 
                    luck: [8, 8] 
                }
            },
            // ğŸ”¥ ë ˆì–´ ë“±ê¸‰ - ë“œë˜ê³¤ ì„¸íŠ¸
            { 
                name: 'ë“œë˜ê³¤ í´ë¡œ', 
                rarity: 'ë ˆì–´', 
                price: 9000, 
                type: 'gloves',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ë°œí†±ì„ ëª¨ë°©í•œ ê³µê²©ì ì¸ ì¥ê°‘ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [30, 50], 
                    defense: [30, 50], 
                    dodge: [20, 30], 
                    luck: [15, 15] 
                }
            },
            // ğŸŒ™ ì—í”½ ë“±ê¸‰ - ì‹œê³µ ì„¸íŠ¸
            { 
                name: 'ì‹œê³µê°„ ì¥ê°‘', 
                rarity: 'ì—í”½', 
                price: 38000, 
                type: 'gloves',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ì‹œê³µê°„ì„ ì¡°ì‘í•˜ëŠ” ëŠ¥ë ¥ì´ ë‹´ê¸´ ì¥ê°‘ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [60, 100], 
                    defense: [60, 100], 
                    dodge: [35, 50], 
                    luck: [25, 25] 
                }
            },
            // âœ¨ ë ˆì „ë“œë¦¬ ë“±ê¸‰ - ê°•í™”ì™• ì„¸íŠ¸
            { 
                name: 'ê°•í™”ì™•ì˜ ì¥ê°‘', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 170000, 
                type: 'gloves',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ê°•í™”ì˜ í˜ì„ ê·¹ëŒ€í™”ì‹œí‚¤ëŠ” ì „ì„¤ì˜ ì¥ê°‘ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [120, 200], 
                    defense: [120, 200], 
                    dodge: [50, 70], 
                    luck: [40, 40] 
                }
            }
        ]
    },
    boots: {
        name: 'ë¶€ì¸ ',
        emoji: 'ğŸ‘¢',
        gif: 'kim_shop_boots.png',
        items: [
            // ğŸŒ¸ ì¼ë°˜ ë“±ê¸‰ - ê½ƒì ì„¸íŠ¸
            { 
                name: 'ê½ƒì ì‹ ë°œ', 
                rarity: 'ì¼ë°˜', 
                price: 380, 
                type: 'boots',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'ê°€ë³ê³  í¸ì•ˆí•œ ê½ƒì ì‹ ë°œì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [6, 12], 
                    dodge: [8, 12], 
                    luck: [1, 1] 
                }
            },
            // â­ ê³ ê¸‰ ë“±ê¸‰ - ë³„ë¹› ì„¸íŠ¸
            { 
                name: 'ë³„ë¹› ë¶€ì¸ ', 
                rarity: 'ê³ ê¸‰', 
                price: 1900, 
                type: 'boots',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ë³„ì²˜ëŸ¼ ë¹ ë¥¸ ì†ë„ë¥¼ ìë‘í•˜ëŠ” ë¶€ì¸ ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [18, 30], 
                    dodge: [18, 28], 
                    luck: [6, 6] 
                }
            },
            // ğŸ”¥ ë ˆì–´ ë“±ê¸‰ - ë“œë˜ê³¤ ì„¸íŠ¸
            { 
                name: 'ë“œë˜ê³¤ ì›Œì»¤', 
                rarity: 'ë ˆì–´', 
                price: 9500, 
                type: 'boots',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ë°œê±¸ìŒì²˜ëŸ¼ ë¬µì§í•œ ë¶€ì¸ ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [40, 70], 
                    dodge: [30, 45], 
                    luck: [12, 12] 
                }
            },
            // ğŸŒ™ ì—í”½ ë“±ê¸‰ - ì‹œê³µ ì„¸íŠ¸
            { 
                name: 'ì‹œê³µê°„ ë¶€ì¸ ', 
                rarity: 'ì—í”½', 
                price: 42000, 
                type: 'boots',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ìˆœê°„ì´ë™ì´ ê°€ëŠ¥í•œ ì‹ ë¹„í•œ ë¶€ì¸ ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [80, 130], 
                    dodge: [60, 85], 
                    luck: [22, 22] 
                }
            },
            // âœ¨ ë ˆì „ë“œë¦¬ ë“±ê¸‰ - ê°•í™”ì™• ì„¸íŠ¸
            { 
                name: 'ê°•í™”ì™•ì˜ ë¶€ì¸ ', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 175000, 
                type: 'boots',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ì ˆëŒ€ì ì¸ ì†ë„ì™€ íšŒí”¼ë¥¼ ë³´ì¥í•˜ëŠ” ì „ì„¤ì˜ ë¶€ì¸ ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [0, 0], 
                    defense: [160, 260], 
                    dodge: [100, 140], 
                    luck: [38, 38] 
                }
            }
        ]
    },
    accessory: {
        name: 'ì•¡ì„¸ì„œë¦¬',
        emoji: 'ğŸ’',
        gif: 'kim_equipment_acce.gif',
        items: [
            // ğŸŒ¸ ì¼ë°˜ ë“±ê¸‰ - ê½ƒì ì„¸íŠ¸
            { 
                name: 'ê½ƒì ëª©ê±¸ì´', 
                rarity: 'ì¼ë°˜', 
                price: 420, 
                type: 'accessory',
                setName: 'ê½ƒì ì„¸íŠ¸',
                level: 1,
                description: 'í–‰ìš´ì„ ë¶€ë¥´ëŠ” ê½ƒì ëª©ê±¸ì´ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [2, 5], 
                    defense: [2, 5], 
                    dodge: [2, 2], 
                    luck: [8, 12] 
                }
            },
            // â­ ê³ ê¸‰ ë“±ê¸‰ - ë³„ë¹› ì„¸íŠ¸
            { 
                name: 'ë³„ë¹› ë°˜ì§€', 
                rarity: 'ê³ ê¸‰', 
                price: 2100, 
                type: 'accessory',
                setName: 'ë³„ë¹› ì„¸íŠ¸',
                level: 20,
                description: 'ë³„ì˜ ì¶•ë³µì´ ë‹´ê¸´ ì‹ ë¹„í•œ ë°˜ì§€ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [8, 15], 
                    defense: [8, 15], 
                    dodge: [5, 5], 
                    luck: [20, 30] 
                }
            },
            // ğŸ”¥ ë ˆì–´ ë“±ê¸‰ - ë“œë˜ê³¤ ì„¸íŠ¸
            { 
                name: 'ë“œë˜ê³¤ í•˜íŠ¸', 
                rarity: 'ë ˆì–´', 
                price: 10500, 
                type: 'accessory',
                setName: 'ë“œë˜ê³¤ ì„¸íŠ¸',
                level: 40,
                description: 'ë“œë˜ê³¤ì˜ ì‹¬ì¥ì´ ë‹´ê¸´ ê°•ë ¥í•œ ì•¡ì„¸ì„œë¦¬ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [20, 35], 
                    defense: [20, 35], 
                    dodge: [8, 8], 
                    luck: [40, 60] 
                }
            },
            // ğŸŒ™ ì—í”½ ë“±ê¸‰ - ì‹œê³µ ì„¸íŠ¸
            { 
                name: 'ì‹œê³µê°„ í¬ë¦¬ìŠ¤íƒˆ', 
                rarity: 'ì—í”½', 
                price: 48000, 
                type: 'accessory',
                setName: 'ì‹œê³µ ì„¸íŠ¸',
                level: 60,
                description: 'ì‹œê³µê°„ì˜ í˜ì´ ì‘ì¶•ëœ í¬ë¦¬ìŠ¤íƒˆì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [40, 70], 
                    defense: [40, 70], 
                    dodge: [15, 15], 
                    luck: [80, 120] 
                }
            },
            // âœ¨ ë ˆì „ë“œë¦¬ ë“±ê¸‰ - ê°•í™”ì™• ì„¸íŠ¸
            { 
                name: 'ê°•í™”ì™•ì˜ ì¦í‘œ', 
                rarity: 'ë ˆì „ë“œë¦¬', 
                price: 195000, 
                type: 'accessory',
                setName: 'ê°•í™”ì™• ì„¸íŠ¸',
                level: 80,
                description: 'ê°•í™”ì˜ ì ˆëŒ€ìì„ì„ ì¦ëª…í•˜ëŠ” ìµœê³ ì˜ ì•¡ì„¸ì„œë¦¬ì…ë‹ˆë‹¤.',
                stats: { 
                    attack: [80, 140], 
                    defense: [80, 140], 
                    dodge: [25, 25], 
                    luck: [150, 220] 
                }
            }
        ]
    },
    consumable: {
        name: 'ì†Œë¹„',
        emoji: 'ğŸ’Š',
        gif: 'kim_shop_con.gif',
        items: [
            // ì†Œë¹„ ì•„ì´í…œ ì¶”ê°€ ì˜ˆì •
        ]
    },
    enhancement: {
        name: 'ì£¼ë¬¸ì„œ',
        emoji: 'âš’ï¸',
        gif: 'kim_shop_examples.gif',
        items: [
            // ì£¼ë¬¸ì„œ ì•„ì´í…œ ì¶”ê°€ ì˜ˆì •
        ]
    },
    coin: {
        name: 'ì½”ì¸',
        emoji: 'ğŸª™',
        gif: 'kim_shop_coin.gif',
        items: [
            // ì½”ì¸ ì•„ì´í…œ ì¶”ê°€ ì˜ˆì •
        ]
    }
};

// ì˜ë¢° ì‹œìŠ¤í…œ ë°ì´í„°
const QUEST_CLIENTS = {
    // ğŸ’° ì˜ë¢°ì£¼í™”ë¥¼ ì–»ëŠ” ì˜ë¢° (20ê°€ì§€)
    villagers: [
        {
            id: 1,
            name: 'ë§ˆì„ ì£¼ë¯¼ ê¹€ë´‰ìˆœ',
            type: 'reward',
            title: 'ê³ ì–‘ì´ êµ¬ì¶œ ì‘ì „',
            description: 'ì•„, ë‹¹ì‹ ! í˜¹ì‹œ ì‹œê°„ ìˆìœ¼ì„¸ìš”? ìš°ë¦¬ ì§‘ ê³ ì–‘ì´ê°€ ë˜ ë‚˜ë¬´ì— ì˜¬ë¼ê°€ì„œ ë‚´ë ¤ì˜¤ì§ˆ ëª»í•˜ê³  ìˆì–´ìš”. ë„ì™€ì£¼ì‹œë©´ ì‘ì€ ë³´ë‹µì„ ë“œë¦´ê²Œìš”!',
            emoji: 'ğŸ±'
        },
        {
            id: 2,
            name: 'ë§ˆì„ ì£¼ë¯¼ ë°•ì² ìˆ˜',
            type: 'reward',
            title: 'ìš°ë¬¼ ì†ŒìŒ ì¡°ì‚¬',
            description: 'ì–´ë¨¸, ëª¨í—˜ê°€ë‹˜! ë§ˆì¹¨ ì˜ ì˜¤ì…¨ë„¤ìš”. ë§ˆì„ ìš°ë¬¼ì—ì„œ ì´ìƒí•œ ì†Œë¦¬ê°€ ë‚˜ëŠ”ë°... í˜¹ì‹œ í•œ ë²ˆ ë´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ë¬¼ë¡  ìˆ˜ê³ ë¹„ëŠ” ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸº'
        },
        {
            id: 3,
            name: 'ë§ˆì„ ì£¼ë¯¼ ì´ì˜í¬',
            type: 'reward',
            title: 'í• ë¨¸ë‹ˆì˜ ì•½ì´ˆ ìˆ˜ì§‘',
            description: 'ì €ê¸°ìš”, ëª¨í—˜ê°€ë‹˜! ìš°ë¦¬ í• ë¨¸ë‹ˆê°€ ì•½ì´ˆë¥¼ êµ¬í•´ë‹¬ë¼ê³  í•˜ì‹œëŠ”ë°... ë§ˆì„ ê·¼ì²˜ì—ì„œ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆëŠ” ê±°ë¼ê³  í•˜ë„¤ìš”. ë¶€íƒë“œë ¤ë„ ë ê¹Œìš”?',
            emoji: 'ğŸŒ¿'
        },
        {
            id: 4,
            name: 'ë§ˆì„ ì£¼ë¯¼ ìµœë¯¼ìˆ˜',
            type: 'reward',
            title: 'ì°½ê³  ì¥ í‡´ì¹˜',
            description: 'ì•„! ë‹¹ì‹ ì´ ê·¸ ìœ ëª…í•œ ëª¨í—˜ê°€êµ°ìš”! ìš°ë¦¬ ë§ˆì„ ì°½ê³ ì— ì¥ë“¤ì´ ë„ˆë¬´ ë§ì•„ì¡Œì–´ìš”. ì¢€ ì«“ì•„ë‚´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ê°ì‚¬ì˜ ë§ˆìŒì„ ë‹´ì•„ ë³´ìƒì„ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸ­'
        },
        {
            id: 5,
            name: 'ë§ˆì„ ì£¼ë¯¼ ì •ìˆ˜ì—°',
            type: 'reward',
            title: 'ë§ˆì„ ê°„íŒ ë³µêµ¬',
            description: 'ëª¨í—˜ê°€ë‹˜, ì ê¹ë§Œìš”! ë§ˆì„ ì…êµ¬ ê°„íŒì´ ë°”ëŒì— ë„˜ì–´ì¡ŒëŠ”ë° í˜¼ìì„œëŠ” ë‹¤ì‹œ ì„¸ìš°ê¸° í˜ë“¤ì–´ìš”. ë„ì™€ì£¼ì‹œë©´ ê³ ë§™ê² ì–´ìš”!',
            emoji: 'ğŸ“‹'
        },
        {
            id: 6,
            name: 'ë§ˆì„ ì£¼ë¯¼ ê°•ì§€í›ˆ',
            type: 'reward',
            title: 'í¸ì§€ ì „ë‹¬ ë¶€íƒ',
            description: 'ì–´ë¼, ëª¨í—˜ê°€ë‹˜! ë§ˆì¹¨ ì˜ ë§Œë‚¬ë„¤ìš”. ì´ì›ƒì§‘ì— í¸ì§€ ì¢€ ì „í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ë‹¤ë¦¬ê°€ ì•„íŒŒì„œ ì§ì ‘ ê°€ê¸°ê°€ í˜ë“¤ì–´ì„œìš”...',
            emoji: 'ğŸ’Œ'
        },
        {
            id: 7,
            name: 'ë§ˆì„ ì£¼ë¯¼ ìœ¤ë¯¸ë‚˜',
            type: 'reward',
            title: 'ê´‘ì¥ ì²­ì†Œ ë„ì›€',
            description: 'ì €ê¸°, í˜¹ì‹œ ë°”ì˜ì§€ ì•Šìœ¼ì‹œë‹¤ë©´... ë§ˆì„ ê´‘ì¥ì— ë–¨ì–´ì§„ ë‚™ì—½ë“¤ì„ ì¢€ ì¹˜ì›Œì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ë§ˆì„ ì¶•ì œ ì¤€ë¹„ ë•Œë¬¸ì— ê¸‰í•´ì„œìš”.',
            emoji: 'ğŸ‚'
        },
        {
            id: 8,
            name: 'ë§ˆì„ ì£¼ë¯¼ ì„í˜„ìš°',
            type: 'reward',
            title: 'ì§€ë¶• ìœ„ ê³µ íšŒìˆ˜',
            description: 'ëª¨í—˜ê°€ë‹˜! ìš°ë¦¬ ì•„ì´ê°€ ê³µì„ ì§€ë¶• ìœ„ì— ì˜¬ë ¤ë²„ë ¸ì–´ìš”. ì‚¬ë‹¤ë¦¬ê°€ ìˆê¸´ í•œë° í˜¼ìì„œëŠ” ìœ„í—˜í•´ì„œ... ë„ì™€ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”?',
            emoji: 'âš½'
        },
        {
            id: 9,
            name: 'ë§ˆì„ ì£¼ë¯¼ ì†¡ë‹¤ì€',
            type: 'reward',
            title: 'ë©§ë¼ì§€ í‡´ì¹˜',
            description: 'ì•„, ë‹¹ì‹ ! ë§ˆì„ ë’¤í¸ í…ƒë°­ì— ë©§ë¼ì§€ê°€ ë‚˜íƒ€ë‚˜ì„œ ë†ì‘ë¬¼ì„ ë§ê°€ëœ¨ë¦¬ê³  ìˆì–´ìš”. ì«“ì•„ë‚´ ì£¼ì‹œë©´ ì •ë§ ê°ì‚¬í•˜ê² ì–´ìš”!',
            emoji: 'ğŸ—'
        },
        {
            id: 10,
            name: 'ë§ˆì„ ì£¼ë¯¼ í•œì§€ìš°',
            type: 'reward',
            title: 'ìš°ë¬¼ ì´ë¬¼ì§ˆ ì œê±°',
            description: 'ëª¨í—˜ê°€ë‹˜, ì ì‹œë§Œìš”! ë§ˆì„ ìš°ë¬¼ë¬¼ì´ íƒí•´ì¡ŒëŠ”ë° ë°‘ì— ë­”ê°€ ë–¨ì–´ì§„ ê²ƒ ê°™ì•„ìš”. ê±´ì ¸ë‚´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ë³´ìƒì€ ë‹¹ì—°íˆ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸª£'
        }
    ],
    merchants: [
        {
            id: 11,
            name: 'ì¡í™”ìƒ ëˆë³µì´',
            type: 'reward',
            title: 'ì°½ê³  ì •ë¦¬ ì•Œë°”',
            description: 'ì–´ì–´, ëª¨í—˜ê°€ë‹˜! ë§ˆì¹¨ ì˜ ì˜¤ì…¨ì–´ìš”. ì œê°€ ë¬¼ê±´ì„ ë„ˆë¬´ ë§ì´ ì£¼ë¬¸í•´ì„œ ì°½ê³ ê°€ ê½‰ ì°¼ì–´ìš”. ì •ë¦¬ ì¢€ ë„ì™€ì£¼ì‹œë©´ ìˆ˜ê³ ë¹„ë¥¼ ë“œë¦´ê²Œìš”!',
            emoji: 'ğŸ“¦'
        },
        {
            id: 12,
            name: 'ì¡í™”ìƒ ì¥ì‚¬ê¾¼',
            type: 'reward',
            title: 'ê°„íŒ ì²­ì†Œ ì‘ì—…',
            description: 'ì˜¤, ëª¨í—˜ê°€ë‹˜! í˜¹ì‹œ ì‹œê°„ ë˜ì‹œë©´ ì œ ê°€ê²Œ ê°„íŒ ì¢€ ë‹¦ì•„ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ë†’ì€ ê³³ì´ë¼ ì œê°€ í•˜ê¸°ì—” ìœ„í—˜í•´ì„œìš”. ë¬¼ë¡  í’ˆì‚¯ì€ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸª§'
        },
        {
            id: 13,
            name: 'ì¡í™”ìƒ ì‹¬ìˆ ë§¨',
            type: 'reward',
            title: 'ì•¼ê°„ ê²½ë¹„ ì—…ë¬´',
            description: 'ì•„! ë‹¹ì‹ ì´ ê·¸ ì‹¤ë ¥ìêµ°ìš”! ì œ ìƒì ì— ë„ë‘‘ì´ ë“¤ì–´ì˜¬ê¹Œ ë´ ê±±ì •ì¸ë°... ì˜¤ëŠ˜ ë°¤ í•œ ë²ˆë§Œ ì§€ì¼œë´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ì‚¬ë¡€ëŠ” ì¶©ë¶„íˆ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸŒ™'
        },
        {
            id: 14,
            name: 'ì¡í™”ìƒ íƒë°°ì™•',
            type: 'reward',
            title: 'ë¬¼ê±´ ë°°ë‹¬ ì„œë¹„ìŠ¤',
            description: 'ëª¨í—˜ê°€ë‹˜, ì ê¹ë§Œìš”! ë‹¤ë¥¸ ë§ˆì„ì—ì„œ ì£¼ë¬¸í•œ ë¬¼ê±´ì´ ìˆëŠ”ë° ì§ì ‘ ë°°ë‹¬í•´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ì €ëŠ” ê°€ê²Œë¥¼ ë¹„ìš¸ ìˆ˜ê°€ ì—†ì–´ì„œìš”.',
            emoji: 'ğŸ“®'
        },
        {
            id: 15,
            name: 'ì¡í™”ìƒ ì½”ë§‰í˜',
            type: 'reward',
            title: 'ì§€í•˜ì°½ê³  ëƒ„ìƒˆ ì¡°ì‚¬',
            description: 'ì–´ë¨¸, ëª¨í—˜ê°€ë‹˜! ì œ ê°€ê²Œ ì§€í•˜ì°½ê³ ì— ì´ìƒí•œ ëƒ„ìƒˆê°€ ë‚˜ëŠ”ë°... í˜¹ì‹œ í•œ ë²ˆ í™•ì¸í•´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ë­”ê°€ ì©ì€ ê²ƒ ê°™ì•„ì„œ ê±±ì •ì´ì—ìš”.',
            emoji: 'ğŸ¤¢'
        },
        {
            id: 16,
            name: 'ì¡í™”ìƒ ê²ìŸì´',
            type: 'reward',
            title: 'ë¬¼ê±´ ìˆ˜ì†¡ í˜¸ìœ„',
            description: 'ì˜¤, ì˜ ì˜¤ì…¨ì–´ìš”! ì œê°€ íŒ” ë¬¼ê±´ë“¤ì„ ë‹¤ë¥¸ ë§ˆì„ì—ì„œ ê°€ì ¸ì™€ì•¼ í•˜ëŠ”ë° ê¸¸ì´ ìœ„í—˜í•´ì„œìš”. í˜¸ìœ„í•´ ì£¼ì‹œë©´ ë„‰ë„‰íˆ ë³´ìƒí•´ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸ›¡ï¸'
        },
        {
            id: 17,
            name: 'ì¡í™”ìƒ ì •ë³´í†µ',
            type: 'reward',
            title: 'íŠ¹ë³„ ì£¼ë¬¸ ìˆ˜ì§‘',
            description: 'ëª¨í—˜ê°€ë‹˜! ë§ˆì¹¨ ì¢‹ì€ íƒ€ì´ë°ì´ë„¤ìš”. ì œ ë‹¨ê³¨ì†ë‹˜ì´ íŠ¹ë³„í•œ ë¬¼ê±´ì„ ì°¾ê³  ìˆëŠ”ë° êµ¬í•´ë‹¤ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ìˆ˜ìˆ˜ë£ŒëŠ” ì¶©ë¶„íˆ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸ”'
        },
        {
            id: 18,
            name: 'ì¡í™”ìƒ ìŠ¤íŒŒì´',
            type: 'reward',
            title: 'ê²½ìŸì—…ì²´ ì •ì°°',
            description: 'ì–´ë¼, ëª¨í—˜ê°€ë‹˜! ì œ ê²½ìŸì—…ì²´ê°€ ìê¾¸ ì œ ì†ë‹˜ë“¤ì„ ë¹¼ì•—ì•„ ê°€ëŠ”ë°... ê·¸ìª½ ê°€ê²©ì´ë‚˜ ì•Œì•„ë´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? ì •ë³´ë¹„ëŠ” ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸ•µï¸'
        },
        {
            id: 19,
            name: 'ì¡í™”ìƒ êµ´ì°©ë§¨',
            type: 'reward',
            title: 'ë¯¸ìŠ¤í„°ë¦¬ êµ¬ë© ì¡°ì‚¬',
            description: 'ì•„, ë‹¹ì‹ ! ì œ ê°€ê²Œ ë’¤í¸ì— ì´ìƒí•œ êµ¬ë©ì´ ìƒê²¼ëŠ”ë° ë­”ì§€ í™•ì¸í•´ ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? í˜¹ì‹œ ì§€í•˜ì— ë­”ê°€ ìˆì„ì§€ë„ ëª°ë¼ì„œìš”.',
            emoji: 'ğŸ•³ï¸'
        },
        {
            id: 20,
            name: 'ì¡í™”ìƒ ì†ë†ˆì´',
            type: 'reward',
            title: 'ì—´ì‡  ì°¾ê¸° ëŒ€ì‘ì „',
            description: 'ëª¨í—˜ê°€ë‹˜, ë¶€íƒì´ ìˆì–´ìš”! ì œê°€ ì‹¤ìˆ˜ë¡œ ì¤‘ìš”í•œ ì—´ì‡ ë¥¼ ì—°ëª»ì— ë¹ ëœ¨ë ¸ëŠ”ë°... ì°¾ì•„ì£¼ì‹œë©´ ì •ë§ ê°ì‚¬í•˜ê² ì–´ìš”. ë³´ìƒì€ í™•ì‹¤íˆ ë“œë¦´ê²Œìš”!',
            emoji: 'ğŸ—ï¸'
        }
    ],
    scammers: [
        {
            id: 21,
            name: 'ìˆ˜ìƒí•œìƒì¸ ì•½ì¥ìˆ˜',
            type: 'scam',
            title: 'íŠ¹ë³„ ë¬¼ì•½ ì‹œìŒíšŒ',
            description: 'ì˜¤ì˜¤, ëª¨í—˜ê°€ë‹˜! íŠ¹ë³„í•œ ê¸°íšŒë¥¼ ë“œë¦´ê²Œìš”! ì´ ë§ˆë²• ë¬¼ì•½ì„ ë¯¸ë¦¬ ë§›ë³´ê¸°ë¡œ ë“œì‹œë©´ íš¨ê³¼ë¥¼ ë³´ì¥í•´ ë“œë ¤ìš”. ë‹¨ëˆ 3ë§Œ ê³¨ë“œë©´ ë˜ê³ ìš”... ì–´ë– ì„¸ìš”?',
            emoji: 'ğŸ§ª',
            scamAmount: 30000
        },
        {
            id: 22,
            name: 'ìˆ˜ìƒí•œìƒì¸ ì •ë³´ê¾¼',
            type: 'scam',
            title: 'ë³´ë¬¼ ìœ„ì¹˜ ì •ë³´ íŒë§¤',
            description: 'ì–´ì–´, ì‹¤ë ¥ìì‹œë„¤ìš”! ì œê°€ íŠ¹ë³„í•œ ì •ë³´ë¥¼ í•˜ë‚˜ ì•Œê³  ìˆëŠ”ë°... ê·¼ì²˜ ë™êµ´ì— ë³´ë¬¼ì´ ìˆ¨ê²¨ì ¸ ìˆì–´ìš”. ìœ„ì¹˜ë¥¼ ì•Œë ¤ë“œë¦´ í…Œë‹ˆ 2ë§Œ ê³¨ë“œë§Œ ì£¼ì„¸ìš”!',
            emoji: 'ğŸ—ºï¸',
            scamAmount: 20000
        },
        {
            id: 23,
            name: 'ìˆ˜ìƒí•œìƒì¸ ë§ˆë²•ì‚¬',
            type: 'scam',
            title: 'í–‰ìš´ì˜ ë§ˆë²• ë°˜ì§€',
            description: 'ëª¨í—˜ê°€ë‹˜! ì´ ë°˜ì§€ ë³´ì„¸ìš”. ë§ˆë²•ì´ ê±¸ë ¤ìˆì–´ì„œ ìš´ì´ ì—„ì²­ ì¢‹ì•„ì§„ë‹¤ê³  í•´ìš”! ì›ë˜ 10ë§Œ ê³¨ë“œì¸ë° ë‹¹ì‹ ì—ê²Œë§Œ íŠ¹ê°€ 4ë§Œ ê³¨ë“œì— ë“œë¦´ê²Œìš”!',
            emoji: 'ğŸ’',
            scamAmount: 40000
        },
        {
            id: 24,
            name: 'ìˆ˜ìƒí•œìƒì¸ ë¹šìŸì´',
            type: 'scam',
            title: 'ê¸‰í•œ ëˆ ëŒ€ì—¬ ë¶€íƒ',
            description: 'ì•„, ë‹¹ì‹ ! í˜¹ì‹œ ì—¬ê¸° ê·¼ì²˜ì—ì„œ ìˆ˜ìƒí•œ ë†ˆë“¤ì„ ë³¸ ì  ìˆë‚˜ìš”? ì œê°€ ë¬¼ì–´ë³´ëŠ” ì´ìœ ê°€... ì•„ë‹ˆ, ì¼ë‹¨ 5ë§Œ ê³¨ë“œë¶€í„° ë¹Œë ¤ì£¼ì‹œë©´ ì„¤ëª…í•´ ë“œë¦´ê²Œìš”.',
            emoji: 'ğŸ’¸',
            scamAmount: 50000
        },
        {
            id: 25,
            name: 'ìˆ˜ìƒí•œìƒì¸ ì‚¬ê¸°ê¾¼',
            type: 'scam',
            title: 'ì¹œêµ¬ ì‘ê¸‰ ì¹˜ë£Œë¹„',
            description: 'ëª¨í—˜ê°€ë‹˜, ê¸´ê¸‰ìƒí™©ì´ì—ìš”! ì œ ì¹œêµ¬ê°€ ë‹¤ë¥¸ ë§ˆì„ì—ì„œ ì‚¬ê³ ë¥¼ ë‹¹í–ˆëŠ”ë° ì¹˜ë£Œë¹„ê°€ í•„ìš”í•´ìš”. 1ë§Œ ê³¨ë“œë§Œ ë¹Œë ¤ì£¼ì‹œë©´ ë‚´ì¼ ë‘ ë°°ë¡œ ê°šì„ê²Œìš”!',
            emoji: 'ğŸš‘',
            scamAmount: 10000
        },
        {
            id: 26,
            name: 'ìˆ˜ìƒí•œìƒì¸ ë³´ê´€ê¾¼',
            type: 'scam',
            title: 'ê·€ì¤‘í’ˆ ë³´ê´€ ì„œë¹„ìŠ¤',
            description: 'ì–´ë¨¸, ëª¨í—˜ê°€ë‹˜! ì œê°€ ê·€ì¤‘í•œ ë¬¼ê±´ì„ ë§¡ì•„ë“œë¦´ê²Œìš”. ë³´ê´€ë£Œë¡œ 3ë§Œ ê³¨ë“œë§Œ ì£¼ì‹œë©´... ì•„, ë¯¸ì•ˆí•´ìš”! ì§€ê¸ˆ ê¸‰í•œ ì¼ì´ ìƒê²¨ì„œ ê°€ë´ì•¼ê² ì–´ìš”!',
            emoji: 'ğŸƒ',
            scamAmount: 30000
        }
    ],
    travelers: [
        {
            id: 27,
            name: 'ìˆ˜ìƒí•œì—¬í–‰ì ë„ë°•ê¾¼',
            type: 'scam',
            title: 'íŠ¹ë³„í•œ ì£¼ì‚¬ìœ„ ê²Œì„',
            description: 'ì €ê¸°ìš”! í˜¹ì‹œ ë„ë°• í•œ íŒ ì–´ë– ì„¸ìš”? ì´ ì£¼ì‚¬ìœ„ëŠ” íŠ¹ë³„í•´ì„œ ê±°ì˜ ì´ê¸¸ ìˆ˜ ìˆì–´ìš”! íŒëˆ 2ë§Œ ê³¨ë“œë§Œ ê±¸ì–´ë³´ì‹œë©´... ë¶„ëª… ì¬ë¯¸ìˆì„ ê±°ì˜ˆìš”!',
            emoji: 'ğŸ²',
            scamAmount: 20000
        },
        {
            id: 28,
            name: 'ìˆ˜ìƒí•œì—¬í–‰ì ëª¨í—˜ê°€',
            type: 'scam',
            title: 'ë³´ë¬¼ì°¾ê¸° ë™ì—… ì œì•ˆ',
            description: 'ëª¨í—˜ê°€ë‹˜! ì €ì™€ í•¨ê»˜ ë³´ë¬¼ì°¾ê¸°ë¥¼ í•˜ì‹œê² ì–´ìš”? ì§€ë„ë„ ìˆê³  ì¥ë¹„ë„ ì¤€ë¹„í–ˆëŠ”ë°... ì°¸ê°€ë¹„ë¡œ 4ë§Œ ê³¨ë“œë§Œ ë‚´ì‹œë©´ ì ˆë°˜ì”© ë‚˜ëˆ ê°€ì ¸ìš”!',
            emoji: 'ğŸ´â€â˜ ï¸',
            scamAmount: 40000
        },
        {
            id: 29,
            name: 'ìˆ˜ìƒí•œì—¬í–‰ì í”¼í•´ì',
            type: 'scam',
            title: 'ê·€ì¤‘í’ˆ ìˆ˜ìƒ‰ ì˜ë¢°',
            description: 'ì•„! ë‹¹ì‹  ê°™ì€ ì‹¤ë ¥ìë¥¼ ì°¾ê³  ìˆì—ˆì–´ìš”! ì œê°€ ëª¬ìŠ¤í„°ì—ê²Œ ìŠµê²©ë‹¹í•´ì„œ ê·€ì¤‘í’ˆì„ ëºê²¼ëŠ”ë°... ì°¾ì•„ì£¼ì‹œë©´ 5ë§Œ ê³¨ë“œë¥¼ ë“œë¦´ê²Œìš”. ë‹¨, ìˆ˜ìƒ‰ë¹„ë¡œ 1ë§Œ ê³¨ë“œê°€ í•„ìš”í•´ìš”.',
            emoji: 'ğŸ‘¹',
            scamAmount: 10000
        },
        {
            id: 30,
            name: 'ìˆ˜ìƒí•œì—¬í–‰ì ê±°ì§€',
            type: 'scam',
            title: 'ê°•ë„ í”¼í•´ ë„ì›€ ìš”ì²­',
            description: 'ëª¨í—˜ê°€ë‹˜, ê¸‰í•´ìš”! ì œê°€ ë§ˆì„ ì…êµ¬ì—ì„œ ê°•ë„ë¥¼ ë‹¹í–ˆëŠ”ë° ì§€ê°‘ì„ ë‹¤ í„¸ë ¸ì–´ìš”. ìˆ™ë°•ë¹„ 1ë§Œ5ì²œ ê³¨ë“œë§Œ ë¹Œë ¤ì£¼ì‹œë©´ ê³ í–¥ì— ê°€ì„œ ê¼­ ê°šì„ê²Œìš”!',
            emoji: 'ğŸ¥º',
            scamAmount: 15000
        }
    ]
};

// ì˜ë¢° ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
function getRandomQuest() {
    const allClients = [
        ...QUEST_CLIENTS.villagers,
        ...QUEST_CLIENTS.merchants,
        ...QUEST_CLIENTS.scammers,
        ...QUEST_CLIENTS.travelers
    ];
    return allClients[Math.floor(Math.random() * allClients.length)];
}

function calculateQuestReward(userLevel, questType) {
    if (questType === 'scam') {
        return null; // ì‚¬ê¸° ì˜ë¢°ëŠ” ë³´ìƒ ì—†ìŒ
    }
    
    // ë ˆë²¨ì— ë¹„ë¡€í•œ ë³´ìƒ (100ë ˆë²¨ì„ ê¸°ì¤€ìœ¼ë¡œ 100~1000 ê³¨ë“œ)
    const baseReward = Math.floor(Math.random() * 900) + 100; // 100~1000 ê³¨ë“œ
    const levelMultiplier = userLevel / 100; // ë ˆë²¨ ë°°ìœ¨
    const finalReward = Math.floor(baseReward * (0.5 + levelMultiplier)); // ìµœì†Œ 50% ë³´ì¥
    
    return {
        gold: finalReward,
        exp: Math.floor(finalReward / 10) // ê³¨ë“œì˜ 10% ê²½í—˜ì¹˜
    };
}

function addQuestCooldown(userId) {
    if (!global.questCooldowns) {
        global.questCooldowns = new Map();
    }
    global.questCooldowns.set(userId, Date.now() + (30 * 60 * 1000)); // 30ë¶„ ì¿¨íƒ€ì„
}

function checkQuestCooldown(userId) {
    if (!global.questCooldowns) {
        global.questCooldowns = new Map();
    }
    const cooldownEnd = global.questCooldowns.get(userId);
    if (!cooldownEnd) return false;
    
    const timeLeft = cooldownEnd - Date.now();
    return timeLeft > 0 ? Math.ceil(timeLeft / (60 * 1000)) : false; // ë‚¨ì€ ë¶„ ìˆ˜ ë°˜í™˜
}

// ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ë°ì´í„°
const EMBLEMS = {
    warrior: {
        name: 'ì „ì‚¬',
        emoji: 'âš”ï¸',
        emblems: [
            { name: 'ì´ˆë³´ì „ì‚¬', price: 10000, level: 20, roleName: 'ì´ˆë³´ì „ì‚¬' },
            { name: 'íŠ¼íŠ¼í•œ ê¸°ì‚¬', price: 50000, level: 35, roleName: 'íŠ¼íŠ¼í•œ ê¸°ì‚¬' },
            { name: 'ìš©ë§¹í•œ ê²€ì‚¬', price: 150000, level: 50, roleName: 'ìš©ë§¹í•œ ê²€ì‚¬' },
            { name: 'ë§¹ë ¹í•œ ì „ì‚¬', price: 400000, level: 65, roleName: 'ë§¹ë ¹í•œ ì „ì‚¬' },
            { name: 'ì „ì„¤ì˜ ê¸°ì‚¬', price: 1000000, level: 80, roleName: 'ì „ì„¤ì˜ ê¸°ì‚¬' }
        ]
    },
    archer: {
        name: 'ê¶ìˆ˜',
        emoji: 'ğŸ¹',
        emblems: [
            { name: 'ë§ˆì„ì‚¬ëƒ¥ê¾¼', price: 10000, level: 20, roleName: 'ë§ˆì„ì‚¬ëƒ¥ê¾¼' },
            { name: 'ìˆ²ì˜ ê¶ìˆ˜', price: 50000, level: 35, roleName: 'ìˆ²ì˜ ê¶ìˆ˜' },
            { name: 'ë°”ëŒ ì‚¬ìˆ˜', price: 150000, level: 50, roleName: 'ë°”ëŒ ì‚¬ìˆ˜' },
            { name: 'ì •í™•í•œ ì‚¬ê²©ìˆ˜', price: 400000, level: 65, roleName: 'ì •í™•í•œ ì‚¬ê²©ìˆ˜' },
            { name: 'ì „ì„¤ì˜ ëª…ê¶', price: 1000000, level: 80, roleName: 'ì „ì„¤ì˜ ëª…ê¶' }
        ]
    },
    spellsword: {
        name: 'ë§ˆê²€ì‚¬',
        emoji: 'ğŸ”®',
        emblems: [
            { name: 'ë§ˆë²• í•™ë„', price: 10000, level: 20, roleName: 'ë§ˆë²• í•™ë„' },
            { name: 'ë§ˆë²• ê²€ì‚¬', price: 50000, level: 35, roleName: 'ë§ˆë²• ê²€ì‚¬' },
            { name: 'í˜„ëª…í•œ ê¸°ì‚¬', price: 150000, level: 50, roleName: 'í˜„ëª…í•œ ê¸°ì‚¬' },
            { name: 'ë§ˆë„ ê²€ì‚¬', price: 400000, level: 65, roleName: 'ë§ˆë„ ê²€ì‚¬' },
            { name: 'ì „ì„¤ì˜ ë§ˆê²€ì‚¬', price: 1000000, level: 80, roleName: 'ì „ì„¤ì˜ ë§ˆê²€ì‚¬' }
        ]
    },
    rogue: {
        name: 'ë„ì ',
        emoji: 'ğŸ—¡ï¸',
        emblems: [
            { name: 'ë– ëŒì´ ë„ì ', price: 10000, level: 20, roleName: 'ë– ëŒì´ ë„ì ' },
            { name: 'ìš´ ì¢‹ì€ ë„ë‘‘', price: 50000, level: 35, roleName: 'ìš´ ì¢‹ì€ ë„ë‘‘' },
            { name: 'í–‰ìš´ì˜ ë‹Œì', price: 150000, level: 50, roleName: 'í–‰ìš´ì˜ ë‹Œì' },
            { name: 'ë³µ ë§ì€ ë„ì ', price: 400000, level: 65, roleName: 'ë³µ ë§ì€ ë„ì ' },
            { name: 'ì „ì„¤ì˜ í–‰ìš´ì•„', price: 1000000, level: 80, roleName: 'ì „ì„¤ì˜ í–‰ìš´ì•„' }
        ]
    }
};

// ì— ë¸”ëŸ¼ ì±„ë„ ID
const EMBLEM_CHANNEL_ID = '1381614153399140412';

// ìœ ì € ì¹­í˜¸ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getUserTitle(user) {
    if (user.emblem) {
        return user.emblem; // ì— ë¸”ëŸ¼ì´ ìˆìœ¼ë©´ ì— ë¸”ëŸ¼ì„ ì¹­í˜¸ë¡œ ì‚¬ìš©
    }
    return 'ëª¨í—˜ê°€'; // ì— ë¸”ëŸ¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì¹­í˜¸
}

// ì¥ë¹„ ì¹´í…Œê³ ë¦¬ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCategoryName(category) {
    const names = {
        weapon: 'ë¬´ê¸°',
        armor: 'ê°‘ì˜·',
        helmet: 'í—¬ë©§',
        gloves: 'ì¥ê°‘',
        boots: 'ë¶€ì¸ ',
        accessory: 'ì•¡ì„¸ì„œë¦¬'
    };
    return names[category] || category;
}

// ì¥ë¹„ ì¹´í…Œê³ ë¦¬ ì´ëª¨ì§€ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
function getCategoryEmoji(category) {
    const emojis = {
        weapon: 'âš”ï¸',
        armor: 'ğŸ›¡ï¸',
        helmet: 'â›‘ï¸',
        gloves: 'ğŸ§¤',
        boots: 'ğŸ‘¢',
        accessory: 'ğŸ’'
    };
    return emojis[category] || 'âš™ï¸';
}

// ë´‡ ì„¤ì •
const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent,
        GatewayIntentBits.GuildMessageReactions
    ]
});

// ë´‡ í† í° (í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì§ì ‘ ì…ë ¥)
const TOKEN = process.env.BOT_TOKEN || 'YOUR_BOT_TOKEN_HERE';
const CLIENT_ID = process.env.CLIENT_ID || 'YOUR_CLIENT_ID_HERE';
const DEV_CHANNEL_IDS = process.env.DEV_CHANNEL_IDS ? process.env.DEV_CHANNEL_IDS.split(',').map(id => id.trim()) : [];
const GAME_CHANNEL_ID = process.env.GAME_CHANNEL_ID;
const DEV_MODE = process.env.DEV_MODE === 'true';
const DEVELOPER_ID = process.env.DEVELOPER_ID;
const POPULAR_KING_ROLE_NAME = 'ğŸ‘‘ ì¸ê¸°ì™•';

// ê°œë°œì ì²´í¬ í•¨ìˆ˜
function isDeveloper(userId) {
    return DEVELOPER_ID && userId === DEVELOPER_ID;
}

// ê²½í—˜ì¹˜ ë°” ìƒì„± í•¨ìˆ˜
function generateExpBar(currentExp, maxExp, barLength = 20) {
    const percentage = Math.min(currentExp / maxExp, 1);
    const filledLength = Math.floor(percentage * barLength);
    const emptyLength = barLength - filledLength;
    
    const filledChar = 'â–ˆ';
    const emptyChar = 'â–‘';
    
    const bar = 'â–ˆ'.repeat(filledLength) + 'â–‘'.repeat(emptyLength);
    const percentText = (percentage * 100).toFixed(1);
    
    return `â”” \`${bar}\` ${percentText}%`;
}

// ëœë¤ ì•„ì´í…œ ëŠ¥ë ¥ì¹˜ ìƒì„± í•¨ìˆ˜
function generateRandomStats(statRanges) {
    const randomStats = {};
    for (const [statName, range] of Object.entries(statRanges)) {
        if (range[0] === range[1]) {
            // ê³ ì •ê°’ì¸ ê²½ìš°
            randomStats[statName] = range[0];
        } else {
            // ë²”ìœ„ì—ì„œ ëœë¤ ìƒì„±
            randomStats[statName] = Math.floor(Math.random() * (range[1] - range[0] + 1)) + range[0];
        }
    }
    return randomStats;
}

// ë©”ì´í”ŒìŠ¤í† ë¦¬ ì •í™•í•œ ìŠ¤íƒ€í¬ìŠ¤ ê°•í™” í™•ë¥ í‘œ (0-30ì„±)
const STARFORCE_RATES = {
    0: { success: 95, fail: 5, destroy: 0 },
    1: { success: 90, fail: 10, destroy: 0 },
    2: { success: 85, fail: 15, destroy: 0 },
    3: { success: 85, fail: 15, destroy: 0 },
    4: { success: 80, fail: 20, destroy: 0 },
    5: { success: 75, fail: 25, destroy: 0 },
    6: { success: 70, fail: 30, destroy: 0 },
    7: { success: 65, fail: 35, destroy: 0 },
    8: { success: 60, fail: 40, destroy: 0 },
    9: { success: 55, fail: 45, destroy: 0 },
    10: { success: 50, fail: 50, destroy: 0 },
    11: { success: 45, fail: 55, destroy: 0 },
    12: { success: 40, fail: 60, destroy: 0 },
    13: { success: 35, fail: 65, destroy: 0 },
    14: { success: 30, fail: 70, destroy: 0 },
    15: { success: 30, fail: 67.9, destroy: 2.1 },
    16: { success: 30, fail: 67.9, destroy: 2.1 },
    17: { success: 15, fail: 78.2, destroy: 6.8 },
    18: { success: 15, fail: 78.2, destroy: 6.8 },
    19: { success: 15, fail: 76.5, destroy: 8.5 },
    20: { success: 30, fail: 59.5, destroy: 10.5 },
    21: { success: 15, fail: 72.25, destroy: 12.75 },
    22: { success: 15, fail: 68, destroy: 17 },
    23: { success: 10, fail: 72, destroy: 18 },
    24: { success: 10, fail: 72, destroy: 18 },
    25: { success: 10, fail: 72, destroy: 18 },
    26: { success: 7, fail: 74.4, destroy: 18.6 },
    27: { success: 5, fail: 76, destroy: 19 },
    28: { success: 3, fail: 77.6, destroy: 19.4 },
    29: { success: 1, fail: 79.2, destroy: 19.8 },
    30: { success: 0, fail: 0, destroy: 0 } // 30ì„±ì€ ìµœëŒ€
};

// ë©”ì´í”ŒìŠ¤í† ë¦¬ ì •í™•í•œ ê°•í™” ë¹„ìš© ê³„ìˆ˜í‘œ
const COST_COEFFICIENTS = {
    0: 36, 1: 36, 2: 36, 3: 36, 4: 36, 5: 36, 6: 36, 7: 36, 8: 36, 9: 36, 10: 36,
    11: 571, 12: 314, 13: 157, 14: 107, 15: 200, 16: 200, 17: 150, 18: 70, 19: 45,
    20: 200, 21: 125, 22: 200, 23: 200, 24: 200, 25: 200, 26: 200, 27: 200, 28: 200, 29: 200
};

// ì•„ì´í…œ ë ˆë²¨ë³„ ì„¤ì • (ëª¨ë“  ìƒì  ì•„ì´í…œ í¬í•¨)
const ITEM_LEVELS = {
    'ê¸°ë³¸ ê²€': 1,
    'ê¸°ë³¸ ê°‘ì˜·': 1,
    'ì²´ë ¥ í¬ì…˜': 1,
    'ë§ˆë‚˜ í¬ì…˜': 1,
    'ê°•ì²  ê²€': 10,
    'ê½ƒì ì„¸íŠ¸': 1,
    'ë³„ë¹› ì„¸íŠ¸': 20,
    'ë“œë˜ê³¤ ì„¸íŠ¸': 40,
    'ì‹œê³µ ì„¸íŠ¸': 60,
    'ê°•í™”ì™• ì„¸íŠ¸': 80
};

// ê°•í™” ë¹„ìš© ê³„ì‚° í•¨ìˆ˜ (Discord ë´‡ì— ë§ê²Œ ì¡°ì •ëœ ê³¨ë“œ ê²½ì œ)
function calculateEnhanceCost(itemLevel, currentStar) {
    if (currentStar >= 30) return 0; // 30ì„±ì€ ìµœëŒ€
    
    const L = itemLevel;
    const S = currentStar;
    const coefficient = COST_COEFFICIENTS[S] || 200;
    
    // ê¸°ë³¸ ê³µì‹: 100 + L Ã— 3^(S+1) Ã— ê³„ìˆ˜
    // Discord ë´‡ ê²½ì œì— ë§ê²Œ 1/10000 ìŠ¤ì¼€ì¼ë¡œ ì¡°ì •
    const baseCost = 100 + L * Math.pow(3, S + 1) * coefficient;
    const adjustedCost = Math.floor(baseCost / 10000);
    
    // ìµœì†Œ ë¹„ìš© ë³´ì¥ ë° ì‹­ì˜ ìë¦¬ ë°˜ì˜¬ë¦¼
    const finalCost = Math.max(100, adjustedCost);
    return Math.round(finalCost / 10) * 10;
}

// ìŠ¤íƒ€í¬ìŠ¤ ìŠ¤íƒ¯ ë³´ë„ˆìŠ¤ ê³„ì‚° í•¨ìˆ˜
function calculateStarforceBonus(itemLevel, starLevel) {
    if (starLevel <= 0) return { attack: 0, defense: 0 };
    
    // ë©”ì´í”ŒìŠ¤í† ë¦¬ ê³µì‹: ë ˆë²¨/20 + ìŠ¤íƒ€ë‹¹ ê³ ì • ë³´ë„ˆìŠ¤
    const baseBonus = Math.floor(itemLevel / 20) + 1;
    
    let attack = 0;
    let defense = 0;
    
    // 1-5ì„±: ê¸°ë³¸ ë³´ë„ˆìŠ¤
    for (let i = 1; i <= Math.min(starLevel, 5); i++) {
        attack += baseBonus;
        defense += baseBonus;
    }
    
    // 6-10ì„±: ë³´ë„ˆìŠ¤ ì¦ê°€
    for (let i = 6; i <= Math.min(starLevel, 10); i++) {
        attack += baseBonus + 1;
        defense += baseBonus + 1;
    }
    
    // 11-15ì„±: ë” í° ë³´ë„ˆìŠ¤
    for (let i = 11; i <= Math.min(starLevel, 15); i++) {
        attack += baseBonus + 2;
        defense += baseBonus + 2;
    }
    
    // 16-25ì„±: ìµœê³  ë³´ë„ˆìŠ¤
    for (let i = 16; i <= Math.min(starLevel, 25); i++) {
        attack += baseBonus + 3;
        defense += baseBonus + 3;
    }
    
    // 26-30ì„±: ê·¹í•œ ë³´ë„ˆìŠ¤
    for (let i = 26; i <= Math.min(starLevel, 30); i++) {
        attack += baseBonus + 5;
        defense += baseBonus + 5;
    }
    
    return { attack, defense };
}

// ìŠ¤íƒ€ìºì¹˜ í™•ë¥  ì¡°ì • í•¨ìˆ˜
function applyStarCatch(rates) {
    const newSuccess = Math.min(100, rates.success * 1.05);
    const remaining = 100 - newSuccess;
    const failRatio = rates.fail / (rates.fail + rates.destroy);
    
    return {
        success: newSuccess,
        fail: remaining * failRatio,
        destroy: remaining * (1 - failRatio)
    };
}

// ì¶•ë³µë°›ì€ë‚  í™•ë¥  ì¡°ì • í•¨ìˆ˜ (15~22ì„±ë§Œ)
function applySundayMaple(rates, starLevel) {
    if (starLevel < 15 || starLevel > 22) return rates;
    
    const newDestroy = rates.destroy * 0.7;
    const newFail = rates.fail + (rates.destroy - newDestroy);
    
    return {
        success: rates.success,
        fail: newFail,
        destroy: newDestroy
    };
}

// ê°•í™” ì‹œë„ í•¨ìˆ˜
function attemptEnhance(rates, isStarCatch = false, isSunday = false, starLevel = 0) {
    let finalRates = { ...rates };
    
    if (isStarCatch) {
        finalRates = applyStarCatch(finalRates);
    }
    
    if (isSunday) {
        finalRates = applySundayMaple(finalRates, starLevel);
    }
    
    const random = Math.random() * 100;
    
    if (random <= finalRates.success) {
        return 'success';
    } else if (random <= finalRates.success + finalRates.fail) {
        return 'fail';
    } else {
        return 'destroy';
    }
}

// ìµœê³  ê°•í™” ì¥ë¹„ ì°¾ê¸° í•¨ìˆ˜
async function getTopEnhancedUser() {
    try {
        const users = await User.find({ registered: true });
        let topUser = null;
        let maxEnhance = -1;
        let topItem = null;

        for (const user of users) {
            // ì°©ìš© ì¥ë¹„ í™•ì¸
            for (const [slot, equipment] of Object.entries(user.equipment)) {
                if (equipment && equipment.enhanceLevel > maxEnhance) {
                    maxEnhance = equipment.enhanceLevel;
                    topUser = user;
                    topItem = equipment;
                }
            }
        }

        return { user: topUser, item: topItem, enhanceLevel: maxEnhance };
    } catch (error) {
        console.error('ìµœê³  ê°•í™” ìœ ì € ì¡°íšŒ ì˜¤ë¥˜:', error);
        return null;
    }
}

// ê°•í™”ì™• ì—­í•  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updateEnhanceKingRole(guild) {
    try {
        const ENHANCE_KING_ROLE_NAME = 'ê°•í™”ì™•';
        
        // ê°•í™”ì™• ì—­í•  ì°¾ê¸° ë˜ëŠ” ìƒì„±
        let enhanceKingRole = guild.roles.cache.find(role => role.name === ENHANCE_KING_ROLE_NAME);
        
        if (!enhanceKingRole) {
            enhanceKingRole = await guild.roles.create({
                name: ENHANCE_KING_ROLE_NAME,
                color: '#FF6B00', // ì£¼í™©ìƒ‰
                hoist: true,
                reason: 'ê°•í™”ì™• ì‹œìŠ¤í…œ ìë™ ìƒì„±'
            });
        }
        
        // í˜„ì¬ ê°•í™”ì™• ì°¾ê¸°
        const currentKing = guild.members.cache.find(member => 
            member.roles.cache.has(enhanceKingRole.id)
        );
        
        // ìµœê³  ê°•í™” ìœ ì € ì°¾ê¸°
        const topData = await getTopEnhancedUser();
        
        if (!topData || !topData.user) return;
        
        const newKing = guild.members.cache.get(topData.user.discordId);
        
        if (!newKing) return;
        
        // í˜„ì¬ ì™•ì´ ìƒˆë¡œìš´ ì™•ê³¼ ë‹¤ë¥´ë©´ ì—­í•  ë³€ê²½
        if (!currentKing || currentKing.id !== newKing.id) {
            // ê¸°ì¡´ ì™•ì—ì„œ ì—­í•  ì œê±°
            if (currentKing) {
                await currentKing.roles.remove(enhanceKingRole);
            }
            
            // ìƒˆë¡œìš´ ì™•ì—ê²Œ ì—­í•  ë¶€ì—¬
            await newKing.roles.add(enhanceKingRole);
        }
        
    } catch (error) {
        console.error('ê°•í™”ì™• ì—­í•  ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
}

// ì „íˆ¬ë ¥ ê³„ì‚° í•¨ìˆ˜
function calculateCombatPower(user) {
    let basePower = 0;
    
    // ì— ë¸”ëŸ¼ì— ë”°ë¥¸ ìŠ¤íƒ¯ ê³„ì‚°
    if (user.emblem) {
        // ì— ë¸”ëŸ¼ ë‹¨ê³„ í™•ì¸
        const emblemLevel = getEmblemLevel(user.emblem);
        const emblemMultiplier = 1 + (emblemLevel * 0.25); // 1ë‹¨ê³„: 1.25, 2ë‹¨ê³„: 1.5, ...
        
        // ì— ë¸”ëŸ¼ ê³„ì—´ì— ë”°ë¥¸ ì£¼ìŠ¤íƒ¯ë§Œ ì ìš©
        const emblemType = getEmblemType(user.emblem);
        
        switch(emblemType) {
            case 'warrior':
                basePower = user.stats.strength * emblemMultiplier * 3; // ì „ì‚¬ëŠ” í˜ë§Œ, ë†’ì€ ë°°ìœ¨
                break;
            case 'archer':
                basePower = user.stats.agility * emblemMultiplier * 3; // ê¶ìˆ˜ëŠ” ë¯¼ì²©ë§Œ
                break;
            case 'spellsword':
                basePower = user.stats.intelligence * emblemMultiplier * 3; // ë§ˆê²€ì‚¬ëŠ” ì§€ëŠ¥ë§Œ
                break;
            case 'rogue':
                basePower = user.stats.luck * emblemMultiplier * 3; // ë„ì ì€ í–‰ìš´ë§Œ
                break;
        }
        
        // ì²´ë ¥ì€ ìƒì¡´ë ¥ìœ¼ë¡œ ëª¨ë“  ì§ì—…ì— ì ìš© (ë‚®ì€ ë°°ìœ¨)
        basePower += user.stats.vitality * 0.5;
    } else {
        // ì— ë¸”ëŸ¼ì´ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹ (ëª¨ë“  ìŠ¤íƒ¯ ë°˜ì˜)
        basePower = user.stats.strength * 2 + user.stats.agility + user.stats.intelligence * 0.5 + user.stats.vitality * 1.5 + user.stats.luck;
    }
    
    // ì¥ë¹„ ë³´ë„ˆìŠ¤ ë° ìŠ¤íƒ€í¬ìŠ¤ ë³´ë„ˆìŠ¤
    let equipmentBonus = 0;
    let starforceBonus = 0;
    
    // ê° ì¥ë¹„ìŠ¬ë¡¯ë³„ ê³„ì‚°
    Object.entries(user.equipment).forEach(([slot, equipment]) => {
        if (equipment) {
            // ê¸°ë³¸ ì¥ë¹„ ìŠ¤íƒ¯
            const attack = equipment.stats.attack || 0;
            const defense = equipment.stats.defense || 0;
            equipmentBonus += attack + defense;
            
            // ìŠ¤íƒ€í¬ìŠ¤ ë³´ë„ˆìŠ¤ ê³„ì‚°
            if (equipment.enhanceLevel > 0) {
                const itemLevel = ITEM_LEVELS[equipment.setName] || ITEM_LEVELS[equipment.name] || equipment.level || 1;
                const bonus = calculateStarforceBonus(itemLevel, equipment.enhanceLevel);
                starforceBonus += bonus.attack + bonus.defense;
            }
        }
    });
    
    // ë ˆë²¨ ë³´ë„ˆìŠ¤
    let levelBonus = user.level * 5;
    
    return Math.floor(basePower + equipmentBonus + starforceBonus + levelBonus);
}

// ì— ë¸”ëŸ¼ ë‹¨ê³„ í™•ì¸ í•¨ìˆ˜
function getEmblemLevel(emblemName) {
    for (const [categoryKey, categoryData] of Object.entries(EMBLEMS)) {
        const emblemIndex = categoryData.emblems.findIndex(emblem => emblem.name === emblemName);
        if (emblemIndex !== -1) {
            return emblemIndex + 1; // 1ë‹¨ê³„ë¶€í„° ì‹œì‘
        }
    }
    return 1; // ê¸°ë³¸ê°’
}

// ì— ë¸”ëŸ¼ ê³„ì—´ í™•ì¸ í•¨ìˆ˜
function getEmblemType(emblemName) {
    for (const [categoryKey, categoryData] of Object.entries(EMBLEMS)) {
        const hasEmblem = categoryData.emblems.some(emblem => emblem.name === emblemName);
        if (hasEmblem) {
            return categoryKey;
        }
    }
    return null;
}

// ëª¬ìŠ¤í„° ì „íˆ¬ë ¥ ê³„ì‚° í•¨ìˆ˜
function calculateMonsterPower(monster, level) {
    return Math.floor(monster.stats.atk + monster.stats.def + (level * 3));
}

// ìœ ì € ì´ˆê¸°í™”/ì¡°íšŒ í•¨ìˆ˜
async function getUser(discordId) {
    try {
        let user = await User.findOne({ discordId });
        if (!user) {
            user = new User({ discordId });
            await user.save();
            console.log(`ìƒˆ ìœ ì € ìƒì„±: ${discordId}`);
        }
        return user;
    } catch (error) {
        console.error('ìœ ì € ì¡°íšŒ/ìƒì„± ì˜¤ë¥˜:', error);
        return null;
    }
}

// ë ˆë²¨ì—… ì²˜ë¦¬ í•¨ìˆ˜
function processLevelUp(user) {
    let leveledUp = false;
    let levelsGained = 0;
    const oldLevel = user.level;
    
    while (user.exp >= user.level * 100) {
        user.exp -= user.level * 100;
        user.level += 1;
        levelsGained += 1;
        leveledUp = true;
        
        // ë ˆë²¨ì—… ì‹œ ìŠ¤íƒ¯í¬ì¸íŠ¸ ì§€ê¸‰ (ë ˆë²¨ë‹¹ 5í¬ì¸íŠ¸)
        user.statPoints += 5;

        // ìƒˆë¡œìš´ ì‚¬ëƒ¥í„° í•´ê¸ˆ ì²´í¬
        const newUnlockArea = huntingAreas.find(area => 
            area.unlockLevel === user.level && !user.unlockedAreas.includes(area.id)
        );
        if (newUnlockArea) {
            user.unlockedAreas.push(newUnlockArea.id);
        }
    }
    
    return { leveledUp, levelsGained, oldLevel };
}

// ì¸ê¸°ë„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updatePopularity(messageAuthorId, emoji, value, messageId, guild) {
    try {
        const user = await getUser(messageAuthorId);
        if (!user || !user.registered) return { success: false, message: 'ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.' };
        
        // ê°™ì€ ë©”ì‹œì§€ì— ëŒ€í•œ ì´ì „ ë°˜ì‘ í™•ì¸
        const existingReaction = user.popularityHistory.find(h => h.messageId === messageId && h.emoji === emoji);
        if (existingReaction) {
            return { success: false, message: 'ì´ë¯¸ ë°˜ì‘í•œ ë©”ì‹œì§€ì…ë‹ˆë‹¤.' };
        }
        
        // ì¼ì¼ ì œí•œ ë¦¬ì…‹ í™•ì¸
        const today = new Date().toDateString();
        if (user.lastPopularityReset !== today) {
            user.dailyPopularityGain = 0;
            user.dailyPopularityLoss = 0;
            user.lastPopularityReset = today;
        }
        
        // ì¼ì¼ ì œí•œ í™•ì¸
        if (value > 0 && user.dailyPopularityGain >= 10) {
            return { success: false, message: 'ì˜¤ëŠ˜ ë°›ì„ ìˆ˜ ìˆëŠ” ì¸ê¸°ë„ ìƒìŠ¹ì¹˜ë¥¼ ëª¨ë‘ ë°›ì•˜ìŠµë‹ˆë‹¤. (+10)' };
        }
        if (value < 0 && user.dailyPopularityLoss <= -10) {
            return { success: false, message: 'ì˜¤ëŠ˜ ë°›ì„ ìˆ˜ ìˆëŠ” ì¸ê¸°ë„ í•˜ë½ì¹˜ë¥¼ ëª¨ë‘ ë°›ì•˜ìŠµë‹ˆë‹¤. (-10)' };
        }
        
        // ì‹¤ì œë¡œ ì ìš©í•  ê°’ ê³„ì‚°
        let actualChange = value;
        if (value > 0) {
            actualChange = Math.min(value, 10 - user.dailyPopularityGain);
            user.dailyPopularityGain += actualChange;
        } else {
            actualChange = Math.max(value, -10 - user.dailyPopularityLoss);
            user.dailyPopularityLoss += actualChange;
        }
        
        if (actualChange === 0) {
            return { success: false, message: `ì˜¤ëŠ˜ì˜ ì¸ê¸°ë„ ${value > 0 ? 'ìƒìŠ¹' : 'í•˜ë½'} í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.` };
        }
        
        // ì¸ê¸°ë„ ì—…ë°ì´íŠ¸
        user.popularity += actualChange;
        user.lastPopularityUpdate = new Date();
        user.popularityHistory.push({
            messageId,
            emoji,
            value: actualChange,
            date: new Date()
        });
        
        await user.save();
        
        // ì¸ê¸°ì™• ì—­í•  ì—…ë°ì´íŠ¸
        await updatePopularKingRole(guild);
        
        const dailyStatus = value > 0 
            ? `(ì˜¤ëŠ˜ +${user.dailyPopularityGain}/10)`
            : `(ì˜¤ëŠ˜ ${user.dailyPopularityLoss}/10)`;
        
        return { 
            success: true, 
            newPopularity: user.popularity,
            change: actualChange,
            message: `ì¸ê¸°ë„ê°€ ${actualChange > 0 ? '+' : ''}${actualChange}ë˜ì–´ ${user.popularity}ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ${dailyStatus}`
        };
    } catch (error) {
        console.error('ì¸ê¸°ë„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        return { success: false, message: 'ì¸ê¸°ë„ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
    }
}

// ì¸ê¸°ì™• ì—­í•  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
async function updatePopularKingRole(guild) {
    try {
        // ì¸ê¸°ì™• ì—­í•  ì°¾ê¸° ë˜ëŠ” ìƒì„±
        let popularKingRole = guild.roles.cache.find(role => role.name === POPULAR_KING_ROLE_NAME);
        
        if (!popularKingRole) {
            popularKingRole = await guild.roles.create({
                name: POPULAR_KING_ROLE_NAME,
                color: '#FFD700',
                hoist: true,
                reason: 'ì¸ê¸°ì™• ì‹œìŠ¤í…œ ìë™ ìƒì„±'
            });
        }
        
        // í˜„ì¬ ì¸ê¸°ì™• ì°¾ê¸°
        const currentKing = guild.members.cache.find(member => 
            member.roles.cache.has(popularKingRole.id)
        );
        
        // ê°€ì¥ ë†’ì€ ì¸ê¸°ë„ë¥¼ ê°€ì§„ ìœ ì € ì°¾ê¸°
        const topUser = await User.findOne({ registered: true })
            .sort({ popularity: -1 })
            .limit(1);
        
        if (!topUser || topUser.popularity <= 0) {
            // ì¸ê¸°ë„ê°€ ì–‘ìˆ˜ì¸ ì‚¬ëŒì´ ì—†ìœ¼ë©´ ì—­í•  íšŒìˆ˜
            if (currentKing) {
                await currentKing.roles.remove(popularKingRole);
            }
            return;
        }
        
        // ìƒˆë¡œìš´ ì¸ê¸°ì™•ì´ í•„ìš”í•œ ê²½ìš°
        if (!currentKing || currentKing.id !== topUser.discordId) {
            // ê¸°ì¡´ ì¸ê¸°ì™• ì—­í•  íšŒìˆ˜
            if (currentKing) {
                await currentKing.roles.remove(popularKingRole);
            }
            
            // ìƒˆë¡œìš´ ì¸ê¸°ì™•ì—ê²Œ ì—­í•  ë¶€ì—¬
            const newKing = await guild.members.fetch(topUser.discordId);
            if (newKing) {
                await newKing.roles.add(popularKingRole);
                
                // ì±„ë„ì— ì•Œë¦¼ (ì„ íƒì‚¬í•­)
                const channel = guild.channels.cache.get(GAME_CHANNEL_ID);
                if (channel) {
                    const embed = new EmbedBuilder()
                        .setColor('#FFD700')
                        .setTitle('ğŸ‘‘ ìƒˆë¡œìš´ ì¸ê¸°ì™• íƒ„ìƒ!')
                        .setDescription(`**${topUser.nickname}**ë‹˜ì´ ì¸ê¸°ë„ ${topUser.popularity}ì ìœ¼ë¡œ ìƒˆë¡œìš´ ì¸ê¸°ì™•ì´ ë˜ì—ˆìŠµë‹ˆë‹¤!`)
                        .setTimestamp();
                    
                    await channel.send({ embeds: [embed] });
                }
            }
        }
    } catch (error) {
        console.error('ì¸ê¸°ì™• ì—­í•  ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
    }
}

// ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì •ì˜
const commands = [
    new SlashCommandBuilder()
        .setName('ê²Œì„')
        .setDescription('ê°•í™”ì™• ê¹€í—Œí„° ê²Œì„ ë©”ë‰´'),
    
    new SlashCommandBuilder()
        .setName('í•‘')
        .setDescription('ë´‡ì˜ ì‘ë‹µ ì†ë„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤'),
    
    new SlashCommandBuilder()
        .setName('íšŒì›ê°€ì…')
        .setDescription('ê°•í™”ì™• ê¹€í—Œí„° íšŒì›ê°€ì…'),
    
    new SlashCommandBuilder()
        .setName('dbí…ŒìŠ¤íŠ¸')
        .setDescription('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸'),
    
    new SlashCommandBuilder()
        .setName('ì´ë©”ì¼í…ŒìŠ¤íŠ¸')
        .setDescription('ì´ë©”ì¼ ì „ì†¡ í…ŒìŠ¤íŠ¸'),
    
    new SlashCommandBuilder()
        .setName('íšŒì›ê°€ì…ì±„ë„ì„¤ì •')
        .setDescription('íšŒì›ê°€ì… ì±„ë„ì— ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ê²Œì‹œí•©ë‹ˆë‹¤'),
    
    new SlashCommandBuilder()
        .setName('ì¸ê¸°ë„í…ŒìŠ¤íŠ¸')
        .setDescription('í…ŒìŠ¤íŠ¸ìš© ì¸ê¸°ë„ ì¡°ì‘ ëª…ë ¹ì–´')
        .addStringOption(option =>
            option.setName('í–‰ë™')
                .setDescription('ìˆ˜í–‰í•  í–‰ë™')
                .setRequired(true)
                .addChoices(
                    { name: 'ì¸ê¸°ë„ ì¦ê°€ (+5)', value: 'add' },
                    { name: 'ì¸ê¸°ë„ ê°ì†Œ (-5)', value: 'subtract' },
                    { name: 'ì¼ì¼ í•œë„ ë¦¬ì…‹', value: 'reset' },
                    { name: 'ì¸ê¸°ë„ í™•ì¸', value: 'check' }
                )),
    
    new SlashCommandBuilder()
        .setName('ì „íˆ¬ë ¥ìˆ˜ì •')
        .setDescription('ê´€ë¦¬ì ì „ìš©: ì „íˆ¬ë ¥ ìˆ˜ì • ëª…ë ¹ì–´')
        .addStringOption(option =>
            option.setName('íƒ€ì…')
                .setDescription('ìˆ˜ì •í•  ëŠ¥ë ¥ì¹˜')
                .setRequired(true)
                .addChoices(
                    { name: 'í˜ (+10)', value: 'strength' },
                    { name: 'ë¯¼ì²© (+10)', value: 'agility' },
                    { name: 'ì§€ëŠ¥ (+10)', value: 'intelligence' },
                    { name: 'ì²´ë ¥ (+10)', value: 'vitality' },
                    { name: 'í–‰ìš´ (+10)', value: 'luck' },
                    { name: 'ì „íˆ¬ë ¥ í™•ì¸', value: 'check' }
                )),

    new SlashCommandBuilder()
        .setName('ê°•í™”')
        .setDescription('ì¥ë¹„ë¥¼ ê°•í™”í•©ë‹ˆë‹¤ (ìŠ¤íƒ€í¬ìŠ¤ 0-30ì„±)')
        .addStringOption(option =>
            option.setName('ì¥ë¹„ìŠ¬ë¡¯')
                .setDescription('ê°•í™”í•  ì¥ë¹„ ìŠ¬ë¡¯')
                .setRequired(true)
                .addChoices(
                    { name: 'ë¬´ê¸° (weapon)', value: 'weapon' },
                    { name: 'ê°‘ì˜· (armor)', value: 'armor' },
                    { name: 'íˆ¬êµ¬ (helmet)', value: 'helmet' },
                    { name: 'ì¥ê°‘ (gloves)', value: 'gloves' },
                    { name: 'ì‹ ë°œ (boots)', value: 'boots' },
                    { name: 'ì•¡ì„¸ì„œë¦¬ (accessory)', value: 'accessory' }
                )),

    new SlashCommandBuilder()
        .setName('ì§‘ì¤‘ë ¥')
        .setDescription('ê¹€í—Œí„°ì˜ ì§‘ì¤‘ë ¥ ì¶•ë³µìœ¼ë¡œ ì¥ë¹„ë¥¼ ê°•í™”í•©ë‹ˆë‹¤ (ì„±ê³µë¥  5% ì¦ê°€)')
        .addStringOption(option =>
            option.setName('ì¥ë¹„ìŠ¬ë¡¯')
                .setDescription('ê°•í™”í•  ì¥ë¹„ ìŠ¬ë¡¯')
                .setRequired(true)
                .addChoices(
                    { name: 'ë¬´ê¸° (weapon)', value: 'weapon' },
                    { name: 'ê°‘ì˜· (armor)', value: 'armor' },
                    { name: 'íˆ¬êµ¬ (helmet)', value: 'helmet' },
                    { name: 'ì¥ê°‘ (gloves)', value: 'gloves' },
                    { name: 'ì‹ ë°œ (boots)', value: 'boots' },
                    { name: 'ì•¡ì„¸ì„œë¦¬ (accessory)', value: 'accessory' }
                )),

    new SlashCommandBuilder()
        .setName('ì¶•ë³µë°›ì€ë‚ ')
        .setDescription('ê¹€í—Œí„°ì˜ ì¶•ë³µë°›ì€ ë‚ ë¡œ ê°•í™”í•©ë‹ˆë‹¤ (15-22ì„± íŒŒê´´ìœ¨ 30% ê°ì†Œ)')
        .addStringOption(option =>
            option.setName('ì¥ë¹„ìŠ¬ë¡¯')
                .setDescription('ê°•í™”í•  ì¥ë¹„ ìŠ¬ë¡¯')
                .setRequired(true)
                .addChoices(
                    { name: 'ë¬´ê¸° (weapon)', value: 'weapon' },
                    { name: 'ê°‘ì˜· (armor)', value: 'armor' },
                    { name: 'íˆ¬êµ¬ (helmet)', value: 'helmet' },
                    { name: 'ì¥ê°‘ (gloves)', value: 'gloves' },
                    { name: 'ì‹ ë°œ (boots)', value: 'boots' },
                    { name: 'ì•¡ì„¸ì„œë¦¬ (accessory)', value: 'accessory' }
                )),

    new SlashCommandBuilder()
        .setName('ê°•í™”ë­í‚¹')
        .setDescription('ê°•í™” ë­í‚¹ì„ í™•ì¸í•©ë‹ˆë‹¤'),

    new SlashCommandBuilder()
        .setName('ê°•í™”í†µê³„')
        .setDescription('ë‚˜ì˜ ê°•í™” í†µê³„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤'),

    new SlashCommandBuilder()
        .setName('ì˜ë¢°')
        .setDescription('ë§ˆì„ ì˜ë¢°ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤')
];

// ë´‡ì´ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ
client.once('ready', async () => {
    console.log(`${client.user.tag} ë´‡ì´ ì˜¨ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤! - ìë™ ì¬ì‹œì‘ í…ŒìŠ¤íŠ¸`);
    console.log(`ê°œë°œ ëª¨ë“œ: ${DEV_MODE ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
    if (DEV_MODE && DEV_CHANNEL_IDS.length > 0) {
        console.log(`ê°œë°œ ì±„ë„ë“¤: ${DEV_CHANNEL_IDS.join(', ')}`);
    }
    
    // MongoDB ì—°ê²°
    await connectDB();
    
    // ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ë“±ë¡
    try {
        const rest = new REST().setToken(TOKEN);
        console.log('ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ë“±ë¡ ì¤‘...');
        
        // ê°œë°œ ëª¨ë“œì—ì„œëŠ” ê¸¸ë“œ(ì„œë²„) ëª…ë ¹ì–´ ì‚¬ìš© (ì¦‰ì‹œ ì ìš©)
        const guildId = DEV_MODE ? '1371885859649097849' : null; // ê°œë°œ ì„œë²„ ID
        
        const data = await rest.put(
            guildId ? Routes.applicationGuildCommands(CLIENT_ID, guildId) : Routes.applicationCommands(CLIENT_ID),
            { body: commands }
        );
        
        console.log(`ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ${data.length}ê°œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        console.log('ë“±ë¡ëœ ëª…ë ¹ì–´:', data.map(cmd => cmd.name).join(', '));
    } catch (error) {
        console.error('ëª…ë ¹ì–´ ë“±ë¡ ì‹¤íŒ¨:', error);
    }
    
    // ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    await initializeEmblemSystem();
});

// ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” í•¨ìˆ˜
async function initializeEmblemSystem() {
    try {
        const channel = await client.channels.fetch(EMBLEM_CHANNEL_ID);
        if (!channel) {
            console.log('ì— ë¸”ëŸ¼ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ì— ë¸”ëŸ¼ ìƒì  ì„ë² ë“œ ìƒì„±
        const emblemEmbed = new EmbedBuilder()
            .setColor('#ff6b6b')
            .setTitle('ğŸ† ì— ë¸”ëŸ¼ ìƒì ')
            .setDescription('**ë ˆë²¨ 20 ì´ìƒ**ë¶€í„° ì— ë¸”ëŸ¼ì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!\n\nì— ë¸”ëŸ¼ì„ êµ¬ë§¤í•˜ë©´ íŠ¹ë³„í•œ ì¹­í˜¸ ì—­í• ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.\n**âš ï¸ ì— ë¸”ëŸ¼ì€ í•œ ë²ˆ êµ¬ë§¤í•˜ë©´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!**')
            .addFields(
                { name: 'âš”ï¸ ì „ì‚¬ ê³„ì—´', value: 'ì´ˆë³´ì „ì‚¬ â†’ íŠ¼íŠ¼í•œ ê¸°ì‚¬ â†’ ìš©ë§¹í•œ ê²€ì‚¬ â†’ ë§¹ë ¹í•œ ì „ì‚¬ â†’ ì „ì„¤ì˜ ê¸°ì‚¬', inline: false },
                { name: 'ğŸ¹ ê¶ìˆ˜ ê³„ì—´', value: 'ë§ˆì„ì‚¬ëƒ¥ê¾¼ â†’ ìˆ²ì˜ ê¶ìˆ˜ â†’ ë°”ëŒ ì‚¬ìˆ˜ â†’ ì •í™•í•œ ì‚¬ê²©ìˆ˜ â†’ ì „ì„¤ì˜ ëª…ê¶', inline: false },
                { name: 'ğŸ”® ë§ˆê²€ì‚¬ ê³„ì—´', value: 'ë§ˆë²• í•™ë„ â†’ ë§ˆë²• ê²€ì‚¬ â†’ í˜„ëª…í•œ ê¸°ì‚¬ â†’ ë§ˆë„ ê²€ì‚¬ â†’ ì „ì„¤ì˜ ë§ˆê²€ì‚¬', inline: false },
                { name: 'ğŸ—¡ï¸ ë„ì  ê³„ì—´', value: 'ë– ëŒì´ ë„ì  â†’ ìš´ ì¢‹ì€ ë„ë‘‘ â†’ í–‰ìš´ì˜ ë‹Œì â†’ ë³µ ë§ì€ ë„ì  â†’ ì „ì„¤ì˜ í–‰ìš´ì•„', inline: false }
            )
            .setFooter({ text: 'ì›í•˜ëŠ” ê³„ì—´ì„ ì„ íƒí•˜ì—¬ ì— ë¸”ëŸ¼ì„ êµ¬ë§¤í•˜ì„¸ìš”!' });

        // ì— ë¸”ëŸ¼ ê³„ì—´ ì„ íƒ ë“œë¡­ë‹¤ìš´
        const emblemSelect = new ActionRowBuilder()
            .addComponents(
                new StringSelectMenuBuilder()
                    .setCustomId('emblem_category')
                    .setPlaceholder('ì— ë¸”ëŸ¼ ê³„ì—´ì„ ì„ íƒí•˜ì„¸ìš”')
                    .addOptions([
                        {
                            label: 'ì „ì‚¬ ê³„ì—´',
                            description: 'ì´ˆë³´ì „ì‚¬ë¶€í„° ì „ì„¤ì˜ ê¸°ì‚¬ê¹Œì§€',
                            value: 'warrior',
                            emoji: 'âš”ï¸'
                        },
                        {
                            label: 'ê¶ìˆ˜ ê³„ì—´',
                            description: 'ë§ˆì„ì‚¬ëƒ¥ê¾¼ë¶€í„° ì „ì„¤ì˜ ëª…ê¶ê¹Œì§€',
                            value: 'archer',
                            emoji: 'ğŸ¹'
                        },
                        {
                            label: 'ë§ˆê²€ì‚¬ ê³„ì—´',
                            description: 'ë§ˆë²• í•™ë„ë¶€í„° ì „ì„¤ì˜ ë§ˆê²€ì‚¬ê¹Œì§€',
                            value: 'spellsword',
                            emoji: 'ğŸ”®'
                        },
                        {
                            label: 'ë„ì  ê³„ì—´',
                            description: 'ë– ëŒì´ ë„ì ë¶€í„° ì „ì„¤ì˜ í–‰ìš´ì•„ê¹Œì§€',
                            value: 'rogue',
                            emoji: 'ğŸ—¡ï¸'
                        }
                    ])
            );

        // ê¸°ì¡´ ë©”ì‹œì§€ ì‚­ì œ í›„ ìƒˆë¡œ ì „ì†¡
        const messages = await channel.messages.fetch({ limit: 10 });
        const botMessages = messages.filter(msg => msg.author.id === client.user.id);
        if (botMessages.size > 0) {
            await channel.bulkDelete(botMessages);
        }

        await channel.send({
            embeds: [emblemEmbed],
            components: [emblemSelect]
        });

        console.log('ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (error) {
        console.error('ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
    }
}

// ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì²˜ë¦¬
client.on('interactionCreate', async (interaction) => {
    if (!interaction.isChatInputCommand()) return;

    console.log(`ëª…ë ¹ì–´ ì‹¤í–‰ - ì±„ë„: ${interaction.channelId}, ê°œë°œ ì±„ë„ë“¤: ${DEV_CHANNEL_IDS.join(', ')}, ê°œë°œ ëª¨ë“œ: ${DEV_MODE}`);
    
    // ê°œë°œ ëª¨ë“œì—ì„œ ì±„ë„ ì œí•œ
    if (DEV_MODE && DEV_CHANNEL_IDS.length > 0 && !DEV_CHANNEL_IDS.includes(interaction.channelId)) {
        console.log(`ì±„ë„ ë¶ˆì¼ì¹˜ - í˜„ì¬: ${interaction.channelId}, í—ˆìš©ëœ ê°œë°œ ì±„ë„ë“¤: ${DEV_CHANNEL_IDS.join(', ')}`);
        await interaction.reply({ content: 'ê°œë°œ ëª¨ë“œì—ì„œëŠ” ì§€ì •ëœ ì±„ë„ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!', ephemeral: true });
        return;
    }

    const { commandName } = interaction;

    try {
        if (commandName === 'í•‘') {
            const ping = Date.now() - interaction.createdTimestamp;
            await interaction.reply(`í! ì§€ì—°ì‹œê°„: ${ping}ms`);
        }
        
        else if (commandName === 'ê²Œì„') {
            const user = await getUser(interaction.user.id);
            if (!user) {
                await interaction.reply({ content: 'ìœ ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ì‹œê°„ëŒ€ë³„ ì´ë¯¸ì§€ ë° ì¸ì‚¬ë§ ì„¤ì •
            const now = new Date();
            const hour = now.getHours();
            
            let timeImage = '';
            let timeColor = '';
            
            if (hour >= 6 && hour < 12) {
                // ì•„ì¹¨ ì‹œê°„ëŒ€ (6:00 - 11:59)
                timeImage = 'kim_main_morning.png';
                timeColor = '#ffeb3b'; // ë…¸ë€ìƒ‰
            } else if (hour >= 12 && hour < 18) {
                // ì ì‹¬ ì‹œê°„ëŒ€ (12:00 - 17:59)
                timeImage = 'kim_main_lunch.png';
                timeColor = '#ff9800'; // ì£¼í™©ìƒ‰
            } else {
                // ì €ë…/ë°¤ ì‹œê°„ëŒ€ (18:00 - 5:59)
                timeImage = 'kim_main_night.png';
                timeColor = '#3f51b5'; // ë‚¨ìƒ‰
            }

            // ìƒíƒœì°½ (RPG ìŠ¤íƒ€ì¼)
            const greetings = [
                'ì˜¤ëŠ˜ë„ í˜ì°¨ê²Œ ëª¨í—˜ì„ ë– ë‚˜ë³¼ê¹Œìš”?',
                'ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆë„¤ìš”!',
                'ëª¨í—˜ê°€ë‹˜, ì¤€ë¹„ëŠ” ë˜ì…¨ë‚˜ìš”?',
                'ì˜¤ëŠ˜ì€ ì–´ë–¤ ì¬ë¯¸ìˆëŠ” ì¼ì´ ìˆì„ê¹Œìš”?',
                'ê°•í™”ì™•ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
                'ë ˆë²¨ì—…ì„ í–¥í•´ ë‹¬ë ¤ê°€ë³¼ê¹Œìš”?',
                'ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!',
                'ëª¨í—˜ì´ ì—¬ëŸ¬ë¶„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!',
                'í–‰ìš´ì´ í•¨ê»˜í•˜ê¸¸ ë°”ëë‹ˆë‹¤!',
                'ìƒˆë¡œìš´ ë„ì „ì´ ì‹œì‘ë©ë‹ˆë‹¤!'
            ];
            
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            
            // ê²½í—˜ì¹˜ ê³„ì‚° ìˆ˜ì • (ë ˆë²¨ì—… ì‹œ í•„ìš” ê²½í—˜ì¹˜ = ë ˆë²¨ * 100)
            const maxExp = user.level * 100;
            
            // ì¶œì„ í˜„í™© ê³„ì‚° (ì˜¤ëŠ˜ ì¶œì„ì²´í¬ ì—¬ë¶€)
            const today = new Date().toDateString();
            const attendanceStatus = user.lastDaily === today ? 'ì¶œì„' : 'ê²°ì„';
            
            const statusEmbed = new EmbedBuilder()
                .setColor(timeColor)
                .setTitle(`${getUserTitle(user)} ${user.nickname}ë‹˜, ${randomGreeting}`)
                .addFields(
                    { name: 'â­ ë ˆë²¨', value: `\`\`\`Lv.${user.level}\`\`\``, inline: true },
                    { name: 'âœ¨ ê²½í—˜ì¹˜', value: `\`\`\`${user.exp}/${maxExp}\`\`\``, inline: true },
                    { name: '<:currency_emoji:1377404064316522778> ê³¨ë“œ', value: `\`\`\`${user.gold.toLocaleString()}\`\`\``, inline: true },
                    { name: 'ğŸ“… ì¶œì„í˜„í™©', value: `\`\`\`${attendanceStatus}\`\`\``, inline: true },
                    { name: 'ğŸ† ì¢…í•©ìˆœìœ„', value: `\`\`\`ì¤€ë¹„ì¤‘\`\`\``, inline: true },
                    { name: 'ğŸ’– ì¸ê¸°ë„', value: `\`\`\`${user.popularity}\`\`\``, inline: true }
                )
                .setImage(`attachment://${timeImage}`)
                .setFooter({ text: 'ê²Œì„ ë©”ë‰´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!' });

            // í˜ì´ì§€ë³„ ë²„íŠ¼ ì •ì˜
            const pages = [
                // í˜ì´ì§€ 1: ì¼ì¼ í™œë™
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('daily')
                            .setLabel('ğŸ ì¶œì„ì²´í¬')
                            .setStyle(ButtonStyle.Success),
                        new ButtonBuilder()
                            .setCustomId('work')
                            .setLabel('âš’ï¸ ì¼í•˜ê¸°')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('quest')
                            .setLabel('ğŸ“œ ì˜ë¢°')
                            .setStyle(ButtonStyle.Primary)
                    ]
                },
                // í˜ì´ì§€ 2: ì „íˆ¬
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('hunting')
                            .setLabel('âš”ï¸ ì‚¬ëƒ¥í•˜ê¸°')
                            .setStyle(ButtonStyle.Danger),
                        new ButtonBuilder()
                            .setCustomId('pvp')
                            .setLabel('ğŸ›¡ï¸ PvP')
                            .setStyle(ButtonStyle.Danger)
                            .setDisabled(true) // ì¤€ë¹„ì¤‘
                    ]
                },
                // í˜ì´ì§€ 3: ëŠ¥ë ¥ì¹˜/ìŠ¤í‚¬
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('stats')
                            .setLabel('ğŸ’ª ëŠ¥ë ¥ì¹˜')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('skills')
                            .setLabel('ğŸ”® ìŠ¤í‚¬')
                            .setStyle(ButtonStyle.Primary)
                    ]
                },
                // í˜ì´ì§€ 4: ìƒì /ì¸ë²¤í† ë¦¬
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('shop')
                            .setLabel('ğŸ›’ ìƒì ')
                            .setStyle(ButtonStyle.Secondary),
                        new ButtonBuilder()
                            .setCustomId('inventory')
                            .setLabel('ğŸ’ ì¸ë²¤í† ë¦¬')
                            .setStyle(ButtonStyle.Secondary)
                    ]
                },
                // í˜ì´ì§€ 5: ì¥ë¹„/ê°•í™”
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('equipment')
                            .setLabel('âš”ï¸ ì¥ë¹„')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('enhancement')
                            .setLabel('âš¡ ê°•í™”')
                            .setStyle(ButtonStyle.Primary)
                            .setDisabled(user.level < 10), // ë ˆë²¨ 10 ì´ìƒë§Œ ì‚¬ìš© ê°€ëŠ¥
                        new ButtonBuilder()
                            .setCustomId('ranking')
                            .setLabel('ğŸ† ë­í‚¹')
                            .setStyle(ButtonStyle.Secondary),
                        new ButtonBuilder()
                            .setCustomId('info')
                            .setLabel('ğŸ‘¤ ë‚´ì •ë³´')
                            .setStyle(ButtonStyle.Secondary)
                    ]
                }
            ];

            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
            const navigationRow = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('prev_page')
                        .setLabel('â—€')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true), // ì²« í˜ì´ì§€ì—ì„œëŠ” ë¹„í™œì„±í™”
                    new ButtonBuilder()
                        .setCustomId('page_info')
                        .setLabel('1/5')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId('next_page')
                        .setLabel('â–¶')
                        .setStyle(ButtonStyle.Secondary)
                );

            // ì²« í˜ì´ì§€ ë²„íŠ¼ row
            const contentRow = new ActionRowBuilder()
                .addComponents(pages[0].buttons);

            // ì‹œê°„ëŒ€ë³„ ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼
            const timeAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', timeImage), { name: timeImage });
            
            await interaction.reply({ 
                embeds: [statusEmbed], 
                components: [contentRow, navigationRow], 
                files: [timeAttachment],
                ephemeral: true 
            });
        }
        
        else if (commandName === 'íšŒì›ê°€ì…') {
            const attachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_join.png'), { name: 'kim_join.png' });
            
            const embed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle('ê°•í™”ì™• ê¹€í—Œí„° íšŒì›ê°€ì…')
                .setDescription('í™˜ì˜í•©ë‹ˆë‹¤! ê°•í™”ì™• ê¹€í—Œí„°ì˜ ì„¸ê³„ë¡œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.\n\nê²Œì„ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.')
                .setImage('attachment://kim_join.png')
                .addFields(
                    { name: 'ì´ë©”ì¼ ë¬¸ì˜', value: 'support@kimhunter.com', inline: true },
                    { name: 'ë””ìŠ¤ì½”ë“œ ë¬¸ì˜', value: 'ê¹€í—Œí„°#0001', inline: true },
                    { name: 'ê¸°íƒ€ ë¬¸ì˜', value: 'í‹°ì¼“ ì‹œìŠ¤í…œ ì´ìš©', inline: true }
                )
                .setFooter({ text: 'ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ íšŒì›ê°€ì…ì„ ì§„í–‰í•˜ì„¸ìš”!' });

            const row = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('register')
                        .setLabel('íšŒì›ê°€ì…')
                        .setStyle(ButtonStyle.Primary)
                );

            await interaction.reply({ embeds: [embed], components: [row], files: [attachment] });
        }
        
        else if (commandName === 'dbí…ŒìŠ¤íŠ¸') {
            try {
                const user = await getUser(interaction.user.id);
                const totalUsers = await User.countDocuments();
                
                const embed = new EmbedBuilder()
                    .setColor('#00ff00')
                    .setTitle('ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŠ¸')
                    .setDescription('MongoDB ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.')
                    .addFields(
                        { name: 'ì—°ê²° ìƒíƒœ', value: 'MongoDB ì—°ê²° ì„±ê³µ', inline: true },
                        { name: 'ì´ ìœ ì € ìˆ˜', value: `${totalUsers}ëª…`, inline: true },
                        { name: 'ë‚´ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                        { name: 'ë‚´ ë ˆë²¨', value: `Lv.${user.level}`, inline: true },
                        { name: 'Discord ID', value: user.discordId, inline: true },
                        { name: 'ê°€ì…ì¼', value: user.createdAt.toLocaleDateString('ko-KR'), inline: true }
                    );
                
                await interaction.reply({ embeds: [embed], ephemeral: true });
            } catch (error) {
                console.error('DB í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                await interaction.reply({ content: 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨!', ephemeral: true });
            }
        }
        
        else if (commandName === 'ì¸ê¸°ë„í…ŒìŠ¤íŠ¸') {
            const action = interaction.options.getString('í–‰ë™');
            const user = await getUser(interaction.user.id);
            
            if (!user || !user.registered) {
                await interaction.reply({ content: 'ë¨¼ì € íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”!', ephemeral: true });
                return;
            }
            
            let message = '';
            
            switch(action) {
                case 'add':
                    user.popularity += 5;
                    await user.save();
                    await updatePopularKingRole(interaction.guild);
                    message = `ì¸ê¸°ë„ê°€ 5 ì¦ê°€í•˜ì—¬ ${user.popularity}ì ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    break;
                    
                case 'subtract':
                    user.popularity -= 5;
                    await user.save();
                    await updatePopularKingRole(interaction.guild);
                    message = `ì¸ê¸°ë„ê°€ 5 ê°ì†Œí•˜ì—¬ ${user.popularity}ì ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    break;
                    
                case 'reset':
                    user.dailyPopularityGain = 0;
                    user.dailyPopularityLoss = 0;
                    user.lastPopularityReset = new Date().toDateString();
                    await user.save();
                    message = 'ì¼ì¼ ì¸ê¸°ë„ í•œë„ê°€ ë¦¬ì…‹ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    break;
                    
                case 'check':
                    const today = new Date().toDateString();
                    const isToday = user.lastPopularityReset === today;
                    message = `í˜„ì¬ ì¸ê¸°ë„: ${user.popularity}ì \n` +
                             `ì˜¤ëŠ˜ ë°›ì€ ì¸ê¸°ë„: +${isToday ? user.dailyPopularityGain : 0}/10\n` +
                             `ì˜¤ëŠ˜ ìƒì€ ì¸ê¸°ë„: ${isToday ? user.dailyPopularityLoss : 0}/10`;
                    break;
            }
            
            const embed = new EmbedBuilder()
                .setColor('#FFD700')
                .setTitle('ì¸ê¸°ë„ í…ŒìŠ¤íŠ¸')
                .setDescription(message)
                .setTimestamp();
                
            await interaction.reply({ embeds: [embed], ephemeral: true });
        }
        
        else if (commandName === 'ì „íˆ¬ë ¥ìˆ˜ì •') {
            if (!isDeveloper(interaction.user.id)) {
                await interaction.reply({ content: 'ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ëª…ë ¹ì–´ì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            const user = await getUser(interaction.user.id);
            const statType = interaction.options.getString('íƒ€ì…');
            
            if (statType === 'check') {
                const combatPower = calculateCombatPower(user);
                const embed = new EmbedBuilder()
                    .setColor('#e74c3c')
                    .setTitle('âš”ï¸ ì „íˆ¬ë ¥ ì •ë³´')
                    .setDescription(`**${user.nickname}**ë‹˜ì˜ ì „íˆ¬ë ¥ ì •ë³´`)
                    .addFields(
                        { name: 'ì´ ì „íˆ¬ë ¥', value: `${combatPower}`, inline: true },
                        { name: 'ğŸ’ª í˜', value: `${user.stats.strength}`, inline: true },
                        { name: 'ğŸƒ ë¯¼ì²©', value: `${user.stats.agility}`, inline: true },
                        { name: 'ğŸ§  ì§€ëŠ¥', value: `${user.stats.intelligence}`, inline: true },
                        { name: 'â¤ï¸ ì²´ë ¥', value: `${user.stats.vitality}`, inline: true },
                        { name: 'ğŸ€ í–‰ìš´', value: `${user.stats.luck}`, inline: true }
                    );
                await interaction.reply({ embeds: [embed], ephemeral: true });
            } else {
                user.stats[statType] += 10;
                await user.save();
                
                const statNames = {
                    strength: 'ğŸ’ª í˜',
                    agility: 'ğŸƒ ë¯¼ì²©',
                    intelligence: 'ğŸ§  ì§€ëŠ¥',
                    vitality: 'â¤ï¸ ì²´ë ¥',
                    luck: 'ğŸ€ í–‰ìš´'
                };
                
                const newCombatPower = calculateCombatPower(user);
                await interaction.reply({ 
                    content: `${statNames[statType]}ì´ 10 ì¦ê°€í–ˆìŠµë‹ˆë‹¤! ì „íˆ¬ë ¥: ${newCombatPower}`, 
                    ephemeral: true 
                });
            }
        }
        
        else if (commandName === 'ì´ë©”ì¼í…ŒìŠ¤íŠ¸') {
            try {
                // ë¨¼ì € ì‘ë‹µì„ ì§€ì—°ì‹œì¼œ ì‹œê°„ ì œí•œ ë¬¸ì œ í•´ê²°
                await interaction.deferReply({ ephemeral: true });
                
                const testCode = generateVerificationCode();
                const emailSent = await sendVerificationEmail('sup.kimhunter@gmail.com', testCode);
                
                if (emailSent) {
                    const embed = new EmbedBuilder()
                        .setColor('#00ff00')
                        .setTitle('ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì„±ê³µ!')
                        .setDescription('í…ŒìŠ¤íŠ¸ ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.')
                        .addFields(
                            { name: 'ìˆ˜ì‹  ì´ë©”ì¼', value: 'sup.kimhunter@gmail.com', inline: true },
                            { name: 'í…ŒìŠ¤íŠ¸ ì½”ë“œ', value: testCode, inline: true },
                            { name: 'ì „ì†¡ ì‹œê°„', value: new Date().toLocaleString('ko-KR'), inline: true }
                        );
                    
                    await interaction.editReply({ embeds: [embed] });
                } else {
                    await interaction.editReply({ content: 'ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!' });
                }
            } catch (error) {
                console.error('ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', error);
                if (interaction.deferred) {
                    await interaction.editReply({ content: 'ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!' });
                } else {
                    await interaction.reply({ content: 'ì´ë©”ì¼ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!', ephemeral: true });
                }
            }
        }
        
        else if (commandName === 'íšŒì›ê°€ì…ì±„ë„ì„¤ì •') {
            try {
                await interaction.deferReply({ ephemeral: true });
                
                const SIGNUP_CHANNEL_ID = '1380684353998426122';
                const signupChannel = await client.channels.fetch(SIGNUP_CHANNEL_ID);
                
                if (signupChannel) {
                    const signupAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_join.png'), { name: 'kim_join.png' });
                    
                    const signupEmbed = new EmbedBuilder()
                        .setColor('#ff6b6b')
                        .setTitle('ê°•í™”ì™• ê¹€í—Œí„° íšŒì›ê°€ì…')
                        .setDescription('í™˜ì˜í•©ë‹ˆë‹¤! ê°•í™”ì™• ê¹€í—Œí„°ì˜ ì„¸ê³„ë¡œ ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.\n\nê²Œì„ì„ ì‹œì‘í•˜ê¸° ìœ„í•´ íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.\n\n**íšŒì›ê°€ì… í˜œíƒ:**\nâ€¢ ê°€ì… ì¦‰ì‹œ 1,000G ì§€ê¸‰\nâ€¢ ê²½í—˜ì¹˜ ë¶€ìŠ¤í„° ë° ì´ˆë³´ì ë¬´ê¸° ì œê³µ\nâ€¢ ì¼ì¼ë³´ìƒ ë° ë‹¤ì–‘í•œ ê²Œì„ ì»¨í…ì¸  ì´ìš© ê°€ëŠ¥')
                        .setImage('attachment://kim_join.png')
                        .addFields(
                            { name: 'ğŸ“§ ì´ë©”ì¼ ë¬¸ì˜', value: 'sup.kimhunter@gmail.com', inline: true },
                            { name: 'ğŸ’¬ ë””ìŠ¤ì½”ë“œ ë¬¸ì˜', value: 'JRY_10004', inline: true },
                            { name: 'ğŸ« í‹°ì¼“ ë¬¸ì˜', value: 'ì¶”í›„ ë²„íŠ¼ë§í¬ ìƒì„± ì˜ˆì •', inline: true }
                        )
                        .setFooter({ text: 'ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ íšŒì›ê°€ì…ì„ ì§„í–‰í•˜ì„¸ìš”!' });

                    const signupRow = new ActionRowBuilder()
                        .addComponents(
                            new ButtonBuilder()
                                .setCustomId('register')
                                .setLabel('íšŒì›ê°€ì…')
                                .setStyle(ButtonStyle.Primary)
                        );

                    await signupChannel.send({ embeds: [signupEmbed], components: [signupRow], files: [signupAttachment] });
                    
                    await interaction.editReply({ content: 'íšŒì›ê°€ì… ì±„ë„ì— ì•ˆë‚´ ë©”ì‹œì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œí–ˆìŠµë‹ˆë‹¤!' });
                } else {
                    await interaction.editReply({ content: 'íšŒì›ê°€ì… ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!' });
                }
            } catch (error) {
                console.error('íšŒì›ê°€ì… ì±„ë„ ì„¤ì • ì˜¤ë¥˜:', error);
                if (interaction.deferred) {
                    await interaction.editReply({ content: 'íšŒì›ê°€ì… ì±„ë„ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!' });
                } else {
                    await interaction.reply({ content: 'íšŒì›ê°€ì… ì±„ë„ ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!', ephemeral: true });
                }
            }
        }
        
        // ê°•í™” ëª…ë ¹ì–´ ì²˜ë¦¬
        else if (commandName === 'ê°•í™”' || commandName === 'ì§‘ì¤‘ë ¥' || commandName === 'ì¶•ë³µë°›ì€ë‚ ') {
            const slotName = interaction.options.getString('ì¥ë¹„ìŠ¬ë¡¯');
            const user = await getUser(interaction.user.id);
            
            if (!user || !user.registered) {
                await interaction.reply({ content: 'ë¨¼ì € íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”!', ephemeral: true });
                return;
            }
            
            const equipment = user.equipment[slotName];
            if (!equipment) {
                await interaction.reply({ content: `${slotName} ìŠ¬ë¡¯ì— ì¥ì°©ëœ ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤!`, ephemeral: true });
                return;
            }
            
            if (equipment.enhanceLevel >= 30) {
                await interaction.reply({ content: 'ì´ë¯¸ ìµœëŒ€ ê°•í™” ë‹¨ê³„(30ì„±)ì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ì•„ì´í…œ ë ˆë²¨ ê°€ì ¸ì˜¤ê¸°
            const itemLevel = ITEM_LEVELS[equipment.setName] || ITEM_LEVELS[equipment.name] || 1;
            const currentStar = equipment.enhanceLevel || 0;
            const cost = calculateEnhanceCost(itemLevel, currentStar);
            
            if (user.gold < cost) {
                await interaction.reply({ 
                    content: `ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! í•„ìš”: ${cost}G, ë³´ìœ : ${user.gold}G`, 
                    ephemeral: true 
                });
                return;
            }
            
            // ê°•í™” ì‹œë„
            const rates = STARFORCE_RATES[currentStar];
            const isStarCatch = commandName === 'ì§‘ì¤‘ë ¥';
            const isSunday = commandName === 'ì¶•ë³µë°›ì€ë‚ ';
            
            const result = attemptEnhance(rates, isStarCatch, isSunday, currentStar);
            user.gold -= cost;
            
            // ê°•í™” í†µê³„ ì—…ë°ì´íŠ¸
            user.enhanceStats.totalAttempts += 1;
            user.enhanceStats.totalCost += cost;
            
            let resultEmbed;
            
            if (result === 'success') {
                equipment.enhanceLevel += 1;
                user.enhanceStats.successCount += 1;
                user.enhanceStats.maxEnhanceLevel = Math.max(user.enhanceStats.maxEnhanceLevel, equipment.enhanceLevel);
                
                resultEmbed = new EmbedBuilder()
                    .setColor('#00ff00')
                    .setTitle('ğŸ‰ ê°•í™” ì„±ê³µ!')
                    .setDescription(`**${equipment.name}**ì´(ê°€) ê°•í™”ë˜ì—ˆìŠµë‹ˆë‹¤!`)
                    .addFields(
                        { name: 'ê°•í™” ê²°ê³¼', value: `+${currentStar} â†’ **+${equipment.enhanceLevel}**â­`, inline: true },
                        { name: 'ì‚¬ìš© ê³¨ë“œ', value: `${cost}G`, inline: true },
                        { name: 'ì”ì—¬ ê³¨ë“œ', value: `${user.gold}G`, inline: true }
                    );
                    
                // ê°•í™”ì™• ì—…ë°ì´íŠ¸ (10ì„± ì´ìƒì¼ ë•Œ)
                if (equipment.enhanceLevel >= 10) {
                    await updateEnhanceKingRole(interaction.guild);
                }
                
            } else if (result === 'fail') {
                resultEmbed = new EmbedBuilder()
                    .setColor('#ffaa00')
                    .setTitle('ğŸ’« ê°•í™” ì‹¤íŒ¨')
                    .setDescription(`**${equipment.name}** ê°•í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`)
                    .addFields(
                        { name: 'ê°•í™” ê²°ê³¼', value: `+${currentStar} (ë³€í™”ì—†ìŒ)`, inline: true },
                        { name: 'ì‚¬ìš© ê³¨ë“œ', value: `${cost}G`, inline: true },
                        { name: 'ì”ì—¬ ê³¨ë“œ', value: `${user.gold}G`, inline: true }
                    );
                    
            } else { // destroy
                const oldLevel = equipment.enhanceLevel;
                equipment.enhanceLevel = Math.max(0, equipment.enhanceLevel - 1);
                user.enhanceStats.destroyCount += 1;
                
                resultEmbed = new EmbedBuilder()
                    .setColor('#ff0000')
                    .setTitle('ğŸ’¥ ê°•í™” íŒŒê´´!')
                    .setDescription(`**${equipment.name}**ì´(ê°€) íŒŒê´´ë˜ì–´ ê°•í™” ë‹¨ê³„ê°€ ê°ì†Œí–ˆìŠµë‹ˆë‹¤!`)
                    .addFields(
                        { name: 'ê°•í™” ê²°ê³¼', value: `+${oldLevel} â†’ **+${equipment.enhanceLevel}**ğŸ’€`, inline: true },
                        { name: 'ì‚¬ìš© ê³¨ë“œ', value: `${cost}G`, inline: true },
                        { name: 'ì”ì—¬ ê³¨ë“œ', value: `${user.gold}G`, inline: true }
                    );
            }
            
            // ì´ë²¤íŠ¸ íš¨ê³¼ í‘œì‹œ
            if (isStarCatch) {
                resultEmbed.setFooter({ text: 'ğŸŒŸ ì§‘ì¤‘ë ¥ ì´ë²¤íŠ¸ ì ìš© (ì„±ê³µë¥  +5%)' });
            } else if (isSunday && currentStar >= 15 && currentStar <= 22) {
                resultEmbed.setFooter({ text: 'ğŸ ì¶•ë³µë°›ì€ë‚  ì´ë²¤íŠ¸ ì ìš© (íŒŒê´´ìœ¨ -30%)' });
            }
            
            await user.save();
            await interaction.reply({ embeds: [resultEmbed] });
        }
        
        else if (commandName === 'ê°•í™”ë­í‚¹') {
            await interaction.deferReply();
            
            try {
                const users = await User.find({ registered: true });
                const rankingData = [];
                
                for (const user of users) {
                    let maxEnhance = 0;
                    let topItem = null;
                    
                    // ì°©ìš© ì¥ë¹„ì—ì„œ ìµœê³  ê°•í™” ì°¾ê¸°
                    for (const [slot, equipment] of Object.entries(user.equipment)) {
                        if (equipment && equipment.enhanceLevel > maxEnhance) {
                            maxEnhance = equipment.enhanceLevel;
                            topItem = equipment;
                        }
                    }
                    
                    if (maxEnhance > 0) {
                        rankingData.push({
                            nickname: user.nickname,
                            enhanceLevel: maxEnhance,
                            itemName: topItem.name,
                            totalAttempts: user.enhanceStats.totalAttempts || 0
                        });
                    }
                }
                
                // ê°•í™” ë ˆë²¨ìˆœìœ¼ë¡œ ì •ë ¬
                rankingData.sort((a, b) => b.enhanceLevel - a.enhanceLevel);
                
                const embed = new EmbedBuilder()
                    .setColor('#ffd700')
                    .setTitle('âš”ï¸ ê°•í™” ë­í‚¹ TOP 10')
                    .setDescription('ìµœê³  ê°•í™” ì¥ë¹„ ê¸°ì¤€ ë­í‚¹');
                
                let rankText = '';
                for (let i = 0; i < Math.min(10, rankingData.length); i++) {
                    const data = rankingData[i];
                    const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i + 1}ìœ„`;
                    rankText += `${medal} **${data.nickname}** - ${data.itemName} +${data.enhanceLevel}â­\n`;
                }
                
                if (rankText === '') {
                    rankText = 'ì•„ì§ ê°•í™”í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                }
                
                embed.addFields({ name: 'ë­í‚¹', value: rankText, inline: false });
                
                await interaction.editReply({ embeds: [embed] });
                
            } catch (error) {
                console.error('ê°•í™”ë­í‚¹ ì¡°íšŒ ì˜¤ë¥˜:', error);
                await interaction.editReply({ content: 'ë­í‚¹ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!' });
            }
        }
        
        else if (commandName === 'ì˜ë¢°') {
            // ì¿¨íƒ€ì„ ì²´í¬
            const cooldownMinutes = checkQuestCooldown(interaction.user.id);
            if (cooldownMinutes) {
                await interaction.reply({ 
                    content: `â° ì˜ë¢° ì¿¨íƒ€ì„ì´ **${cooldownMinutes}ë¶„** ë‚¨ì•˜ìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
                return;
            }

            // ëœë¤ ì˜ë¢° ì„ íƒ
            const quest = getRandomQuest();
            
            const questEmbed = new EmbedBuilder()
                .setColor('#f39c12')
                .setTitle(`${quest.emoji} ${quest.title}`)
                .setDescription(`**${quest.name}**\n\n"${quest.description}"`)
                .setFooter({ text: 'ì˜ë¢°ë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' });

            if (quest.type === 'scam') {
                questEmbed.setColor('#e74c3c');
            }

            const questButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`accept_quest_${quest.id}`)
                        .setLabel('âœ… ìˆ˜ë½')
                        .setStyle(ButtonStyle.Success),
                    new ButtonBuilder()
                        .setCustomId('decline_quest')
                        .setLabel('âŒ ê±°ì ˆ')
                        .setStyle(ButtonStyle.Danger)
                );

            await interaction.reply({ 
                embeds: [questEmbed], 
                components: [questButtons], 
                ephemeral: true 
            });
        }
        
        else if (commandName === 'ê°•í™”í†µê³„') {
            const user = await getUser(interaction.user.id);
            
            if (!user || !user.registered) {
                await interaction.reply({ content: 'ë¨¼ì € íšŒì›ê°€ì…ì„ í•´ì£¼ì„¸ìš”!', ephemeral: true });
                return;
            }
            
            const stats = user.enhanceStats;
            const successRate = stats.totalAttempts > 0 ? ((stats.successCount / stats.totalAttempts) * 100).toFixed(1) : 0;
            const destroyRate = stats.totalAttempts > 0 ? ((stats.destroyCount / stats.totalAttempts) * 100).toFixed(1) : 0;
            
            const embed = new EmbedBuilder()
                .setColor('#9b59b6')
                .setTitle(`ğŸ“Š ${user.nickname}ë‹˜ì˜ ê°•í™” í†µê³„`)
                .addFields(
                    { name: 'ğŸ¯ ì´ ì‹œë„ íšŸìˆ˜', value: `${stats.totalAttempts}íšŒ`, inline: true },
                    { name: 'âœ… ì„±ê³µ íšŸìˆ˜', value: `${stats.successCount}íšŒ`, inline: true },
                    { name: 'ğŸ’¥ íŒŒê´´ íšŸìˆ˜', value: `${stats.destroyCount}íšŒ`, inline: true },
                    { name: 'ğŸ“ˆ ì„±ê³µë¥ ', value: `${successRate}%`, inline: true },
                    { name: 'ğŸ’€ íŒŒê´´ìœ¨', value: `${destroyRate}%`, inline: true },
                    { name: 'â­ ìµœê³  ê°•í™”', value: `+${stats.maxEnhanceLevel}ì„±`, inline: true },
                    { name: 'ğŸ’° ì´ ì‚¬ìš© ê³¨ë“œ', value: `${stats.totalCost.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: false }
                );
            
            await interaction.reply({ embeds: [embed], ephemeral: true });
        }
        
    } catch (error) {
        console.error('ëª…ë ¹ì–´ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        if (!interaction.replied) {
            await interaction.reply({ content: 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!', ephemeral: true });
        }
    }
});

// ë²„íŠ¼ í´ë¦­ ë° ì„ íƒ ë©”ë‰´ ì²˜ë¦¬
client.on('interactionCreate', async (interaction) => {
    if (!interaction.isButton() && !interaction.isStringSelectMenu()) return;

    // ê°œë°œ ëª¨ë“œì—ì„œ ì±„ë„ ì œí•œ
    if (DEV_MODE && DEV_CHANNEL_IDS.length > 0 && !DEV_CHANNEL_IDS.includes(interaction.channelId)) {
        console.log(`ì±„ë„ ë¶ˆì¼ì¹˜ - í˜„ì¬: ${interaction.channelId}, í—ˆìš©ëœ ê°œë°œ ì±„ë„ë“¤: ${DEV_CHANNEL_IDS.join(', ')}`);
        await interaction.reply({ content: 'ê°œë°œ ëª¨ë“œì—ì„œëŠ” ì§€ì •ëœ ì±„ë„ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!', ephemeral: true });
        return;
    }

    const user = await getUser(interaction.user.id);
    if (!user) {
        await interaction.reply({ content: 'ìœ ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
        return;
    }
    const now = Date.now();

    try {
        // ë©”ì¸í™”ë©´ì˜ ê²Œì„í•˜ê¸° ë²„íŠ¼ ì²˜ë¦¬
        if (interaction.customId === 'game_start') {
            const user = await getUser(interaction.user.id);
            if (!user) {
                await interaction.reply({ content: 'ìœ ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ê²Œì„ ì±„ë„ ì•ˆë‚´ ë©”ì‹œì§€
            const gameGuideEmbed = new EmbedBuilder()
                .setColor('#00ff00')
                .setTitle('ê²Œì„ ì‹œì‘!')
                .setDescription(`**${user.nickname || interaction.user.username}**ë‹˜, ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤!\n\nê²Œì„ ì±„ë„ì—ì„œ \`/ê²Œì„\` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê²Œì„ì„ í”Œë ˆì´í•˜ì„¸ìš”.\n\n**ê²Œì„ ì±„ë„ë¡œ ì´ë™í•˜ì—¬ ë³¸ê²©ì ì¸ ëª¨í—˜ì„ ì‹œì‘í•´ë³´ì„¸ìš”!**`)
                .addFields(
                    { name: 'ëª…ë ¹ì–´ ì•ˆë‚´', value: '`/ê²Œì„` - ê²Œì„ ë©”ë‰´ ì—´ê¸°', inline: true },
                    { name: 'í˜„ì¬ ìƒíƒœ', value: `ê³¨ë“œ: ${user.gold.toLocaleString()}${goldEmoji}\në ˆë²¨: Lv.${user.level}`, inline: true }
                )
                .setFooter({ text: 'ê²Œì„ ì±„ë„ì—ì„œ ë” ë§ì€ ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!' });

            await interaction.reply({ embeds: [gameGuideEmbed], ephemeral: true });
        }
        
        else if (interaction.customId === 'support_info') {
            // í›„ì› ì•ˆë‚´ (ì¶”í›„ êµ¬í˜„)
            const supportEmbed = new EmbedBuilder()
                .setColor('#ffaa00')
                .setTitle('í›„ì› ì•ˆë‚´')
                .setDescription('í›„ì› ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\n\nê°œë°œìë¥¼ ì‘ì›í•´ì£¼ì‹œëŠ” ë§ˆìŒì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤!')
                .setFooter({ text: 'ê³§ í›„ì› ì‹œìŠ¤í…œì´ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤.' });
                
            await interaction.reply({ embeds: [supportEmbed], ephemeral: true });
        }
        
        else if (interaction.customId === 'hunting') {
            // ê°œë°œìëŠ” ëª¨ë“  ì‚¬ëƒ¥í„° ì ‘ê·¼ ê°€ëŠ¥, ì¼ë°˜ ìœ ì €ëŠ” ì–¸ë½ëœ ì‚¬ëƒ¥í„°ë§Œ
            const availableAreas = isDeveloper(interaction.user.id) ? 
                huntingAreas : 
                huntingAreas.filter(area => user.unlockedAreas.includes(area.id));

            if (availableAreas.length === 0) {
                await interaction.reply({ content: 'ì‚¬ìš© ê°€ëŠ¥í•œ ì‚¬ëƒ¥í„°ê°€ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            // ì‚¬ëƒ¥í„° í˜ì´ì§€ë„¤ì´ì…˜ (í•œ í˜ì´ì§€ì— 3ê°œì”©)
            const areasPerPage = 3;
            const totalPages = Math.ceil(availableAreas.length / areasPerPage);
            const currentPage = 0; // ì²« í˜ì´ì§€ë¶€í„° ì‹œì‘

            const startIndex = currentPage * areasPerPage;
            const endIndex = startIndex + areasPerPage;
            const currentAreas = availableAreas.slice(startIndex, endIndex);

            // ì‚¬ëƒ¥í„° ì„ íƒ ì„ë² ë“œ
            const huntingEmbed = new EmbedBuilder()
                .setColor('#8b0000')
                .setTitle('âš”ï¸ ì‚¬ëƒ¥í„° ì„ íƒ')
                .setDescription(`**${user.nickname}**ë‹˜ì˜ ì‚¬ëƒ¥í„° ëª©ë¡\n\ní˜„ì¬ ë ˆë²¨: **Lv.${user.level}**`)
                .setFooter({ text: `í˜ì´ì§€ ${currentPage + 1}/${totalPages} | ì‚¬ëƒ¥í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”!` });

            // ì‚¬ëƒ¥í„°ë³„ í•„ë“œ ì¶”ê°€
            currentAreas.forEach(area => {
                const monsterNames = area.monsters.map(m => m.name).join(', ');
                huntingEmbed.addFields({
                    name: `${area.name} ${area.levelRange}`,
                    value: `ì¶œí˜„ëª¬ìŠ¤í„°: ${monsterNames}`,
                    inline: true
                });
            });

            // ì‚¬ëƒ¥í„° ë²„íŠ¼ë“¤
            const huntingButtons = new ActionRowBuilder();
            currentAreas.forEach(area => {
                huntingButtons.addComponents(
                    new ButtonBuilder()
                        .setCustomId(`hunt_area_${area.id}`)
                        .setLabel(area.name)
                        .setStyle(ButtonStyle.Primary)
                );
            });

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
            const navButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('hunt_prev_page')
                        .setLabel('â—€ ì´ì „')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage === 0),
                    new ButtonBuilder()
                        .setCustomId('hunt_page_info')
                        .setLabel(`${currentPage + 1}/${totalPages}`)
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId('hunt_next_page')
                        .setLabel('ë‹¤ìŒ â–¶')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage >= totalPages - 1),
                    new ButtonBuilder()
                        .setCustomId('back_to_game_menu')
                        .setLabel('ğŸ® ê²Œì„ ë©”ë‰´')
                        .setStyle(ButtonStyle.Success)
                );

            const components = [huntingButtons];
            if (totalPages > 1) components.push(navButtons);
            else {
                // í˜ì´ì§€ê°€ 1ê°œë©´ ê²Œì„ ë©”ë‰´ ë²„íŠ¼ë§Œ ì¶”ê°€
                const backOnly = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId('back_to_game_menu')
                            .setLabel('ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°')
                            .setStyle(ButtonStyle.Success)
                    );
                components.push(backOnly);
            }

            await interaction.reply({ embeds: [huntingEmbed], components, ephemeral: true });
        }
        
        else if (interaction.customId === 'ranking') {
            try {
                // ê° ë­í‚¹ë³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const [levelRanking, goldRanking, popularityRanking] = await Promise.all([
                    User.find({ registered: true }).sort({ level: -1, exp: -1 }).limit(5),
                    User.find({ registered: true }).sort({ gold: -1 }).limit(5),
                    User.find({ registered: true, popularity: { $gt: 0 } }).sort({ popularity: -1 }).limit(5)
                ]);
                
                // ë ˆë²¨ ë­í‚¹ í¬ë§·
                let levelText = '';
                levelRanking.forEach((user, index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                    levelText += `${medal} **${user.nickname}** - Lv.${user.level} (${user.exp}/${user.level * 100})\n`;
                });
                
                // ê³¨ë“œ ë­í‚¹ í¬ë§·
                let goldText = '';
                goldRanking.forEach((user, index) => {
                    const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                    goldText += `${medal} **${user.nickname}** - ${user.gold.toLocaleString()}${goldEmoji}\n`;
                });
                
                // ì¸ê¸°ë„ ë­í‚¹ í¬ë§·
                let popularityText = '';
                if (popularityRanking.length === 0) {
                    popularityText = 'ì•„ì§ ì¸ê¸°ë„ë¥¼ ê°€ì§„ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.';
                } else {
                    popularityRanking.forEach((user, index) => {
                        const medal = index === 0 ? 'ğŸ‘‘' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`;
                        const crown = index === 0 ? ' (ì¸ê¸°ì™•)' : '';
                        popularityText += `${medal} **${user.nickname}** - ì¸ê¸°ë„ ${user.popularity}${crown}\n`;
                    });
                }
                
                const rankingEmbed = new EmbedBuilder()
                    .setColor('#daa520')
                    .setTitle('ğŸ† ì „ì²´ ë­í‚¹')
                    .setDescription('ê° ë¶„ì•¼ì˜ ìµœê°•ìë“¤ì„ í™•ì¸í•´ë³´ì„¸ìš”!')
                    .addFields(
                        { name: 'â­ ë ˆë²¨ ë­í‚¹ TOP 5', value: levelText || 'ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', inline: false },
                        { name: 'ğŸ’° ê³¨ë“œ ë­í‚¹ TOP 5', value: goldText || 'ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', inline: false },
                        { name: 'â¤ï¸ ì¸ê¸°ë„ ë­í‚¹ TOP 5', value: popularityText, inline: false }
                    )
                    .setFooter({ text: 'ë­í‚¹ì€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤!' })
                    .setTimestamp();
                    
                await interaction.reply({ embeds: [rankingEmbed], ephemeral: true });
            } catch (error) {
                console.error('ë­í‚¹ ì¡°íšŒ ì˜¤ë¥˜:', error);
                await interaction.reply({ content: 'ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
            }
        }
        
        else if (interaction.customId === 'daily') {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            // í…ŒìŠ¤íŠ¸ìš©: ì¿¨íƒ€ì„ ì œê±°
            // if (user.lastDaily === today) {
            //     await interaction.reply({ content: 'ì˜¤ëŠ˜ì€ ì´ë¯¸ ì¶œì„ì²´í¬ë¥¼ í–ˆìŠµë‹ˆë‹¤!', ephemeral: true });
            //     return;
            // }

            // ì—°ì† ì¶œì„ ì²´í¬
            if (user.lastDaily === yesterday) {
                user.attendanceStreak += 1;
            } else {
                user.attendanceStreak = 1;
            }

            // ì£¼ê°„ ì¶œì„ ì²´í¬ (ì£¼ ì‹œì‘ ì²´í¬)
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay()); // ì¼ìš”ì¼ ì‹œì‘
            weekStart.setHours(0, 0, 0, 0);
            
            if (!user.weekStart || user.weekStart < weekStart) {
                user.weeklyAttendance = [false, false, false, false, false, false, false];
                user.weekStart = weekStart;
            }
            
            user.weeklyAttendance[now.getDay()] = true;

            // ì´ë¯¸ì§€ ì²¨ë¶€
            const dailyAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_daily.gif'), { name: 'kim_daily.gif' });

            // ë³´ìƒ ì˜µì…˜ë“¤
            const rewards = [
                { name: 'ğŸ’° 500G', gold: 500, exp: 0, item: null },
                { name: 'ğŸ’° 1000G', gold: 1000, exp: 0, item: null },
                { name: 'ğŸ’° 2000G', gold: 2000, exp: 0, item: null },
                { name: 'âœ¨ ê²½í—˜ì¹˜ ë¶€ìŠ¤í„°', gold: 0, exp: 500, item: null },
                { name: 'ğŸ ë¯¸ìŠ¤í„°ë¦¬ ë°•ìŠ¤', gold: 1500, exp: 100, item: 'mystery_box' }
            ];

            // ì´ˆê¸° ë£°ë › í‘œì‹œ
            const rouletteEmbed = new EmbedBuilder()
                .setColor('#ffaa00')
                .setTitle('ğŸ¡ ì¶œì„ ì²´í¬ ë³´ìƒ ëŒë ¤ëŒë ¤ ëŒë¦¼íŒ!')
                .setDescription(`**${user.nickname || interaction.user.username}**ë‹˜ì˜ ì¶œì„ ì²´í¬!\\n\\nì—°ì† ì¶œì„: **${user.attendanceStreak}ì¼** ğŸ”¥`)
                .addFields(
                    { name: 'ì£¼ê°„ ì¶œì„ í˜„í™©', value: `${user.weeklyAttendance.map((attended, i) => {
                        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                        return attended ? `${days[i]}âœ…` : `${days[i]}âŒ`;
                    }).join(' ')} (${user.weeklyAttendance.filter(x => x).length}/7)`, inline: false },
                )
                .setImage('attachment://kim_daily.gif')
                .setFooter({ text: 'ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ëŒë¦¼íŒì„ ëŒë¦¬ì„¸ìš”!' });

            const row = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('spin_roulette')
                        .setLabel('ğŸ¡ ëŒë¦¼íŒ ëŒë¦¬ê¸°!')
                        .setStyle(ButtonStyle.Primary)
                );

            await interaction.reply({ embeds: [rouletteEmbed], components: [row], files: [dailyAttachment], ephemeral: true });
        }
        
        else if (interaction.customId === 'spin_roulette') {
            // ë¨¼ì € ì‘ë‹µ ì§€ì—° ì²˜ë¦¬
            await interaction.deferUpdate();
            
            // ëŒë¦¼íŒ ì• ë‹ˆë©”ì´ì…˜
            const rewards = [
                { name: 'ğŸ’° 500G + âœ¨ 100EXP', gold: 500, exp: 100 },
                { name: 'ğŸ’° 1000G + âœ¨ 200EXP', gold: 1000, exp: 200 },
                { name: 'ğŸ’° 1500G + âœ¨ 300EXP', gold: 1500, exp: 300 },
                { name: 'ğŸ’° 2000G + âœ¨ 400EXP', gold: 2000, exp: 400 },
                { name: 'ğŸ’° 2500G + âœ¨ 500EXP', gold: 2500, exp: 500 }
            ];

            const selectedReward = rewards[Math.floor(Math.random() * rewards.length)];
            const rewardIndex = rewards.indexOf(selectedReward);

            // ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ë“¤
            const frames = [
                'â“ ğŸ â“ â“ â“',
                'â“ â“ ğŸ â“ â“',
                'â“ â“ â“ ğŸ â“',
                'â“ â“ â“ â“ ğŸ',
                'ğŸ â“ â“ â“ â“'
            ];

            // ìµœì¢… ê²°ê³¼ í”„ë ˆì„
            const finalFrame = rewards.map((r, i) => i === rewardIndex ? 'ğŸ‰' : 'âŒ').join(' ');

            // 1ë‹¨ê³„: ëŒë¦¬ëŠ” ì¤‘ GIF
            const turntableAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_turntable.gif'), { name: 'kim_turntable.gif' });

            // GIFì™€ í•¨ê»˜ ëŒë¦¼íŒ ì‹œì‘ í‘œì‹œ
            const gifEmbed = new EmbedBuilder()
                .setColor('#ffaa00')
                .setTitle('ğŸ¡ ëŒë¦¼íŒ ëŒë¦¬ëŠ” ì¤‘...')
                .setDescription(`ì—°ì† ì¶œì„: **${user.attendanceStreak}ì¼** ğŸ”¥`)
                .setImage('attachment://kim_turntable.gif');

            await interaction.editReply({ embeds: [gifEmbed], components: [], files: [turntableAttachment] });
            
            // GIF ì¬ìƒ ì‹œê°„ (4ì´ˆ)
            await new Promise(resolve => setTimeout(resolve, 4000));

            // ìµœì¢… ê²°ê³¼ í‘œì‹œ
            user.gold += selectedReward.gold;
            user.exp += selectedReward.exp;
            user.lastDaily = new Date().toDateString();
            
            // ë ˆë²¨ì—… ì²´í¬
            const { leveledUp, levelsGained, oldLevel } = processLevelUp(user);
            
            // ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤
            let streakBonus = '';
            if (user.attendanceStreak >= 7) {
                const bonusGold = 1000;
                user.gold += bonusGold;
                streakBonus = `\\nğŸ”¥ **7ì¼ ì—°ì† ì¶œì„ ë³´ë„ˆìŠ¤**: +${bonusGold}G`;
            }
            
            // ì£¼ê°„ ë¯¸ì…˜ ì™„ë£Œ ì²´í¬
            let weeklyBonus = '';
            if (user.weeklyAttendance.filter(x => x).length === 7) {
                const weeklyGold = 5000;
                user.gold += weeklyGold;
                weeklyBonus = `\\nğŸ† **ì£¼ê°„ ë¯¸ì…˜ ì™„ë£Œ**: +${weeklyGold}G`;
            }
            
            await user.save();

            // 3ë‹¨ê³„: ë³´ìƒ ê°•ë„ì— ë”°ë¥¸ ê°ì • ë©˜íŠ¸ì™€ ê²°ê³¼ í‘œì‹œ
            const resultAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_turntable2.gif'), { name: 'kim_turntable2.gif' });
            
            // ë³´ìƒ ê°•ë„ë³„ ê°ì • ë©˜íŠ¸ ì„¤ì •
            let emotionTitle = '';
            let emotionDescription = '';
            let embedColor = '';
            
            // ë ˆë²¨ì—… ë©”ì‹œì§€ ì¶”ê°€
            const levelUpMessage = leveledUp ? `\n\nğŸ‰ **ë ˆë²¨ì—…!** Lv.${oldLevel} â†’ Lv.${user.level}` : '';
            
            if (selectedReward.gold >= 2000) {
                // ìµœê³  ë³´ìƒ
                emotionTitle = 'ğŸš€ ëŒ€ë°•!! ìµœê³ ì˜ ìš´ì´êµ°ìš”!';
                emotionDescription = `ì™€! **${selectedReward.name}**ì„ ë‹¹ì²¨ì‹œí‚¤ë‹¤ë‹ˆ! ì •ë§ ëŒ€ë‹¨í•´ìš”! ì˜¤ëŠ˜ì€ ë¶„ëª… ì¢‹ì€ ì¼ì´ ê°€ë“í•  ê±°ì˜ˆìš”! âœ¨${levelUpMessage}${streakBonus}${weeklyBonus}`;
                embedColor = '#ffd700'; // ê¸ˆìƒ‰
            } else if (selectedReward.gold >= 1500) {
                // ë†’ì€ ë³´ìƒ
                emotionTitle = 'ğŸ‰ í›Œë¥­í•´ìš”! ì¢‹ì€ ë³´ìƒì´ë„¤ìš”!';
                emotionDescription = `**${selectedReward.name}** ë‹¹ì²¨! ì˜¤ëŠ˜ ìš´ì´ ì¢‹ìœ¼ì‹œë„¤ìš”! ê³„ì† ì´ëŸ° í–‰ìš´ì´ ì´ì–´ì§€ê¸¸ ë°”ë¼ìš”! ğŸ˜Š${levelUpMessage}${streakBonus}${weeklyBonus}`;
                embedColor = '#ff6b6b'; // ë¹¨ê°„ìƒ‰
            } else if (selectedReward.gold >= 1000) {
                // ì¤‘ê°„ ë³´ìƒ
                emotionTitle = 'â­ ì¢‹ì€ ê²°ê³¼ì˜ˆìš”!';
                emotionDescription = `**${selectedReward.name}** ë‹¹ì²¨! ê¾¸ì¤€í•œ ì„±ì¥ê³¼ ê³¨ë“œ íšë“ì´ë„¤ìš”! ğŸ’ª${levelUpMessage}${streakBonus}${weeklyBonus}`;
                embedColor = '#9b59b6'; // ë³´ë¼ìƒ‰
            } else {
                // ì¼ë°˜ ë³´ìƒ
                emotionTitle = 'ğŸ˜Š ì¢‹ì€ ì‹œì‘ì´ì—ìš”!';
                emotionDescription = `**${selectedReward.name}** ë‹¹ì²¨! ê¾¸ì¤€íˆ ëª¨ìœ¼ë©´ í° í˜ì´ ë  ê±°ì˜ˆìš”! ë§¤ì¼ë§¤ì¼ ì¶œì„í•´ì„œ ë” í° ë³´ìƒì„ ë…¸ë ¤ë´ìš”! ğŸ¯${levelUpMessage}${streakBonus}${weeklyBonus}`;
                embedColor = '#3498db'; // íŒŒë€ìƒ‰
            }
            
            const resultEmbed = new EmbedBuilder()
                .setColor(embedColor)
                .setTitle(emotionTitle)
                .setDescription(emotionDescription)
                .addFields(
                    { name: 'ğŸ’° íšë“ ë‚´ì—­', value: `ê³¨ë“œ: +${selectedReward.gold.toLocaleString()}<:currency_emoji:1377404064316522778>\nê²½í—˜ì¹˜: +${selectedReward.exp} EXP`, inline: true },
                    { name: '<:currency_emoji:1377404064316522778> í˜„ì¬ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                    { name: 'ğŸ”¥ ì—°ì† ì¶œì„', value: `${user.attendanceStreak}ì¼`, inline: true }
                )
                .setImage('attachment://kim_turntable2.gif')
                .setFooter({ text: 'ë‚´ì¼ë„ ìŠì§€ ë§ê³  ì¶œì„ì²´í¬ í•´ì£¼ì„¸ìš”!' });

            const backButton = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('back_to_game_menu')
                        .setLabel('ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°')
                        .setStyle(ButtonStyle.Secondary)
                );

            await interaction.editReply({ embeds: [resultEmbed], components: [backButton], files: [resultAttachment] });
        }
        
        // ì‚¬ëƒ¥í„° ì„ íƒ ì²˜ë¦¬
        else if (interaction.customId.startsWith('hunt_area_')) {
            const areaId = parseInt(interaction.customId.split('_')[2]);
            const selectedArea = huntingAreas.find(area => area.id === areaId);
            
            if (!selectedArea) {
                await interaction.reply({ content: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ëƒ¥í„°ì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ì‚¬ëƒ¥ ì‹œì‘ - 3ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤
            // ì‚¬ëƒ¥í„°ë³„ GIF ì„¤ì •
            const huntingGifName = selectedArea.huntingGif || 'kim_hunting.gif'; // ê¸°ë³¸ê°’ ì„¤ì •
            const huntGifAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', huntingGifName), { name: huntingGifName });

            // 1ë‹¨ê³„: ì‚¬ëƒ¥ì¤‘ GIF (2ì´ˆ)
            const huntingMessages = [
                `**${selectedArea.name}**ì—ì„œ ì—´ì‹¬íˆ ì‚¬ëƒ¥ì¤‘ì…ë‹ˆë‹¤...`,
                `**${selectedArea.name}**ì—ì„œ í˜ê²¹ê²Œ ì „íˆ¬ì¤‘ì…ë‹ˆë‹¤...`,
                `**${selectedArea.name}**ì˜ ëª¬ìŠ¤í„°ë“¤ê³¼ ê²©íˆ¬ì¤‘ì…ë‹ˆë‹¤...`,
                `**${selectedArea.name}**ë¥¼ íƒí—˜í•˜ë©° ì‚¬ëƒ¥ì¤‘ì…ë‹ˆë‹¤...`,
                `**${selectedArea.name}**ì—ì„œ ì¹˜ì—´í•œ ì „íˆ¬ë¥¼ ë²Œì´ê³  ìˆìŠµë‹ˆë‹¤...`
            ];
            
            const randomMessage = huntingMessages[Math.floor(Math.random() * huntingMessages.length)];
            
            const huntGifEmbed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle('âš”ï¸ ì‚¬ëƒ¥ì¤‘...')
                .setDescription(`${randomMessage}\n\ní˜„ì¬ ë ˆë²¨: **Lv.${user.level}**`)
                .setImage(`attachment://${huntingGifName}`);
            
            await interaction.update({ embeds: [huntGifEmbed], components: [], files: [huntGifAttachment] });
            
            // 2ì´ˆ ëŒ€ê¸° í›„ ë°”ë¡œ ê²°ê³¼ë¡œ
            await new Promise(resolve => setTimeout(resolve, 2000));

            // ëœë¤ ëª¬ìŠ¤í„° ì„ íƒ (ì‚¬ëƒ¥í„°ì— ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤ë©´ ëª¨ë“  ëª¬ìŠ¤í„° ì‚¬ëƒ¥ ê°€ëŠ¥)
            const availableMonsters = selectedArea.monsters;

            const selectedMonster = availableMonsters[Math.floor(Math.random() * availableMonsters.length)];
            const monsterLevel = Math.floor(Math.random() * (selectedMonster.level[1] - selectedMonster.level[0] + 1)) + selectedMonster.level[0];

            // ì „íˆ¬ë ¥ ê³„ì‚°
            const userPower = calculateCombatPower(user);
            const monsterPower = calculateMonsterPower(selectedMonster, monsterLevel);
            
            // ìŠ¹ë¦¬ í™•ë¥  ê³„ì‚° (ì „íˆ¬ë ¥ ì°¨ì´ì— ë”°ë¼)
            const powerDiff = userPower - monsterPower;
            let winRate = 50; // ê¸°ë³¸ 50%
            
            if (powerDiff > 0) {
                winRate = Math.min(95, 50 + (powerDiff / 10)); // ìµœëŒ€ 95%
            } else {
                winRate = Math.max(5, 50 + (powerDiff / 15)); // ìµœì†Œ 5%
            }
            
            const battleResult = Math.random() * 100 <= winRate;

            // ì „íˆ¬ ê²°ê³¼ ê³„ì‚°
            const baseExp = Math.floor(Math.random() * (selectedMonster.exp[1] - selectedMonster.exp[0] + 1)) + selectedMonster.exp[0];
            const baseGold = Math.floor(Math.random() * (selectedMonster.gold[1] - selectedMonster.gold[0] + 1)) + selectedMonster.gold[0];
            
            // ë ˆë²¨ ì°¨ì´ì— ë”°ë¥¸ ë³´ìƒ ì¡°ì •
            const levelDiff = user.level - monsterLevel;
            let expMultiplier = 1;
            let goldMultiplier = 1;
            
            if (levelDiff > 5) {
                expMultiplier = 0.5; // ë„ˆë¬´ ì‰¬ìš´ ëª¬ìŠ¤í„°
                goldMultiplier = 0.7;
            } else if (levelDiff < -5) {
                expMultiplier = 1.5; // ì–´ë ¤ìš´ ëª¬ìŠ¤í„°
                goldMultiplier = 1.3;
            }

            const finalExp = Math.floor(baseExp * expMultiplier);
            const finalGold = Math.floor(baseGold * goldMultiplier);

            // ë ˆì–´ë„ì— ë”°ë¥¸ ë³´ë„ˆìŠ¤
            let rarityBonus = 1;
            let rarityEmoji = '';
            switch (selectedMonster.rarity) {
                case 'ë ˆì–´':
                    rarityBonus = 1.2;
                    rarityEmoji = 'âœ¨';
                    break;
                case 'ì—í”½':
                    rarityBonus = 1.5;
                    rarityEmoji = 'ğŸŒŸ';
                    break;
                case 'ìœ ë‹ˆí¬':
                    rarityBonus = 2.0;
                    rarityEmoji = 'ğŸ’';
                    break;
                case 'ë ˆì „ë“œ':
                    rarityBonus = 3.0;
                    rarityEmoji = 'ğŸ‘‘';
                    break;
                default:
                    rarityEmoji = 'âš”ï¸';
            }

            user.lastHunt = Date.now();
            
            // GIF íŒŒì¼ ì¤€ë¹„
            const winGifAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_hunting_win.gif'), { name: 'kim_hunting_win.gif' });
            const loseGifAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_hunting_lose.gif'), { name: 'kim_hunting_lose.gif' });
            
            let resultEmbed;
            
            if (battleResult) {
                // ìŠ¹ë¦¬ ì‹œ
                const bonusExp = Math.floor(finalExp * (rarityBonus - 1));
                const bonusGold = Math.floor(finalGold * (rarityBonus - 1));

                // ìœ ì € ë°ì´í„° ì—…ë°ì´íŠ¸
                user.exp += finalExp + bonusExp;
                user.gold += finalGold + bonusGold;

                // ë ˆë²¨ì—… ì²´í¬
                const { leveledUp, levelsGained, oldLevel } = processLevelUp(user);

                await user.save();

                // ê²°ê³¼ ì„ë² ë“œ (ìŠ¹ë¦¬ GIFì™€ í•¨ê»˜)
                const expBar = generateExpBar(user.exp, user.level * 100, 20);
                const powerDiffText = userPower > monsterPower ? 
                    `ğŸ”¥ **ìš°ì„¸** (+${userPower - monsterPower})` : 
                    userPower < monsterPower ? 
                        `âš ï¸ **ì—´ì„¸** (-${monsterPower - userPower})` : 
                        `âš–ï¸ **ë™ë“±**`;
                
                resultEmbed = new EmbedBuilder()
                    .setColor('#00d4aa')
                    .setTitle(`${rarityEmoji} âš”ï¸ ì „íˆ¬ ìŠ¹ë¦¬! âš”ï¸`)
                    .setDescription(`ğŸ¯ **${selectedMonster.name}** Lv.${monsterLevel} ì²˜ì¹˜ ì™„ë£Œ!${leveledUp ? `\n\nğŸ‰ **ë ˆë²¨ì—…!** Lv.${oldLevel} â†’ Lv.${user.level} ğŸ‰` : ''}`)
                    .addFields(
                        { 
                            name: 'âš”ï¸ ì „íˆ¬ ê²°ê³¼', 
                            value: `ğŸ›¡ï¸ ë‚˜ì˜ ì „íˆ¬ë ¥: **${userPower.toLocaleString()}** | âš”ï¸ ì ì˜ ì „íˆ¬ë ¥: **${monsterPower.toLocaleString()}** | ğŸ“Š ìŠ¹ë¦¬ í™•ë¥ : **${winRate.toFixed(1)}%**\n\n${powerDiffText}`, 
                            inline: false 
                        },
                        { 
                            name: 'ğŸ’ ë³´ìƒ', 
                            value: `âœ¨ ê²½í—˜ì¹˜: \`+${finalExp.toLocaleString()} EXP\`${bonusExp > 0 ? ` \`ë³´ë„ˆìŠ¤ +${bonusExp.toLocaleString()}\`` : ''} | ğŸ’° ê³¨ë“œ: \`+${finalGold.toLocaleString()}<:currency_emoji:1377404064316522778>\`${bonusGold > 0 ? ` \`ë³´ë„ˆìŠ¤ +${bonusGold.toLocaleString()}<:currency_emoji:1377404064316522778>\`` : ''}`, 
                            inline: false 
                        },
                        { 
                            name: 'ğŸ“Š í˜„ì¬ ìƒíƒœ', 
                            value: `ğŸ† ë ˆë²¨: \`Lv.${user.level}\` | âœ¨ ê²½í—˜ì¹˜: \`${user.exp}/${user.level * 100} EXP\` | ğŸ’° ê³¨ë“œ: \`${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>\``, 
                            inline: false 
                        }
                    )
                    .setImage('attachment://kim_hunting_win.gif')
            } else {
                // íŒ¨ë°° ì‹œ
                const defeatMessages = [
                    "ì•„ì´í…œì„ ê°•í™”í•´ì„œ ì´ê¸°ì!",
                    "ë” ê°•í•´ì ¸ì„œ ë‹¤ì‹œ ë„ì „í•˜ì!",
                    "ì¥ë¹„ë¥¼ ì—…ê·¸ë ˆì´ë“œí•˜ê³  ë³µìˆ˜í•˜ì!",
                    "ë ˆë²¨ì—…ì„ í•˜ê³  ë‹¤ì‹œ ì‹¸ìš°ì!",
                    "ëŠ¥ë ¥ì¹˜ë¥¼ ì˜¬ë¦¬ê³  ì¬ë„ì „í•˜ì!",
                    "ë” ì¢‹ì€ ë¬´ê¸°ê°€ í•„ìš”í•´ ë³´ì¸ë‹¤!",
                    "ë°©ì–´êµ¬ë¥¼ ê°•í™”í•˜ê³  ë‹¤ì‹œ ì˜¤ì!",
                    "ì „íˆ¬ë ¥ì„ í‚¤ì›Œì„œ ë³µìˆ˜í•˜ì!",
                    "ìŠ¤í‚¬ì„ ë°°ì›Œì„œ ë‹¤ì‹œ ë„ì „í•˜ì!",
                    "ë” ë§ì€ ê²½í—˜ì´ í•„ìš”í•´ ë³´ì¸ë‹¤!"
                ];
                
                const randomDefeatMessage = defeatMessages[Math.floor(Math.random() * defeatMessages.length)];
                
                // ë²Œê¸ˆ ê³„ì‚° (ëª¬ìŠ¤í„° ë“œë ê³¨ë“œì˜ 1~10ë°°)
                const penalty = Math.floor(Math.random() * 10 + 1) * baseGold;
                const actualPenalty = Math.min(penalty, user.gold); // ë³´ìœ  ê³¨ë“œë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŒ
                
                user.gold = Math.max(0, user.gold - actualPenalty);
                await user.save();

                // ê²°ê³¼ ì„ë² ë“œ (íŒ¨ë°° GIFì™€ í•¨ê»˜)
                const expBarDefeat = generateExpBar(user.exp, user.level * 100, 20);
                const powerDiffTextDefeat = userPower > monsterPower ? 
                    `ğŸ”¥ **ìš°ì„¸ì˜€ì§€ë§Œ** (+${userPower - monsterPower})` : 
                    userPower < monsterPower ? 
                        `âš ï¸ **ì—´ì„¸** (-${monsterPower - userPower})` : 
                        `âš–ï¸ **ë™ë“±í–ˆì§€ë§Œ**`;
                
                resultEmbed = new EmbedBuilder()
                    .setColor('#ff4757')
                    .setTitle(`ğŸ’¥ âš”ï¸ ì „íˆ¬ íŒ¨ë°°... âš”ï¸`)
                    .setDescription(`ğŸ˜ **${selectedMonster.name}** Lv.${monsterLevel} ì—ê²Œ íŒ¨ë°°...\n\nğŸ’­ **"${randomDefeatMessage}"**`)
                    .addFields(
                        { 
                            name: 'âš”ï¸ ì „íˆ¬ ê²°ê³¼', 
                            value: `ğŸ›¡ï¸ ë‚˜ì˜ ì „íˆ¬ë ¥: **${userPower.toLocaleString()}** | âš”ï¸ ì ì˜ ì „íˆ¬ë ¥: **${monsterPower.toLocaleString()}** | ğŸ“Š ìŠ¹ë¦¬ í™•ë¥ : **${winRate.toFixed(1)}%**\n\n${powerDiffTextDefeat}`, 
                            inline: false 
                        },
                        { 
                            name: 'ğŸ’¸ ì†ì‹¤', 
                            value: `ğŸ’° ë²Œê¸ˆ: \`-${actualPenalty.toLocaleString()}<:currency_emoji:1377404064316522778>\` | âŒ ëª¬ìŠ¤í„° ë“œë ê³¨ë“œì˜ **${Math.floor(actualPenalty/baseGold)}ë°°** ì†ì‹¤`, 
                            inline: false 
                        },
                        { 
                            name: 'ğŸ“Š í˜„ì¬ ìƒíƒœ', 
                            value: `ğŸ† ë ˆë²¨: \`Lv.${user.level}\` | âœ¨ ê²½í—˜ì¹˜: \`${user.exp}/${user.level * 100} EXP\` | ğŸ’° ê³¨ë“œ: \`${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>\``, 
                            inline: false 
                        },
                        { 
                            name: 'ğŸ’¡ ë‹¤ìŒ ë„ì „ì„ ìœ„í•œ ì¡°ì–¸', 
                            value: `ğŸ¯ ${randomDefeatMessage}\n\nğŸ”§ **ì¶”ì²œ ê°•í™” ë°©ë²•**\nğŸ“ˆ ëŠ¥ë ¥ì¹˜ í¬ì¸íŠ¸ íˆ¬ì\nâš”ï¸ ì¥ë¹„ ê°•í™” ë° êµì²´\nğŸ†™ ë ˆë²¨ì—…ìœ¼ë¡œ ê¸°ë³¸ ëŠ¥ë ¥ì¹˜ ì¦ê°€`, 
                            inline: false 
                        }
                    )
                    .setImage('attachment://kim_hunting_lose.gif')
            }

            const continueButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`hunt_area_${areaId}`)
                        .setLabel('ğŸ”„ ê³„ì† ì‚¬ëƒ¥')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('hunting')
                        .setLabel('ğŸ—ºï¸ ì‚¬ëƒ¥í„° ë³€ê²½')
                        .setStyle(ButtonStyle.Secondary),
                    new ButtonBuilder()
                        .setCustomId('back_to_game_menu')
                        .setLabel('ğŸ® ê²Œì„ ë©”ë‰´')
                        .setStyle(ButtonStyle.Success)
                );

            await interaction.editReply({ 
                embeds: [resultEmbed], 
                components: [continueButtons], 
                files: battleResult ? [winGifAttachment] : [loseGifAttachment]
            });
        }
        
        else if (interaction.customId === 'work') {
            const cooldown = 30 * 60 * 1000; // 30ë¶„ ì¿¨íƒ€ì„
            
            if (now - user.lastWork < cooldown) {
                const remaining = Math.ceil((cooldown - (now - user.lastWork)) / 60000);
                await interaction.reply({ content: `ì¿¨íƒ€ì„ ${remaining}ë¶„ ë‚¨ì•˜ìŠµë‹ˆë‹¤!`, ephemeral: true });
                return;
            }

            const goldReward = Math.floor(Math.random() * 300) + 200; // 200-500ê³¨ë“œ
            const expReward = Math.floor(Math.random() * 50) + 25; // 25-75ê²½í—˜ì¹˜
            
            user.gold += goldReward;
            user.exp += expReward;
            user.lastWork = now;
            
            // ë ˆë²¨ì—… ì²´í¬
            const { leveledUp, levelsGained, oldLevel } = processLevelUp(user);
            
            await user.save();

            const levelUpMessage = leveledUp ? `\n\nğŸ‰ **ë ˆë²¨ì—…!** Lv.${oldLevel} â†’ Lv.${user.level}` : '';

            const embed = new EmbedBuilder()
                .setColor('#0099ff')
                .setTitle('ì¼í•˜ê¸° ì™„ë£Œ!')
                .setDescription(`ì—´ì‹¬íˆ ì¼í•´ì„œ ê³¨ë“œì™€ ê²½í—˜ì¹˜ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤!${levelUpMessage}`)
                .addFields(
                    { name: 'íšë“ ê³¨ë“œ', value: `+${goldReward.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                    { name: 'íšë“ ê²½í—˜ì¹˜', value: `+${expReward} EXP`, inline: true },
                    { name: 'í˜„ì¬ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true }
                );

            await interaction.reply({ embeds: [embed], ephemeral: true });
        }
        
        else if (interaction.customId === 'info') {
            const maxExp = user.level * 100;
            const embed = new EmbedBuilder()
                .setColor('#9932cc')
                .setTitle('ë‚´ ì •ë³´')
                .setDescription(`**${user.nickname}**ë‹˜ì˜ ê²Œì„ ì •ë³´`)
                .addFields(
                    { name: 'ë ˆë²¨', value: `Lv.${user.level}`, inline: true },
                    { name: 'ê²½í—˜ì¹˜', value: `${user.exp}/${maxExp} EXP`, inline: true },
                    { name: 'ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                    { name: 'ì¸ê¸°ë„', value: `${user.popularity} ${user.popularity > 0 ? 'â¤ï¸' : user.popularity < 0 ? 'ğŸ’”' : ''}`, inline: true },
                    { name: 'ì¶œì„ì²´í¬', value: user.lastDaily === new Date().toDateString() ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ', inline: true },
                    { name: 'ì¼í•˜ê¸°', value: now - user.lastWork < 30 * 60 * 1000 ? 'ì¿¨íƒ€ì„' : 'ê°€ëŠ¥', inline: true },
                    { name: 'ì—°ì† ì¶œì„', value: `${user.attendanceStreak || 0}ì¼ ğŸ”¥`, inline: true },
                    { name: 'ì£¼ê°„ ì¶œì„', value: `${user.weeklyAttendance ? user.weeklyAttendance.filter(x => x).length : 0}/7ì¼`, inline: true }
                );

            await interaction.reply({ embeds: [embed], ephemeral: true });
        }
        
        else if (interaction.customId === 'stats') {
            const totalStats = user.stats.strength + user.stats.agility + user.stats.intelligence + user.stats.vitality + user.stats.luck;
            
            const statsEmbed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle('ğŸ’ª ëŠ¥ë ¥ì¹˜')
                .setDescription(`**${user.nickname}**ë‹˜ì˜ ëŠ¥ë ¥ì¹˜ ì •ë³´`)
                .addFields(
                    { name: 'ğŸ’ª í˜', value: `${user.stats.strength}`, inline: true },
                    { name: 'ğŸƒ ë¯¼ì²©', value: `${user.stats.agility}`, inline: true },
                    { name: 'ğŸ§  ì§€ëŠ¥', value: `${user.stats.intelligence}`, inline: true },
                    { name: 'â¤ï¸ ì²´ë ¥', value: `${user.stats.vitality}`, inline: true },
                    { name: 'ğŸ€ í–‰ìš´', value: `${user.stats.luck}`, inline: true },
                    { name: 'ğŸ“Š ì´í•©', value: `${totalStats}`, inline: true },
                    { name: 'â­ ë³´ìœ  ìŠ¤íƒ¯í¬ì¸íŠ¸', value: `${user.statPoints}ì `, inline: false }
                )
                .setFooter({ text: 'ë ˆë²¨ì—… ì‹œ ìŠ¤íƒ¯í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤!' });

            const statButtons = new ActionRowBuilder();
            
            if (user.statPoints > 0) {
                statButtons.addComponents(
                    new ButtonBuilder()
                        .setCustomId('add_strength')
                        .setLabel('ğŸ’ª í˜ +1')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('add_agility')
                        .setLabel('ğŸƒ ë¯¼ì²© +1')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('add_intelligence')
                        .setLabel('ğŸ§  ì§€ëŠ¥ +1')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('add_vitality')
                        .setLabel('â¤ï¸ ì²´ë ¥ +1')
                        .setStyle(ButtonStyle.Primary)
                );
            } else {
                statButtons.addComponents(
                    new ButtonBuilder()
                        .setCustomId('stats_info')
                        .setLabel('ìŠ¤íƒ¯í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true)
                );
            }

            await interaction.reply({ 
                embeds: [statsEmbed], 
                components: user.statPoints > 0 ? [statButtons] : [statButtons],
                ephemeral: true 
            });
        }
        
        else if (interaction.customId === 'skills') {
            const skillsEmbed = new EmbedBuilder()
                .setColor('#4ecdc4')
                .setTitle('ğŸ”® ìŠ¤í‚¬')
                .setDescription(`**${user.nickname}**ë‹˜ì˜ ìŠ¤í‚¬ ì •ë³´`)
                .addFields(
                    { name: 'ğŸ“š ë³´ìœ  ìŠ¤í‚¬', value: user.skills.length > 0 ? user.skills.map(skill => `**${skill.name}** Lv.${skill.level}`).join('\n') : 'ë³´ìœ í•œ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤.', inline: false },
                    { name: 'ğŸ’¡ ìŠ¤í‚¬ íšë“', value: 'íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ìƒˆë¡œìš´ ìŠ¤í‚¬ì„ ìŠµë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!', inline: false }
                )
                .setFooter({ text: 'ìŠ¤í‚¬ì€ ì „íˆ¬ì™€ í™œë™ì—ì„œ ë„ì›€ì„ ì¤ë‹ˆë‹¤!' });

            await interaction.reply({ embeds: [skillsEmbed], ephemeral: true });
        }
        
        else if (interaction.customId.startsWith('add_')) {
            const statType = interaction.customId.replace('add_', '');
            
            if (user.statPoints <= 0) {
                await interaction.reply({ content: 'ìŠ¤íƒ¯í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            user.stats[statType] += 1;
            user.statPoints -= 1;
            await user.save();
            
            const statNames = {
                strength: 'ğŸ’ª í˜',
                agility: 'ğŸƒ ë¯¼ì²©', 
                intelligence: 'ğŸ§  ì§€ëŠ¥',
                vitality: 'â¤ï¸ ì²´ë ¥',
                luck: 'ğŸ€ í–‰ìš´'
            };
            
            await interaction.reply({ 
                content: `${statNames[statType]}ì´ 1 ì¦ê°€í–ˆìŠµë‹ˆë‹¤! (${user.stats[statType]-1} â†’ ${user.stats[statType]})`, 
                ephemeral: true 
            });
        }
        
        else if (interaction.customId === 'shop') {
            const shopMainAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_shop_main.gif'), { name: 'kim_shop_main.gif' });
            
            const shopEmbed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle('ğŸ›’ ê¹€í—Œí„° ìƒì ')
                .setDescription(`**${user.nickname}** ëª¨í—˜ê°€ë‹˜, ì´ ë³´ìœ ê¸ˆì•¡ì€ **${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>**ì…ë‹ˆë‹¤.\n\nì›í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì—¬ ì•„ì´í…œì„ êµ¬ë§¤í•˜ì„¸ìš”!`)
                .setImage('attachment://kim_shop_main.gif');

            const categorySelect = new ActionRowBuilder()
                .addComponents(
                    new StringSelectMenuBuilder()
                        .setCustomId('shop_category')
                        .setPlaceholder('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”')
                        .addOptions([
                            {
                                label: 'ë¬´ê¸°',
                                description: 'ê²€, ë„ë¼, í™œ, ì§€íŒ¡ì´ ë“±',
                                value: 'weapon',
                                emoji: 'âš”ï¸'
                            },
                            {
                                label: 'í—¬ë©§',
                                description: 'íˆ¬êµ¬, ëª¨ì, ë¨¸ë¦¬ë  ë“±',
                                value: 'helmet',
                                emoji: 'â›‘ï¸'
                            },
                            {
                                label: 'ê°‘ì˜·',
                                description: 'ê°‘ì˜·, ë¡œë¸Œ, ì˜ë³µ ë“±',
                                value: 'armor',
                                emoji: 'ğŸ›¡ï¸'
                            },
                            {
                                label: 'ì¥ê°‘',
                                description: 'ì¥ê°‘, íŒ”ì°Œ, ì†ëª©ë³´í˜¸ëŒ€ ë“±',
                                value: 'gloves',
                                emoji: 'ğŸ§¤'
                            },
                            {
                                label: 'ì‹ ë°œ',
                                description: 'ë¶€ì¸ , ì‹ ë°œ, ë°œëª©ë³´í˜¸ëŒ€ ë“±',
                                value: 'boots',
                                emoji: 'ğŸ‘¢'
                            },
                            {
                                label: 'ì†Œë¹„',
                                description: 'í¬ì…˜, ìŠ¤í¬ë¡¤, ë²„í”„ì•„ì´í…œ ë“±',
                                value: 'consumable',
                                emoji: 'ğŸ’Š'
                            },
                            {
                                label: 'ì£¼ë¬¸ì„œ',
                                description: 'ê°•í™”ì„, ê°•í™” ì¬ë£Œ ë“±',
                                value: 'enhancement',
                                emoji: 'âš’ï¸'
                            },
                            {
                                label: 'ì½”ì¸',
                                description: 'íŠ¹ë³„í•œ ì½”ì¸ê³¼ ì¬í™”',
                                value: 'coin',
                                emoji: 'ğŸª™'
                            }
                        ])
                );

            const backButton = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('back_to_game_menu')
                        .setLabel('ğŸ® ê²Œì„ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°')
                        .setStyle(ButtonStyle.Success)
                );

            await interaction.reply({ 
                embeds: [shopEmbed], 
                components: [categorySelect, backButton], 
                files: [shopMainAttachment],
                flags: [64] // InteractionResponseFlags.Ephemeral
            });
        }
        
        else if (interaction.customId === 'shop_category') {
            const selectedCategory = interaction.values[0];
            
            // ì „ì—­ ìƒì  ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì‚¬ìš©
            const categoryData = SHOP_CATEGORIES[selectedCategory];
            if (!categoryData) {
                await interaction.update({ content: 'í•´ë‹¹ ì¹´í…Œê³ ë¦¬ëŠ” ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!', embeds: [], components: [] });
                return;
            }
            
            // ì¹´í…Œê³ ë¦¬ ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ ìƒì„±
            const categoryAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', categoryData.gif), { name: categoryData.gif });
            
            // ë“±ê¸‰ë³„ ì»¤ìŠ¤í…€ ì´ëª¨ì§€
            const rarityEmojis = {
                'ì¼ë°˜': '<:common_emoji:1381597953072037909>',
                'ê³ ê¸‰': '<:uncomon_emoji:1381598058327838752>',
                'ë ˆì–´': '<:rare_emoji:1381598053974278154>',
                'ì—í”½': '<:epic_emoji:1381598051046658048>',
                'ë ˆì „ë“œë¦¬': '<:legendary_emoji:1381598048446189589>'
            };
            
            // ê³¨ë“œ ì»¤ìŠ¤í…€ ì´ëª¨ì§€
            const goldEmoji = '<:currency_emoji:1377404064316522778>';
            
            // Use the global category data
            const category = categoryData;
            if (!category) {
                await interaction.update({ content: 'í•´ë‹¹ ì¹´í…Œê³ ë¦¬ëŠ” ì•„ì§ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤!', embeds: [], components: [] });
                return;
            }
            
            // í˜ì´ì§€ë³„ ë“±ê¸‰ ì •ì˜
            const pageRarities = {
                0: ['ì¼ë°˜', 'ê³ ê¸‰', 'ë ˆì–´'],        // 1í˜ì´ì§€
                1: ['ì—í”½', 'ë ˆì „ë“œë¦¬']           // 2í˜ì´ì§€
            };
            
            const totalPages = 2; // ê³ ì • 2í˜ì´ì§€
            const currentPage = 0; // ì²« í˜ì´ì§€ë¶€í„° ì‹œì‘

            // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë“±ê¸‰ë“¤ì˜ ì•„ì´í…œë§Œ í•„í„°ë§
            const currentPageRarities = pageRarities[currentPage];
            const currentItems = category.items.filter(item => 
                currentPageRarities.includes(item.rarity)
            );

            // ë“±ê¸‰ë³„ë¡œ ì•„ì´í…œ ê·¸ë£¹í™”
            const itemsByRarity = {};
            currentItems.forEach(item => {
                if (!itemsByRarity[item.rarity]) {
                    itemsByRarity[item.rarity] = [];
                }
                itemsByRarity[item.rarity].push(item);
            });

            // ë“±ê¸‰ ìˆœì„œ ì •ì˜
            const rarityOrder = ['ë…¸ë©€', 'ë ˆì–´', 'ì—í”½', 'ë ˆì „ë“œë¦¬', 'ìœ ë‹ˆí¬'];
            
            // í˜„ì¬ í˜ì´ì§€ì˜ ë“±ê¸‰ë“¤ë§Œ í‘œì‹œ
            let itemList = '';
            currentPageRarities.forEach(rarity => {
                if (itemsByRarity[rarity] && itemsByRarity[rarity].length > 0) {
                    itemList += `${rarityEmojis[rarity]} **${rarity}**\n`;
                    itemsByRarity[rarity].forEach(item => {
                        itemList += `\`${item.name}\` - ${item.price.toLocaleString()}${goldEmoji}\n`;
                    });
                    itemList += '\n'; // ë“±ê¸‰ ê°„ êµ¬ë¶„ì„ ìœ„í•œ ë¹ˆ ì¤„
                }
            });
            
            const categoryEmbed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle(`${category.emoji} ${category.name} ìƒì `)
                .setDescription(`${category.name} ì¹´í…Œê³ ë¦¬ì˜ ì•„ì´í…œë“¤ì…ë‹ˆë‹¤.\n\n${itemList}`)
                .setThumbnail(`attachment://${categoryData.gif}`)
                .setFooter({ text: `í˜ì´ì§€ ${currentPage + 1}/${totalPages} | ì•„ì´í…œì„ í´ë¦­í•˜ì—¬ êµ¬ë§¤í•˜ì„¸ìš”!` });
            
            // ë“±ê¸‰ë³„ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì •
            const getRarityButtonStyle = (rarity) => {
                switch(rarity) {
                    case 'ì¼ë°˜': return ButtonStyle.Secondary; // íšŒìƒ‰
                    case 'ê³ ê¸‰': return ButtonStyle.Primary;   // íŒŒë€ìƒ‰
                    case 'ë ˆì–´': return ButtonStyle.Danger;    // ë¹¨ê°„ìƒ‰
                    case 'ì—í”½': return ButtonStyle.Success; // ì´ˆë¡ìƒ‰
                    case 'ë ˆì „ë“œë¦¬': return ButtonStyle.Danger; // ë¹¨ê°„ìƒ‰
                    default: return ButtonStyle.Secondary;
                }
            };

            // ì•„ì´í…œ êµ¬ë§¤ ë²„íŠ¼ë“¤ (3ê°œì”© 3ì¤„)
            const itemButtons = [];
            for (let i = 0; i < currentItems.length; i += 3) {
                const row = new ActionRowBuilder();
                const rowItems = currentItems.slice(i, i + 3);
                
                rowItems.forEach((item, index) => {
                    // ì „ì²´ ì•„ì´í…œ ë°°ì—´ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const actualIndex = category.items.findIndex(categoryItem => 
                        categoryItem.name === item.name && categoryItem.rarity === item.rarity
                    );
                    row.addComponents(
                        new ButtonBuilder()
                            .setCustomId(`buy_${selectedCategory}_${actualIndex}`)
                            .setLabel(`${item.name}`)
                            .setStyle(getRarityButtonStyle(item.rarity))
                            .setDisabled(user.gold < item.price)
                    );
                });
                
                itemButtons.push(row);
            }

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ (ì‚¬ëƒ¥í„°ì™€ ë™ì¼í•œ ë°©ì‹)
            const navButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`shop_${selectedCategory}_prev_page`)
                        .setLabel('â—€ ì´ì „')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage === 0),
                    new ButtonBuilder()
                        .setCustomId(`shop_${selectedCategory}_page_info`)
                        .setLabel(`${currentPage + 1}/${totalPages}`)
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId(`shop_${selectedCategory}_next_page`)
                        .setLabel('ë‹¤ìŒ â–¶')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage >= totalPages - 1),
                    new ButtonBuilder()
                        .setCustomId('shop')
                        .setLabel('ğŸ”™ ìƒì  ë©”ì¸')
                        .setStyle(ButtonStyle.Primary)
                );

            // ëª¨ë“  ë²„íŠ¼ í•©ì¹˜ê¸°
            const allComponents = [...itemButtons, navButtons];

            await interaction.update({
                embeds: [categoryEmbed],
                components: allComponents,
                files: [categoryAttachment]
            });
        }
        
        else if (interaction.customId.includes('_prev_page') || interaction.customId.includes('_next_page')) {
            // ìƒì  í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
            const parts = interaction.customId.split('_');
            const category = parts[1];
            const direction = parts[2]; // 'prev' ë˜ëŠ” 'next'
            
            // í˜„ì¬ í˜ì´ì§€ ì •ë³´ ì¶”ì¶œ (ì„ë² ë“œì˜ footerì—ì„œ)
            const currentEmbed = interaction.message.embeds[0];
            const footerText = currentEmbed.footer?.text || '';
            const pageMatch = footerText.match(/í˜ì´ì§€ (\d+)\/(\d+)/);
            
            if (!pageMatch) {
                await interaction.reply({ content: 'í˜ì´ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            const currentPage = parseInt(pageMatch[1]) - 1; // 0-based index
            const totalPages = parseInt(pageMatch[2]);
            
            let newPage = currentPage;
            if (direction === 'prev' && currentPage > 0) {
                newPage = currentPage - 1;
            } else if (direction === 'next' && currentPage < totalPages - 1) {
                newPage = currentPage + 1;
            }
            
            // ì „ì—­ ìƒì  ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì‚¬ìš©
            const categoryData = SHOP_CATEGORIES[category];
            if (!categoryData) {
                await interaction.reply({ content: 'ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ì¹´í…Œê³ ë¦¬ ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ ìƒì„±
            const categoryAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', categoryData.gif), { name: categoryData.gif });
            
            // í˜ì´ì§€ ì¬êµ¬ì„± - ë“±ê¸‰ë³„ í•„í„°ë§ ì‚¬ìš©
            const rarityEmojis = {
                'ì¼ë°˜': '<:common_emoji:1381597953072037909>',
                'ê³ ê¸‰': '<:uncomon_emoji:1381598058327838752>',
                'ë ˆì–´': '<:rare_emoji:1381598053974278154>',
                'ì—í”½': '<:epic_emoji:1381598051046658048>',
                'ë ˆì „ë“œë¦¬': '<:legendary_emoji:1381598048446189589>'
            };
            
            // ê³¨ë“œ ì»¤ìŠ¤í…€ ì´ëª¨ì§€
            const goldEmoji = '<:currency_emoji:1377404064316522778>';
            
            // í˜ì´ì§€ë³„ ë“±ê¸‰ ì •ì˜ (ì¹´í…Œê³ ë¦¬ í‘œì‹œì™€ ë™ì¼í•œ ë¡œì§)
            const pageRarities = {
                0: ['ì¼ë°˜', 'ê³ ê¸‰', 'ë ˆì–´'],        // 1í˜ì´ì§€
                1: ['ì—í”½', 'ë ˆì „ë“œë¦¬']           // 2í˜ì´ì§€
            };
            
            // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë“±ê¸‰ë“¤ì˜ ì•„ì´í…œë§Œ í•„í„°ë§
            const currentPageRarities = pageRarities[newPage];
            const currentItems = categoryData.items.filter(item => 
                currentPageRarities.includes(item.rarity)
            );
            
            // ë“±ê¸‰ë³„ë¡œ ì•„ì´í…œ ê·¸ë£¹í™”
            const itemsByRarity = {};
            currentItems.forEach(item => {
                if (!itemsByRarity[item.rarity]) {
                    itemsByRarity[item.rarity] = [];
                }
                itemsByRarity[item.rarity].push(item);
            });
            
            // í˜„ì¬ í˜ì´ì§€ì˜ ë“±ê¸‰ë“¤ë§Œ í‘œì‹œ
            let itemList = '';
            currentPageRarities.forEach(rarity => {
                if (itemsByRarity[rarity] && itemsByRarity[rarity].length > 0) {
                    itemList += `${rarityEmojis[rarity]} **${rarity}**\n`;
                    itemsByRarity[rarity].forEach(item => {
                        itemList += `\`${item.name}\` - ${item.price.toLocaleString()}${goldEmoji}\n`;
                    });
                    itemList += '\n'; // ë“±ê¸‰ ê°„ êµ¬ë¶„ì„ ìœ„í•œ ë¹ˆ ì¤„
                }
            });
            
            const updatedEmbed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle(`${categoryData.emoji} ${categoryData.name} ìƒì `)
                .setDescription(`${categoryData.name} ì¹´í…Œê³ ë¦¬ì˜ ì•„ì´í…œë“¤ì…ë‹ˆë‹¤.\n\n${itemList}`)
                .setThumbnail(`attachment://${categoryData.gif}`)
                .setFooter({ text: `í˜ì´ì§€ ${newPage + 1}/${totalPages} | ì•„ì´í…œì„ í´ë¦­í•˜ì—¬ êµ¬ë§¤í•˜ì„¸ìš”!` });
            
            // ë²„íŠ¼ ì¬êµ¬ì„±
            const getRarityButtonStyle = (rarity) => {
                switch(rarity) {
                    case 'ë…¸ë©€': return ButtonStyle.Secondary;
                    case 'ë ˆì–´': return ButtonStyle.Primary;
                    case 'ì—í”½': return ButtonStyle.Danger;
                    case 'ìœ ë‹ˆí¬': return ButtonStyle.Success;
                    case 'ë ˆì „ë“œë¦¬': return ButtonStyle.Danger;
                    default: return ButtonStyle.Secondary;
                }
            };
            
            const itemButtons = [];
            for (let i = 0; i < currentItems.length; i += 3) {
                const row = new ActionRowBuilder();
                const rowItems = currentItems.slice(i, i + 3);
                
                rowItems.forEach((item, index) => {
                    // ì „ì²´ ì•„ì´í…œ ë°°ì—´ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì°¾ê¸°
                    const actualIndex = categoryData.items.findIndex(categoryItem => 
                        categoryItem.name === item.name && categoryItem.rarity === item.rarity
                    );
                    row.addComponents(
                        new ButtonBuilder()
                            .setCustomId(`buy_${category}_${actualIndex}`)
                            .setLabel(`${item.name}`)
                            .setStyle(getRarityButtonStyle(item.rarity))
                            .setDisabled(user.gold < item.price)
                    );
                });
                
                itemButtons.push(row);
            }
            
            const navButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`shop_${category}_prev_page`)
                        .setLabel('â—€ ì´ì „')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(newPage === 0),
                    new ButtonBuilder()
                        .setCustomId(`shop_${category}_page_info`)
                        .setLabel(`${newPage + 1}/${totalPages}`)
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId(`shop_${category}_next_page`)
                        .setLabel('ë‹¤ìŒ â–¶')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(newPage >= totalPages - 1),
                    new ButtonBuilder()
                        .setCustomId('shop')
                        .setLabel('ğŸ”™ ìƒì  ë©”ì¸')
                        .setStyle(ButtonStyle.Primary)
                );

            const allComponents = [...itemButtons, navButtons];

            await interaction.update({
                embeds: [updatedEmbed],
                components: allComponents,
                files: [categoryAttachment]
            });
        }
        
        else if (interaction.customId.startsWith('buy_')) {
            const parts = interaction.customId.split('_');
            if (parts.length < 3) {
                await interaction.reply({ content: 'ì˜ëª»ëœ ì•„ì´í…œ ì„ íƒì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            const category = parts[1];
            const itemIndex = parseInt(parts[2]);
            
            // ì „ì—­ ìƒì  ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì‚¬ìš©
            const categoryData = SHOP_CATEGORIES[category];
            if (!categoryData || !categoryData.items[itemIndex]) {
                await interaction.reply({ content: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì•„ì´í…œì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            const item = categoryData.items[itemIndex];
            
            if (user.gold < item.price) {
                await interaction.reply({ content: 'ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ëœë¤ ëŠ¥ë ¥ì¹˜ ìƒì„±
            const randomStats = generateRandomStats(item.stats);
            
            // ëŠ¥ë ¥ì¹˜ í€„ë¦¬í‹° ê³„ì‚° (1~100%)
            let totalQuality = 0;
            let statCount = 0;
            
            for (const [statName, value] of Object.entries(randomStats)) {
                const [min, max] = item.stats[statName];
                if (min !== max) {
                    const quality = ((value - min) / (max - min)) * 100;
                    totalQuality += quality;
                    statCount++;
                }
            }
            
            const averageQuality = statCount > 0 ? totalQuality / statCount : 100;
            
            // í€„ë¦¬í‹°ì— ë”°ë¥¸ GIF ë° ë©”ì‹œì§€ ì„ íƒ
            let purchaseGif;
            let qualityMessage;
            let embedColor;
            
            if (averageQuality <= 80) {
                // í•˜ìœ„ 80% - 2 ë²„ì „ GIF
                switch(item.type) {
                    case 'weapon':
                        purchaseGif = 'kim_shop_buy_waepon2.gif';
                        break;
                    case 'armor':
                        purchaseGif = 'kim_shop_buy_robe2.gif';
                        break;
                    case 'helmet':
                        purchaseGif = 'kim_shop_buy_hood2.gif';
                        break;
                    case 'gloves':
                        purchaseGif = 'kim_shop_buy_gloves2.gif';
                        break;
                    case 'boots':
                        purchaseGif = 'kim_shop_buy_boots2.gif';
                        break;
                    default:
                        purchaseGif = null;
                }
                
                if (averageQuality <= 20) {
                    qualityMessage = 'ğŸ˜¢ ìµœí•˜ê¸‰ ì˜µì…˜';
                    embedColor = '#7f8c8d'; // íšŒìƒ‰
                } else if (averageQuality <= 40) {
                    qualityMessage = 'ğŸ˜ í•˜ê¸‰ ì˜µì…˜';
                    embedColor = '#95a5a6'; // ì—°í•œ íšŒìƒ‰
                } else if (averageQuality <= 60) {
                    qualityMessage = 'ğŸ™‚ í‰ê·  ì˜µì…˜';
                    embedColor = '#3498db'; // íŒŒë€ìƒ‰
                } else {
                    qualityMessage = 'ğŸ˜Š ì¤€ìˆ˜í•œ ì˜µì…˜';
                    embedColor = '#2ecc71'; // ì´ˆë¡ìƒ‰
                }
            } else {
                // ìƒìœ„ 20% - ê¸°ë³¸ GIF
                switch(item.type) {
                    case 'weapon':
                        purchaseGif = 'kim_shop_buy_waepon.gif';
                        break;
                    case 'armor':
                        purchaseGif = 'kim_shop_buy_robe.gif';
                        break;
                    case 'helmet':
                        purchaseGif = 'kim_shop_buy_hood.gif';
                        break;
                    case 'gloves':
                        purchaseGif = 'kim_shop_buy_gloves.gif';
                        break;
                    case 'boots':
                        purchaseGif = 'kim_shop_buy_boots.gif';
                        break;
                    default:
                        purchaseGif = null;
                }
                
                if (averageQuality <= 90) {
                    qualityMessage = 'ğŸ˜ ìƒê¸‰ ì˜µì…˜!';
                    embedColor = '#e74c3c'; // ë¹¨ê°„ìƒ‰
                } else if (averageQuality <= 95) {
                    qualityMessage = 'ğŸ¤© ìµœìƒê¸‰ ì˜µì…˜!!';
                    embedColor = '#e67e22'; // ì£¼í™©ìƒ‰
                } else {
                    qualityMessage = 'ğŸ”¥ ì™„ë²½í•œ ì˜µì…˜!!!';
                    embedColor = '#f1c40f'; // í™©ê¸ˆìƒ‰
                }
            }
            
            // GIF ì²¨ë¶€íŒŒì¼ ìƒì„± (íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ë§Œ)
            let purchaseAttachment = null;
            const gifPath = path.join(__dirname, 'resource', purchaseGif);
            try {
                const fs = require('fs');
                if (fs.existsSync(gifPath)) {
                    purchaseAttachment = new AttachmentBuilder(gifPath, { name: purchaseGif });
                }
            } catch (error) {
                console.log(`GIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${purchaseGif}`);
            }
            
            // ê³¨ë“œ ì°¨ê°
            user.gold -= item.price;
            
            // ì¸ë²¤í† ë¦¬ì— ì•„ì´í…œ ì¶”ê°€ (ê° ì•„ì´í…œì€ ê³ ìœ í•œ ëŠ¥ë ¥ì¹˜ë¥¼ ê°€ì§)
            const uniqueItemId = `${category}_${itemIndex}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            user.inventory.push({
                id: uniqueItemId,
                name: item.name,
                type: item.type,
                rarity: item.rarity,
                setName: item.setName,
                level: item.level || 1,
                quantity: 1,
                enhanceLevel: 0,
                stats: randomStats,
                price: item.price,
                description: item.description || ''
            });
            
            await user.save();
            
            // ëŠ¥ë ¥ì¹˜ í‘œì‹œ í…ìŠ¤íŠ¸ ìƒì„±
            let statsText = '';
            for (const [statName, value] of Object.entries(randomStats)) {
                if (value !== 0) {
                    const statDisplay = statName === 'attack' ? 'ê³µê²©ë ¥' : 
                                      statName === 'defense' ? 'ë°©ì–´ë ¥' : 
                                      statName === 'dodge' ? 'íšŒí”¼ë ¥' : 
                                      statName === 'luck' ? 'í–‰ìš´' : statName;
                    
                    // ìµœëŒ€ê°’ì¸ ê²½ìš° ê°•ì¡°
                    const [min, max] = item.stats[statName];
                    const isMax = value === max;
                    statsText += `${statDisplay}: ${value > 0 ? '+' : ''}${value}${isMax ? ' ğŸ“ˆ' : ''}\n`;
                }
            }
            
            // ê°€ì±  ì—°ì¶œìš© R ë²„ì „ GIF ì„ íƒ
            let gachaGif;
            switch(item.type) {
                case 'weapon':
                    gachaGif = 'kim_shop_buy_waeponR.gif';
                    break;
                case 'armor':
                case 'helmet':
                    gachaGif = 'kim_shop_buy_robeR.gif';
                    break;
                case 'gloves':
                    gachaGif = 'kim_shop_buy_glovesR.gif';
                    break;
                case 'boots':
                    gachaGif = 'kim_shop_buy_bootsR.gif';
                    break;
                default:
                    gachaGif = null;
            }
            
            // ê°€ì±  ì—°ì¶œìš© ì²¨ë¶€íŒŒì¼ ìƒì„±
            let gachaAttachment = null;
            if (gachaGif) {
                const gachaPath = path.join(__dirname, 'resource', gachaGif);
                try {
                    const fs = require('fs');
                    if (fs.existsSync(gachaPath)) {
                        gachaAttachment = new AttachmentBuilder(gachaPath, { name: gachaGif });
                    }
                } catch (error) {
                    console.log(`ê°€ì±  GIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${gachaGif}`);
                }
            }
            
            // ë¨¼ì € ê°€ì±  ì—°ì¶œ GIF í‘œì‹œ
            const gachaEmbed = new EmbedBuilder()
                .setColor('#ffffff')
                .setTitle('ğŸ² ì•„ì´í…œ íšë“ ì¤‘...')
                .setDescription('ì–´ë–¤ ì˜µì…˜ì´ ë‚˜ì˜¬ê¹Œìš”?');
            
            if (gachaAttachment) {
                gachaEmbed.setImage(`attachment://${gachaGif}`);
            }
            
            const gachaOptions = { 
                embeds: [gachaEmbed], 
                components: [],
                ephemeral: true 
            };
            
            if (gachaAttachment) {
                gachaOptions.files = [gachaAttachment];
            }
            
            await interaction.reply(gachaOptions);
            
            // 0.5ì´ˆ í›„ ì‹¤ì œ êµ¬ë§¤ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
            setTimeout(async () => {
                const purchaseEmbed = new EmbedBuilder()
                    .setColor(embedColor)
                    .setTitle('ğŸ›ï¸ êµ¬ë§¤ ì„±ê³µ!')
                    .setDescription(`**${item.name}**ì„(ë¥¼) ì„±ê³µì ìœ¼ë¡œ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`)
                    .addFields(
                        { name: 'ğŸ’ ì•„ì´í…œ ì •ë³´', value: `${item.setName}\n${item.rarity} ë“±ê¸‰`, inline: true },
                        { name: 'ğŸ“Š ì˜µì…˜ í‰ê°€', value: `${qualityMessage}\n(ìƒìœ„ ${Math.round(100 - averageQuality)}%)`, inline: true },
                        { name: 'ğŸ“ˆ ëœë¤ ëŠ¥ë ¥ì¹˜', value: statsText.trim() || 'ì—†ìŒ', inline: false },
                        { name: 'ğŸ’° ê²°ì œ ì •ë³´', value: `êµ¬ë§¤ê°€: ${item.price.toLocaleString()}<:currency_emoji:1377404064316522778>\nì”ì•¡: ${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true }
                    )
                    .setFooter({ text: 'ì¸ë²¤í† ë¦¬ì—ì„œ ì¥ì°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!' });

                if (purchaseAttachment) {
                    purchaseEmbed.setImage(`attachment://${purchaseGif}`);
                }
                
                // ì¬êµ¬ë§¤ ë° ìƒì ë©”ì¸ ë²„íŠ¼ ì¶”ê°€
                const actionButtons = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId(`buy_${category}_${itemIndex}`)
                            .setLabel('ğŸ”„ ì¬êµ¬ë§¤')
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(user.gold < item.price),
                        new ButtonBuilder()
                            .setCustomId('shop')
                            .setLabel('ğŸ›’ ìƒì  ë©”ì¸')
                            .setStyle(ButtonStyle.Primary)
                    );
                
                const updateOptions = { 
                    embeds: [purchaseEmbed], 
                    components: [actionButtons],
                    files: purchaseAttachment ? [purchaseAttachment] : []
                };

                await interaction.editReply(updateOptions);
            }, 500);
        }
        
        else if (interaction.customId === 'inventory') {
            if (user.inventory.length === 0) {
                const emptyInventoryEmbed = new EmbedBuilder()
                    .setColor('#e74c3c')
                    .setTitle('ğŸ’ ì¸ë²¤í† ë¦¬')
                    .setDescription('ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!')
                    .addFields(
                        { name: 'ğŸ’¡ íŒ', value: 'ìƒì ì—ì„œ ì•„ì´í…œì„ êµ¬ë§¤í•˜ê±°ë‚˜ ì‚¬ëƒ¥ì„ í†µí•´ ì•„ì´í…œì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!', inline: false }
                    );
                
                await interaction.reply({ embeds: [emptyInventoryEmbed], ephemeral: true });
                return;
            }
            
            // ì¸ë²¤í† ë¦¬ ë©”ì¸ í™”ë©´ (ì¹´í…Œê³ ë¦¬ ì„ íƒ)
            const inventoryEmbed = new EmbedBuilder()
                .setColor('#3498db')
                .setTitle('ğŸ’ ì¸ë²¤í† ë¦¬')
                .setDescription(`**${getUserTitle(user)} ${user.nickname}**ë‹˜ì˜ ë³´ìœ  ì•„ì´í…œ\n\nì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì—¬ ì•„ì´í…œì„ í™•ì¸í•˜ì„¸ìš”!`)
                .addFields(
                    { name: 'ğŸ“Š ì•„ì´í…œ ê°œìˆ˜', value: `ì´ ${user.inventory.length}ê°œ`, inline: true },
                    { name: 'âš”ï¸ ì¥ë¹„ ì•„ì´í…œ', value: `${user.inventory.filter(item => ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type)).length}ê°œ`, inline: true },
                    { name: 'ğŸ“œ ê¸°íƒ€ ì•„ì´í…œ', value: `${user.inventory.filter(item => !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type)).length}ê°œ`, inline: true }
                );

            // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ë“¤ (3ê°œì”© 2ì¤„)
            const categoryButtons1 = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('inv_category_weapons')
                        .setLabel('âš”ï¸ ë¬´ê¸°')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('inv_category_armor')
                        .setLabel('ğŸ›¡ï¸ ê°‘ì˜·')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('inv_category_helmet_gloves')
                        .setLabel('â›‘ï¸ í—¬ë©§/ì¥ê°‘')
                        .setStyle(ButtonStyle.Primary)
                );

            const categoryButtons2 = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('inv_category_boots')
                        .setLabel('ğŸ‘¢ ë¶€ì¸ ')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('inv_category_accessory')
                        .setLabel('ğŸ’ ì•¡ì„¸ì„œë¦¬')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('inv_category_consumables')
                        .setLabel('ğŸ“œ ì£¼ë¬¸ì„œ/ì†Œë¹„/ì½”ì¸')
                        .setStyle(ButtonStyle.Secondary)
                );

            await interaction.reply({ 
                embeds: [inventoryEmbed], 
                components: [categoryButtons1, categoryButtons2],
                ephemeral: true 
            });
        }
        
        // ì¸ë²¤í† ë¦¬ ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§
        else if (interaction.customId.startsWith('inv_category_')) {
            const category = interaction.customId.replace('inv_category_', '');
            
            let categoryItems = [];
            let categoryName = '';
            let categoryEmoji = '';
            
            switch(category) {
                case 'weapons':
                    categoryItems = user.inventory.filter(item => item.type === 'weapon');
                    categoryName = 'ë¬´ê¸°';
                    categoryEmoji = 'âš”ï¸';
                    break;
                case 'armor':
                    categoryItems = user.inventory.filter(item => item.type === 'armor');
                    categoryName = 'ê°‘ì˜·';
                    categoryEmoji = 'ğŸ›¡ï¸';
                    break;
                case 'helmet_gloves':
                    categoryItems = user.inventory.filter(item => item.type === 'helmet' || item.type === 'gloves');
                    categoryName = 'í—¬ë©§/ì¥ê°‘';
                    categoryEmoji = 'â›‘ï¸';
                    break;
                case 'boots':
                    categoryItems = user.inventory.filter(item => item.type === 'boots');
                    categoryName = 'ë¶€ì¸ ';
                    categoryEmoji = 'ğŸ‘¢';
                    break;
                case 'accessory':
                    categoryItems = user.inventory.filter(item => item.type === 'accessory');
                    categoryName = 'ì•¡ì„¸ì„œë¦¬';
                    categoryEmoji = 'ğŸ’';
                    break;
                case 'consumables':
                    categoryItems = user.inventory.filter(item => !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type));
                    categoryName = 'ì£¼ë¬¸ì„œ/ì†Œë¹„/ì½”ì¸';
                    categoryEmoji = 'ğŸ“œ';
                    break;
            }
            
            if (categoryItems.length === 0) {
                await interaction.reply({ 
                    content: `${categoryName} ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
                return;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
            const itemsPerPage = 3;
            const currentPage = 0;
            const totalPages = Math.ceil(categoryItems.length / itemsPerPage);
            const startIndex = currentPage * itemsPerPage;
            const currentItems = categoryItems.slice(startIndex, startIndex + itemsPerPage);

            // ì¹´í…Œê³ ë¦¬ ì„ë² ë“œ ìƒì„±
            const categoryEmbed = new EmbedBuilder()
                .setColor('#3498db')
                .setTitle(`${categoryEmoji} ${categoryName} ì¸ë²¤í† ë¦¬`)
                .setDescription(`**${getUserTitle(user)} ${user.nickname}**ë‹˜ì˜ ${categoryName} ëª©ë¡`)
                .setFooter({ text: `í˜ì´ì§€ ${currentPage + 1}/${totalPages} | ì•„ì´í…œì„ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•˜ê±°ë‚˜ ì¥ì°©í•˜ì„¸ìš”!` });

            // ì•„ì´í…œ ëª©ë¡ í…ìŠ¤íŠ¸ ìƒì„±
            let itemList = '';
            currentItems.forEach((item, index) => {
                const globalIndex = startIndex + index;
                const isEquipped = user.equipment[item.type] && user.equipment[item.type].id === item.id;
                const enhanceText = item.enhanceLevel > 0 ? ` (+${item.enhanceLevel}ì„±)` : '';
                
                itemList += `**${globalIndex + 1}. ${item.name}**${enhanceText} ${isEquipped ? 'ğŸ”´' : ''}\n`;
                itemList += `ë“±ê¸‰: ${item.rarity} | ìˆ˜ëŸ‰: x${item.quantity}\n`;
                
                // ì¥ë¹„ ì•„ì´í…œì¸ ê²½ìš° ìŠ¤íƒ¯ í‘œì‹œ
                if (['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type)) {
                    let statsText = '';
                    for (const [statName, value] of Object.entries(item.stats)) {
                        if (value !== 0) {
                            const statDisplay = statName === 'attack' ? 'ê³µê²©ë ¥' : 
                                              statName === 'defense' ? 'ë°©ì–´ë ¥' : 
                                              statName === 'dodge' ? 'íšŒí”¼ë ¥' : 
                                              statName === 'luck' ? 'í–‰ìš´' : statName;
                            statsText += `${statDisplay}: ${value > 0 ? '+' : ''}${value} `;
                        }
                    }
                    itemList += `${statsText}\n`;
                }
                
                itemList += `ğŸ’° íŒë§¤ê°€: ${Math.floor(item.price * 0.7).toLocaleString()}<:currency_emoji:1377404064316522778>\n\n`;
            });

            categoryEmbed.addFields({ name: 'ë³´ìœ  ì•„ì´í…œ', value: itemList, inline: false });

            // ì•„ì´í…œ ì‚¬ìš©/ì¥ì°© ë²„íŠ¼ë“¤ (3ê°œì”©)
            const itemButtons = new ActionRowBuilder();
            currentItems.forEach((item, index) => {
                const globalIndex = startIndex + index;
                const isEquipped = user.equipment[item.type] && user.equipment[item.type].id === item.id;
                const isEquipment = ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type);
                
                itemButtons.addComponents(
                    new ButtonBuilder()
                        .setCustomId(`inv_use_${item.id}_${category}_${currentPage}`)
                        .setLabel(`${globalIndex + 1}. ${isEquipment ? 'ì¥ì°©' : 'ì‚¬ìš©'}`)
                        .setStyle(isEquipped ? ButtonStyle.Success : ButtonStyle.Primary)
                        .setDisabled(isEquipped)
                );
            });

            // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼
            const navButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`inv_${category}_prev_${currentPage}`)
                        .setLabel('â—€ ì´ì „')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage === 0),
                    new ButtonBuilder()
                        .setCustomId(`inv_${category}_page_${currentPage}`)
                        .setLabel(`${currentPage + 1}/${totalPages}`)
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId(`inv_${category}_next_${currentPage}`)
                        .setLabel('ë‹¤ìŒ â–¶')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage >= totalPages - 1),
                    new ButtonBuilder()
                        .setCustomId('inventory')
                        .setLabel('ğŸ”™ ì¸ë²¤í† ë¦¬ ë©”ì¸')
                        .setStyle(ButtonStyle.Primary)
                );

            const components = [itemButtons];
            if (totalPages > 1) {
                components.push(navButtons);
            } else {
                components.push(new ActionRowBuilder().addComponents(
                    new ButtonBuilder()
                        .setCustomId('inventory')
                        .setLabel('ğŸ”™ ì¸ë²¤í† ë¦¬ ë©”ì¸')
                        .setStyle(ButtonStyle.Primary)
                ));
            }

            await interaction.reply({
                embeds: [categoryEmbed],
                components: components,
                ephemeral: true
            });
        }
        
        // ì¸ë²¤í† ë¦¬ ì•„ì´í…œ ì‚¬ìš©/ì¥ì°© ì²˜ë¦¬
        else if (interaction.customId.startsWith('inv_use_')) {
            const parts = interaction.customId.split('_');
            const itemId = parts[2];
            const category = parts[3];
            const currentPage = parseInt(parts[4]);
            
            const inventoryItem = user.inventory.find(inv => inv.id === itemId);
            
            if (!inventoryItem) {
                await interaction.reply({ content: 'í•´ë‹¹ ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ì¥ë¹„ ì•„ì´í…œì¸ ê²½ìš° ì¥ì°© ì²˜ë¦¬
            if (['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(inventoryItem.type)) {
                // ì´ë¯¸ ì°©ìš© ì¤‘ì¸ì§€ í™•ì¸
                if (user.equipment[inventoryItem.type] && user.equipment[inventoryItem.type].id === itemId) {
                    await interaction.reply({ content: 'ì´ë¯¸ ì°©ìš© ì¤‘ì¸ ì•„ì´í…œì…ë‹ˆë‹¤!', ephemeral: true });
                    return;
                }

                // ë ˆë²¨ í™•ì¸
                if (user.level < inventoryItem.level) {
                    await interaction.reply({ 
                        content: `ë ˆë²¨ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: Lv.${inventoryItem.level}, í˜„ì¬: Lv.${user.level})`, 
                        ephemeral: true 
                    });
                    return;
                }

                // ì¥ì°© ì²˜ë¦¬
                user.equipment[inventoryItem.type] = inventoryItem;
                await user.save();

                const equipEmbed = new EmbedBuilder()
                    .setColor('#00ff00')
                    .setTitle('âš”ï¸ ì¥ë¹„ ì°©ìš© ì™„ë£Œ!')
                    .setDescription(`**${inventoryItem.name}**ì„(ë¥¼) ì„±ê³µì ìœ¼ë¡œ ì°©ìš©í–ˆìŠµë‹ˆë‹¤!`)
                    .addFields(
                        { name: 'ì°©ìš©í•œ ì•„ì´í…œ', value: `${inventoryItem.name}${inventoryItem.enhanceLevel > 0 ? ` (+${inventoryItem.enhanceLevel}ì„±)` : ''}`, inline: true },
                        { name: 'ì•„ì´í…œ ë“±ê¸‰', value: inventoryItem.rarity, inline: true },
                        { name: 'ìƒˆë¡œìš´ ì „íˆ¬ë ¥', value: calculateCombatPower(user).toLocaleString(), inline: true }
                    );

                await interaction.reply({
                    embeds: [equipEmbed],
                    ephemeral: true
                });
            } else {
                // ì†Œë¹„ ì•„ì´í…œ ì‚¬ìš©
                inventoryItem.quantity -= 1;
                if (inventoryItem.quantity <= 0) {
                    user.inventory = user.inventory.filter(inv => inv.id !== itemId);
                }
                
                await user.save();
                await interaction.reply({ 
                    content: `**${inventoryItem.name}**ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
            }
        }
        
        // ì¸ë²¤í† ë¦¬ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
        else if (interaction.customId.includes('inv_') && (interaction.customId.includes('_prev_') || interaction.customId.includes('_next_'))) {
            const parts = interaction.customId.split('_');
            
            if (parts[0] === 'inv' && (parts[2] === 'prev' || parts[2] === 'next')) {
                const category = parts[1];
                const direction = parts[2];
                const currentPage = parseInt(parts[3]);
                
                let newPage = currentPage;
                if (direction === 'prev' && currentPage > 0) {
                    newPage = currentPage - 1;
                } else if (direction === 'next') {
                    newPage = currentPage + 1;
                }

                // ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ í•„í„°ë§
                let categoryItems = [];
                let categoryName = '';
                let categoryEmoji = '';
                
                switch(category) {
                    case 'weapons':
                        categoryItems = user.inventory.filter(item => item.type === 'weapon');
                        categoryName = 'ë¬´ê¸°';
                        categoryEmoji = 'âš”ï¸';
                        break;
                    case 'armor':
                        categoryItems = user.inventory.filter(item => item.type === 'armor');
                        categoryName = 'ê°‘ì˜·';
                        categoryEmoji = 'ğŸ›¡ï¸';
                        break;
                    case 'helmet_gloves':
                        categoryItems = user.inventory.filter(item => item.type === 'helmet' || item.type === 'gloves');
                        categoryName = 'í—¬ë©§/ì¥ê°‘';
                        categoryEmoji = 'â›‘ï¸';
                        break;
                    case 'boots':
                        categoryItems = user.inventory.filter(item => item.type === 'boots');
                        categoryName = 'ë¶€ì¸ ';
                        categoryEmoji = 'ğŸ‘¢';
                        break;
                    case 'accessory':
                        categoryItems = user.inventory.filter(item => item.type === 'accessory');
                        categoryName = 'ì•¡ì„¸ì„œë¦¬';
                        categoryEmoji = 'ğŸ’';
                        break;
                    case 'consumables':
                        categoryItems = user.inventory.filter(item => !['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type));
                        categoryName = 'ì£¼ë¬¸ì„œ/ì†Œë¹„/ì½”ì¸';
                        categoryEmoji = 'ğŸ“œ';
                        break;
                }

                const itemsPerPage = 3;
                const totalPages = Math.ceil(categoryItems.length / itemsPerPage);
                
                if (newPage >= totalPages || newPage < 0) {
                    await interaction.reply({ content: 'ì˜ëª»ëœ í˜ì´ì§€ì…ë‹ˆë‹¤!', ephemeral: true });
                    return;
                }

                const startIndex = newPage * itemsPerPage;
                const currentItems = categoryItems.slice(startIndex, startIndex + itemsPerPage);

                // ì¹´í…Œê³ ë¦¬ ì„ë² ë“œ ì—…ë°ì´íŠ¸
                const categoryEmbed = new EmbedBuilder()
                    .setColor('#3498db')
                    .setTitle(`${categoryEmoji} ${categoryName} ì¸ë²¤í† ë¦¬`)
                    .setDescription(`**${getUserTitle(user)} ${user.nickname}**ë‹˜ì˜ ${categoryName} ëª©ë¡`)
                    .setFooter({ text: `í˜ì´ì§€ ${newPage + 1}/${totalPages} | ì•„ì´í…œì„ ì„ íƒí•˜ì—¬ ì‚¬ìš©í•˜ê±°ë‚˜ ì¥ì°©í•˜ì„¸ìš”!` });

                // ì•„ì´í…œ ëª©ë¡ í…ìŠ¤íŠ¸ ìƒì„±
                let itemList = '';
                currentItems.forEach((item, index) => {
                    const globalIndex = startIndex + index;
                    const isEquipped = user.equipment[item.type] && user.equipment[item.type].id === item.id;
                    const enhanceText = item.enhanceLevel > 0 ? ` (+${item.enhanceLevel}ì„±)` : '';
                    
                    itemList += `**${globalIndex + 1}. ${item.name}**${enhanceText} ${isEquipped ? 'ğŸ”´' : ''}\n`;
                    itemList += `ë“±ê¸‰: ${item.rarity} | ìˆ˜ëŸ‰: x${item.quantity}\n`;
                    
                    // ì¥ë¹„ ì•„ì´í…œì¸ ê²½ìš° ìŠ¤íƒ¯ í‘œì‹œ
                    if (['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type)) {
                        let statsText = '';
                        for (const [statName, value] of Object.entries(item.stats)) {
                            if (value !== 0) {
                                const statDisplay = statName === 'attack' ? 'ê³µê²©ë ¥' : 
                                                  statName === 'defense' ? 'ë°©ì–´ë ¥' : 
                                                  statName === 'dodge' ? 'íšŒí”¼ë ¥' : 
                                                  statName === 'luck' ? 'í–‰ìš´' : statName;
                                statsText += `${statDisplay}: ${value > 0 ? '+' : ''}${value} `;
                            }
                        }
                        itemList += `${statsText}\n`;
                    }
                    
                    itemList += `ğŸ’° íŒë§¤ê°€: ${Math.floor(item.price * 0.7).toLocaleString()}<:currency_emoji:1377404064316522778>\n\n`;
                });

                categoryEmbed.addFields({ name: 'ë³´ìœ  ì•„ì´í…œ', value: itemList, inline: false });

                // ì•„ì´í…œ ì‚¬ìš©/ì¥ì°© ë²„íŠ¼ë“¤ ì—…ë°ì´íŠ¸
                const itemButtons = new ActionRowBuilder();
                currentItems.forEach((item, index) => {
                    const globalIndex = startIndex + index;
                    const isEquipped = user.equipment[item.type] && user.equipment[item.type].id === item.id;
                    const isEquipment = ['weapon', 'armor', 'helmet', 'gloves', 'boots', 'accessory'].includes(item.type);
                    
                    itemButtons.addComponents(
                        new ButtonBuilder()
                            .setCustomId(`inv_use_${item.id}_${category}_${newPage}`)
                            .setLabel(`${globalIndex + 1}. ${isEquipment ? 'ì¥ì°©' : 'ì‚¬ìš©'}`)
                            .setStyle(isEquipped ? ButtonStyle.Success : ButtonStyle.Primary)
                            .setDisabled(isEquipped)
                    );
                });

                // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                const navButtons = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId(`inv_${category}_prev_${newPage}`)
                            .setLabel('â—€ ì´ì „')
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(newPage === 0),
                        new ButtonBuilder()
                            .setCustomId(`inv_${category}_page_${newPage}`)
                            .setLabel(`${newPage + 1}/${totalPages}`)
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(true),
                        new ButtonBuilder()
                            .setCustomId(`inv_${category}_next_${newPage}`)
                            .setLabel('ë‹¤ìŒ â–¶')
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(newPage >= totalPages - 1),
                        new ButtonBuilder()
                            .setCustomId('inventory')
                            .setLabel('ğŸ”™ ì¸ë²¤í† ë¦¬ ë©”ì¸')
                            .setStyle(ButtonStyle.Primary)
                    );

                const components = [itemButtons];
                if (totalPages > 1) {
                    components.push(navButtons);
                } else {
                    components.push(new ActionRowBuilder().addComponents(
                        new ButtonBuilder()
                            .setCustomId('inventory')
                            .setLabel('ğŸ”™ ì¸ë²¤í† ë¦¬ ë©”ì¸')
                            .setStyle(ButtonStyle.Primary)
                    ));
                }

                await interaction.update({
                    embeds: [categoryEmbed],
                    components: components
                });
            }
        }
        
        else if (interaction.customId.startsWith('use_')) {
            const itemId = interaction.customId.replace('use_', '');
            const inventoryItem = user.inventory.find(inv => inv.id === itemId);
            
            if (!inventoryItem) {
                await interaction.reply({ content: 'í•´ë‹¹ ì•„ì´í…œì„ ë³´ìœ í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            if (inventoryItem.type === 'consumable') {
                // ì†Œë¹„ ì•„ì´í…œ ì‚¬ìš©
                inventoryItem.quantity -= 1;
                if (inventoryItem.quantity <= 0) {
                    user.inventory = user.inventory.filter(inv => inv.id !== itemId);
                }
                
                await user.save();
                await interaction.reply({ 
                    content: `**${inventoryItem.name}**ì„(ë¥¼) ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
            } else {
                // ì¥ë¹„ ì•„ì´í…œ ì¥ì°©
                await interaction.reply({ 
                    content: `ì¥ë¹„ ì‹œìŠ¤í…œì€ 5í˜ì´ì§€ì—ì„œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
            }
        }
        
        else if (interaction.customId === 'equipment') {
            // ì¥ë¹„ ë©”ì¸ ì´ë¯¸ì§€ ì²¨ë¶€íŒŒì¼ ìƒì„±
            const equipmentAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', 'kim_equipment.gif'), { name: 'kim_equipment.gif' });
            
            // ì „íˆ¬ë ¥ ê³„ì‚°
            const combatPower = calculateCombatPower(user);
            
            const equipmentEmbed = new EmbedBuilder()
                .setColor('#f39c12')
                .setTitle('âš”ï¸ ì¥ë¹„ ê´€ë¦¬')
                .setDescription(`**${getUserTitle(user)} ${user.nickname}**ë‹˜ì˜ í˜„ì¬ ì¥ë¹„ ìƒíƒœ\n\nğŸ”¥ **ì´ ì „íˆ¬ë ¥**: ${combatPower.toLocaleString()}`)
                .setImage('attachment://kim_equipment.gif')
                .addFields(
                    { name: 'âš”ï¸ ë¬´ê¸°', value: user.equipment.weapon ? `${user.equipment.weapon.name}${user.equipment.weapon.enhanceLevel > 0 ? ` (+${user.equipment.weapon.enhanceLevel}ì„±)` : ''}\nê³µê²©ë ¥: +${user.equipment.weapon.stats.attack}` : 'ì—†ìŒ', inline: true },
                    { name: 'ğŸ›¡ï¸ ê°‘ì˜·', value: user.equipment.armor ? `${user.equipment.armor.name}${user.equipment.armor.enhanceLevel > 0 ? ` (+${user.equipment.armor.enhanceLevel}ì„±)` : ''}\në°©ì–´ë ¥: +${user.equipment.armor.stats.defense}` : 'ì—†ìŒ', inline: true },
                    { name: 'â›‘ï¸ í—¬ë©§', value: user.equipment.helmet ? `${user.equipment.helmet.name}${user.equipment.helmet.enhanceLevel > 0 ? ` (+${user.equipment.helmet.enhanceLevel}ì„±)` : ''}` : 'ì—†ìŒ', inline: true },
                    { name: 'ğŸ§¤ ì¥ê°‘', value: user.equipment.gloves ? `${user.equipment.gloves.name}${user.equipment.gloves.enhanceLevel > 0 ? ` (+${user.equipment.gloves.enhanceLevel}ì„±)` : ''}` : 'ì—†ìŒ', inline: true },
                    { name: 'ğŸ‘¢ ë¶€ì¸ ', value: user.equipment.boots ? `${user.equipment.boots.name}${user.equipment.boots.enhanceLevel > 0 ? ` (+${user.equipment.boots.enhanceLevel}ì„±)` : ''}` : 'ì—†ìŒ', inline: true },
                    { name: 'ğŸ’ ì•¡ì„¸ì„œë¦¬', value: user.equipment.accessory ? `${user.equipment.accessory.name}${user.equipment.accessory.enhanceLevel > 0 ? ` (+${user.equipment.accessory.enhanceLevel}ì„±)` : ''}` : 'ì—†ìŒ', inline: true }
                );

            // ì¹´í…Œê³ ë¦¬ë³„ ì¥ë¹„ êµì²´ ë²„íŠ¼
            const categoryButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('equip_category_weapon')
                        .setLabel('âš”ï¸ ë¬´ê¸°')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('equip_category_armor')
                        .setLabel('ğŸ›¡ï¸ ê°‘ì˜·')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('equip_category_helmet')
                        .setLabel('â›‘ï¸ í—¬ë©§')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('equip_category_gloves')
                        .setLabel('ğŸ§¤ ì¥ê°‘')
                        .setStyle(ButtonStyle.Primary),
                    new ButtonBuilder()
                        .setCustomId('equip_category_boots')
                        .setLabel('ğŸ‘¢ ë¶€ì¸ ')
                        .setStyle(ButtonStyle.Primary)
                );

            const categoryButtons2 = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('equip_category_accessory')
                        .setLabel('ğŸ’ ì•¡ì„¸ì„œë¦¬')
                        .setStyle(ButtonStyle.Primary)
                );

            await interaction.reply({ 
                embeds: [equipmentEmbed], 
                components: [categoryButtons, categoryButtons2],
                files: [equipmentAttachment],
                ephemeral: true 
            });
        }
        
        // ì¥ë¹„ ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§
        else if (interaction.customId.startsWith('equip_category_')) {
            const category = interaction.customId.replace('equip_category_', '');
            
            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì•„ì´í…œë§Œ í•„í„°ë§
            const categoryItems = user.inventory.filter(item => item.type === category);
            
            if (categoryItems.length === 0) {
                await interaction.reply({ 
                    content: `ì¸ë²¤í† ë¦¬ì— ${getCategoryName(category)} ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
                return;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ì„¤ì •
            const itemsPerPage = 3;
            const currentPage = 0;
            const totalPages = Math.ceil(categoryItems.length / itemsPerPage);
            const startIndex = currentPage * itemsPerPage;
            const currentItems = categoryItems.slice(startIndex, startIndex + itemsPerPage);

            // ì¹´í…Œê³ ë¦¬ ì„ë² ë“œ ìƒì„±
            const categoryEmbed = new EmbedBuilder()
                .setColor('#3498db')
                .setTitle(`${getCategoryEmoji(category)} ${getCategoryName(category)} êµì²´`)
                .setDescription(`**${getUserTitle(user)} ${user.nickname}**ë‹˜ì˜ ${getCategoryName(category)} ëª©ë¡`)
                .setFooter({ text: `í˜ì´ì§€ ${currentPage + 1}/${totalPages} | ì›í•˜ëŠ” ì•„ì´í…œì„ ì„ íƒí•˜ì—¬ ì¥ì°©í•˜ì„¸ìš”!` });

            // ì•„ì´í…œ ëª©ë¡ í…ìŠ¤íŠ¸ ìƒì„±
            let itemList = '';
            currentItems.forEach((item, index) => {
                const globalIndex = startIndex + index;
                const isEquipped = user.equipment[category] && user.equipment[category].id === item.id;
                const enhanceText = item.enhanceLevel > 0 ? ` (+${item.enhanceLevel}ì„±)` : '';
                
                itemList += `**${globalIndex + 1}. ${item.name}**${enhanceText} ${isEquipped ? 'ğŸ”´' : ''}\n`;
                itemList += `ë“±ê¸‰: ${item.rarity} | ë ˆë²¨: ${item.level}\n`;
                
                // ìŠ¤íƒ¯ í‘œì‹œ
                let statsText = '';
                for (const [statName, value] of Object.entries(item.stats)) {
                    if (value !== 0) {
                        const statDisplay = statName === 'attack' ? 'ê³µê²©ë ¥' : 
                                          statName === 'defense' ? 'ë°©ì–´ë ¥' : 
                                          statName === 'dodge' ? 'íšŒí”¼ë ¥' : 
                                          statName === 'luck' ? 'í–‰ìš´' : statName;
                        statsText += `${statDisplay}: ${value > 0 ? '+' : ''}${value} `;
                    }
                }
                itemList += `${statsText}\n\n`;
            });

            categoryEmbed.addFields({ name: 'ë³´ìœ  ì•„ì´í…œ', value: itemList, inline: false });

            // ì•„ì´í…œ ì„ íƒ ë²„íŠ¼ë“¤ (3ê°œì”©)
            const itemButtons = new ActionRowBuilder();
            currentItems.forEach((item, index) => {
                const globalIndex = startIndex + index;
                const isEquipped = user.equipment[category] && user.equipment[category].id === item.id;
                
                itemButtons.addComponents(
                    new ButtonBuilder()
                        .setCustomId(`equip_item_${item.id}_${category}_${currentPage}`)
                        .setLabel(`${globalIndex + 1}. ${item.name} ì¥ì°©`)
                        .setStyle(isEquipped ? ButtonStyle.Success : ButtonStyle.Primary)
                        .setDisabled(isEquipped)
                );
            });

            // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼
            const navButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`equip_${category}_prev_${currentPage}`)
                        .setLabel('â—€ ì´ì „')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage === 0),
                    new ButtonBuilder()
                        .setCustomId(`equip_${category}_page_${currentPage}`)
                        .setLabel(`${currentPage + 1}/${totalPages}`)
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId(`equip_${category}_next_${currentPage}`)
                        .setLabel('ë‹¤ìŒ â–¶')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(currentPage >= totalPages - 1),
                    new ButtonBuilder()
                        .setCustomId('equipment')
                        .setLabel('ğŸ”™ ì¥ë¹„ ë©”ì¸')
                        .setStyle(ButtonStyle.Primary)
                );

            const components = [itemButtons];
            if (totalPages > 1) {
                components.push(navButtons);
            } else {
                components.push(new ActionRowBuilder().addComponents(
                    new ButtonBuilder()
                        .setCustomId('equipment')
                        .setLabel('ğŸ”™ ì¥ë¹„ ë©”ì¸')
                        .setStyle(ButtonStyle.Primary)
                ));
            }

            await interaction.reply({
                embeds: [categoryEmbed],
                components: components,
                ephemeral: true
            });
        }
        
        // ì¥ë¹„ ì•„ì´í…œ ì°©ìš© ì²˜ë¦¬
        else if (interaction.customId.startsWith('equip_item_')) {
            const parts = interaction.customId.split('_');
            const itemId = parts[2];
            const category = parts[3];
            const currentPage = parseInt(parts[4]);
            
            const item = user.inventory.find(inv => inv.id === itemId);
            if (!item) {
                await interaction.reply({ content: 'í•´ë‹¹ ì•„ì´í…œì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            // ì´ë¯¸ ì°©ìš© ì¤‘ì¸ì§€ í™•ì¸
            if (user.equipment[category] && user.equipment[category].id === itemId) {
                await interaction.reply({ content: 'ì´ë¯¸ ì°©ìš© ì¤‘ì¸ ì•„ì´í…œì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            // ë ˆë²¨ í™•ì¸
            if (user.level < item.level) {
                await interaction.reply({ 
                    content: `ë ˆë²¨ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: Lv.${item.level}, í˜„ì¬: Lv.${user.level})`, 
                    ephemeral: true 
                });
                return;
            }

            // ì¥ì°© ì²˜ë¦¬
            user.equipment[category] = item;
            await user.save();

            const equipEmbed = new EmbedBuilder()
                .setColor('#00ff00')
                .setTitle('âš”ï¸ ì¥ë¹„ ì°©ìš© ì™„ë£Œ!')
                .setDescription(`**${item.name}**ì„(ë¥¼) ì„±ê³µì ìœ¼ë¡œ ì°©ìš©í–ˆìŠµë‹ˆë‹¤!`)
                .addFields(
                    { name: 'ì°©ìš©í•œ ì•„ì´í…œ', value: `${item.name}${item.enhanceLevel > 0 ? ` (+${item.enhanceLevel}ì„±)` : ''}`, inline: true },
                    { name: 'ì•„ì´í…œ ë“±ê¸‰', value: item.rarity, inline: true },
                    { name: 'ìƒˆë¡œìš´ ì „íˆ¬ë ¥', value: calculateCombatPower(user).toLocaleString(), inline: true }
                );

            await interaction.reply({
                embeds: [equipEmbed],
                ephemeral: true
            });
        }
        
        // ì¥ë¹„ ì¹´í…Œê³ ë¦¬ í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
        else if (interaction.customId.includes('_prev_') || interaction.customId.includes('_next_')) {
            const parts = interaction.customId.split('_');
            
            if (parts[0] === 'equip' && (parts[2] === 'prev' || parts[2] === 'next')) {
                const category = parts[1];
                const direction = parts[2];
                const currentPage = parseInt(parts[3]);
                
                let newPage = currentPage;
                if (direction === 'prev' && currentPage > 0) {
                    newPage = currentPage - 1;
                } else if (direction === 'next') {
                    newPage = currentPage + 1;
                }

                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì•„ì´í…œë§Œ í•„í„°ë§
                const categoryItems = user.inventory.filter(item => item.type === category);
                const itemsPerPage = 3;
                const totalPages = Math.ceil(categoryItems.length / itemsPerPage);
                
                if (newPage >= totalPages || newPage < 0) {
                    await interaction.reply({ content: 'ì˜ëª»ëœ í˜ì´ì§€ì…ë‹ˆë‹¤!', ephemeral: true });
                    return;
                }

                const startIndex = newPage * itemsPerPage;
                const currentItems = categoryItems.slice(startIndex, startIndex + itemsPerPage);

                // ì¹´í…Œê³ ë¦¬ ì„ë² ë“œ ì—…ë°ì´íŠ¸
                const categoryEmbed = new EmbedBuilder()
                    .setColor('#3498db')
                    .setTitle(`${getCategoryEmoji(category)} ${getCategoryName(category)} êµì²´`)
                    .setDescription(`**${getUserTitle(user)} ${user.nickname}**ë‹˜ì˜ ${getCategoryName(category)} ëª©ë¡`)
                    .setFooter({ text: `í˜ì´ì§€ ${newPage + 1}/${totalPages} | ì›í•˜ëŠ” ì•„ì´í…œì„ ì„ íƒí•˜ì—¬ ì¥ì°©í•˜ì„¸ìš”!` });

                // ì•„ì´í…œ ëª©ë¡ í…ìŠ¤íŠ¸ ìƒì„±
                let itemList = '';
                currentItems.forEach((item, index) => {
                    const globalIndex = startIndex + index;
                    const isEquipped = user.equipment[category] && user.equipment[category].id === item.id;
                    const enhanceText = item.enhanceLevel > 0 ? ` (+${item.enhanceLevel}ì„±)` : '';
                    
                    itemList += `**${globalIndex + 1}. ${item.name}**${enhanceText} ${isEquipped ? 'ğŸ”´' : ''}\n`;
                    itemList += `ë“±ê¸‰: ${item.rarity} | ë ˆë²¨: ${item.level}\n`;
                    
                    // ìŠ¤íƒ¯ í‘œì‹œ
                    let statsText = '';
                    for (const [statName, value] of Object.entries(item.stats)) {
                        if (value !== 0) {
                            const statDisplay = statName === 'attack' ? 'ê³µê²©ë ¥' : 
                                              statName === 'defense' ? 'ë°©ì–´ë ¥' : 
                                              statName === 'dodge' ? 'íšŒí”¼ë ¥' : 
                                              statName === 'luck' ? 'í–‰ìš´' : statName;
                            statsText += `${statDisplay}: ${value > 0 ? '+' : ''}${value} `;
                        }
                    }
                    itemList += `${statsText}\n\n`;
                });

                categoryEmbed.addFields({ name: 'ë³´ìœ  ì•„ì´í…œ', value: itemList, inline: false });

                // ì•„ì´í…œ ì„ íƒ ë²„íŠ¼ë“¤ ì—…ë°ì´íŠ¸
                const itemButtons = new ActionRowBuilder();
                currentItems.forEach((item, index) => {
                    const globalIndex = startIndex + index;
                    const isEquipped = user.equipment[category] && user.equipment[category].id === item.id;
                    
                    itemButtons.addComponents(
                        new ButtonBuilder()
                            .setCustomId(`equip_item_${item.id}_${category}_${newPage}`)
                            .setLabel(`${globalIndex + 1}. ${item.name} ì¥ì°©`)
                            .setStyle(isEquipped ? ButtonStyle.Success : ButtonStyle.Primary)
                            .setDisabled(isEquipped)
                    );
                });

                // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                const navButtons = new ActionRowBuilder()
                    .addComponents(
                        new ButtonBuilder()
                            .setCustomId(`equip_${category}_prev_${newPage}`)
                            .setLabel('â—€ ì´ì „')
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(newPage === 0),
                        new ButtonBuilder()
                            .setCustomId(`equip_${category}_page_${newPage}`)
                            .setLabel(`${newPage + 1}/${totalPages}`)
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(true),
                        new ButtonBuilder()
                            .setCustomId(`equip_${category}_next_${newPage}`)
                            .setLabel('ë‹¤ìŒ â–¶')
                            .setStyle(ButtonStyle.Secondary)
                            .setDisabled(newPage >= totalPages - 1),
                        new ButtonBuilder()
                            .setCustomId('equipment')
                            .setLabel('ğŸ”™ ì¥ë¹„ ë©”ì¸')
                            .setStyle(ButtonStyle.Primary)
                    );

                const components = [itemButtons];
                if (totalPages > 1) {
                    components.push(navButtons);
                } else {
                    components.push(new ActionRowBuilder().addComponents(
                        new ButtonBuilder()
                            .setCustomId('equipment')
                            .setLabel('ğŸ”™ ì¥ë¹„ ë©”ì¸')
                            .setStyle(ButtonStyle.Primary)
                    ));
                }

                await interaction.update({
                    embeds: [categoryEmbed],
                    components: components
                });
            }
        }
        
        else if (interaction.customId === 'prev_page' || interaction.customId === 'next_page') {
            // ê²Œì„ ë©”ë‰´ í˜ì´ì§€ë„¤ì´ì…˜ ì²˜ë¦¬
            const currentEmbed = interaction.message.embeds[0];
            const footerText = currentEmbed.footer?.text || '';
            const pageMatch = footerText.match(/(\d+)\/(\d+)\s*í˜ì´ì§€/);
            
            let newPage;
            
            // ì´ˆê¸° ê²Œì„ ë©”ë‰´ì—ì„œ í˜ì´ì§€ë„¤ì´ì…˜ ì‹œì‘í•˜ëŠ” ê²½ìš° ì²˜ë¦¬
            if (!pageMatch && footerText.includes('ê²Œì„ ë©”ë‰´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤')) {
                // ì²« í˜ì´ì§€ë¡œ ê°„ì£¼
                if (interaction.customId === 'prev_page') {
                    await interaction.reply({ content: 'ì´ë¯¸ ì²« í˜ì´ì§€ì…ë‹ˆë‹¤!', ephemeral: true });
                    return;
                } else if (interaction.customId === 'next_page') {
                    newPage = 2; // ë‹¤ìŒ í˜ì´ì§€ëŠ” 2í˜ì´ì§€
                }
            } else if (pageMatch) {
                // ê¸°ì¡´ í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§
                const currentPage = parseInt(pageMatch[1]);
                const totalPages = parseInt(pageMatch[2]);
                
                newPage = currentPage;
                if (interaction.customId === 'prev_page' && currentPage > 1) {
                    newPage = currentPage - 1;
                } else if (interaction.customId === 'next_page' && currentPage < totalPages) {
                    newPage = currentPage + 1;
                }
                
                if (newPage === currentPage) {
                    await interaction.reply({ content: 'ë” ì´ìƒ ì´ë™í•  í˜ì´ì§€ê°€ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                    return;
                }
            } else {
                await interaction.reply({ content: 'í˜ì´ì§€ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ê¸°ì¡´ í˜ì´ì§€ êµ¬ì¡°ì™€ ë™ì¼í•˜ê²Œ ìƒì„±
            const pages = [
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('daily')
                            .setLabel('ğŸ ì¶œì„ì²´í¬')
                            .setStyle(ButtonStyle.Success),
                        new ButtonBuilder()
                            .setCustomId('work')
                            .setLabel('âš’ï¸ ì¼í•˜ê¸°')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('quest')
                            .setLabel('ğŸ“œ ì˜ë¢°')
                            .setStyle(ButtonStyle.Primary)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('hunting')
                            .setLabel('âš”ï¸ ì‚¬ëƒ¥í•˜ê¸°')
                            .setStyle(ButtonStyle.Danger),
                        new ButtonBuilder()
                            .setCustomId('pvp')
                            .setLabel('ğŸ›¡ï¸ PvP')
                            .setStyle(ButtonStyle.Danger)
                            .setDisabled(true)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('stats')
                            .setLabel('ğŸ’ª ëŠ¥ë ¥ì¹˜')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('skills')
                            .setLabel('ğŸ”® ìŠ¤í‚¬')
                            .setStyle(ButtonStyle.Primary)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('shop')
                            .setLabel('ğŸ›’ ìƒì ')
                            .setStyle(ButtonStyle.Secondary),
                        new ButtonBuilder()
                            .setCustomId('inventory')
                            .setLabel('ğŸ’ ì¸ë²¤í† ë¦¬')
                            .setStyle(ButtonStyle.Secondary)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('equipment')
                            .setLabel('âš”ï¸ ì¥ë¹„')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('enhancement')
                            .setLabel('âš¡ ê°•í™”')
                            .setStyle(ButtonStyle.Primary)
                            .setDisabled(user.level < 10),
                        new ButtonBuilder()
                            .setCustomId('ranking')
                            .setLabel('ğŸ† ë­í‚¹')
                            .setStyle(ButtonStyle.Secondary),
                        new ButtonBuilder()
                            .setCustomId('info')
                            .setLabel('ğŸ‘¤ ë‚´ì •ë³´')
                            .setStyle(ButtonStyle.Secondary)
                    ]
                }
            ];
            
            // ì‹œê°„ëŒ€ë³„ ì´ë¯¸ì§€ ë° ìƒ‰ìƒ (ì›ë³¸ê³¼ ë™ì¼)
            const currentTime = new Date();
            const hour = currentTime.getHours();
            
            let timeImage = '';
            let timeColor = '';
            
            if (hour >= 6 && hour < 12) {
                timeImage = 'kim_main_morning.png';
                timeColor = '#ffeb3b';
            } else if (hour >= 12 && hour < 18) {
                timeImage = 'kim_main_lunch.png';
                timeColor = '#ff9800';
            } else {
                timeImage = 'kim_main_night.png';
                timeColor = '#3f51b5';
            }
            
            const greetings = [
                'ì˜¤ëŠ˜ë„ í˜ì°¨ê²Œ ëª¨í—˜ì„ ë– ë‚˜ë³¼ê¹Œìš”?',
                'ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆë„¤ìš”!',
                'ëª¨í—˜ê°€ë‹˜, ì¤€ë¹„ëŠ” ë˜ì…¨ë‚˜ìš”?',
                'ì˜¤ëŠ˜ì€ ì–´ë–¤ ì¬ë¯¸ìˆëŠ” ì¼ì´ ìˆì„ê¹Œìš”?',
                'ê°•í™”ì™•ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
                'ë ˆë²¨ì—…ì„ í–¥í•´ ë‹¬ë ¤ê°€ë³¼ê¹Œìš”?',
                'ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!',
                'ëª¨í—˜ì´ ì—¬ëŸ¬ë¶„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!',
                'í–‰ìš´ì´ í•¨ê»˜í•˜ê¸¸ ë°”ëë‹ˆë‹¤!',
                'ìƒˆë¡œìš´ ë„ì „ì´ ì‹œì‘ë©ë‹ˆë‹¤!'
            ];
            
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            const maxExp = user.level * 100;
            const today = new Date().toDateString();
            const attendanceStatus = user.lastDaily === today ? 'ì¶œì„' : 'ê²°ì„';
            
            // í˜„ì¬ í˜ì´ì§€ì— í•´ë‹¹í•˜ëŠ” ë²„íŠ¼ë“¤ ê°€ì ¸ì˜¤ê¸°
            const currentPageIndex = newPage - 1; // 0-based index
            const currentPageButtons = pages[currentPageIndex];
            
            if (!currentPageButtons) {
                await interaction.reply({ content: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }
            
            // ì„ë² ë“œ ìƒì„± (ì›ë³¸ê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼)
            const statusEmbed = new EmbedBuilder()
                .setColor(timeColor)
                .setTitle(`${getUserTitle(user)} ${user.nickname}ë‹˜, ${randomGreeting}`)
                .addFields(
                    { name: 'â­ ë ˆë²¨', value: `\`\`\`Lv.${user.level}\`\`\``, inline: true },
                    { name: 'âœ¨ ê²½í—˜ì¹˜', value: `\`\`\`${user.exp}/${maxExp}\`\`\``, inline: true },
                    { name: '<:currency_emoji:1377404064316522778> ê³¨ë“œ', value: `\`\`\`${user.gold.toLocaleString()}\`\`\``, inline: true },
                    { name: 'ğŸ“… ì¶œì„í˜„í™©', value: `\`\`\`${attendanceStatus}\`\`\``, inline: true },
                    { name: 'ğŸ† ì¢…í•©ìˆœìœ„', value: `\`\`\`ì¤€ë¹„ì¤‘\`\`\``, inline: true },
                    { name: 'ğŸ’– ì¸ê¸°ë„', value: `\`\`\`${user.popularity}\`\`\``, inline: true }
                )
                .setImage(`attachment://${timeImage}`)
                .setFooter({ text: `${newPage}/5 í˜ì´ì§€` });
                
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
            const navigationRow = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('prev_page')
                        .setLabel('â—€')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(newPage === 1),
                    new ButtonBuilder()
                        .setCustomId('page_info')
                        .setLabel(`${newPage}/5`)
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId('next_page')
                        .setLabel('â–¶')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(newPage === 5)
                );
                
            // ì½˜í…ì¸  ë²„íŠ¼ (í˜„ì¬ í˜ì´ì§€ì˜ ë²„íŠ¼ë“¤)
            const contentRow = new ActionRowBuilder()
                .addComponents(currentPageButtons.buttons);
            
            // ì´ë¯¸ì§€ íŒŒì¼ ì²¨ë¶€
            const imageAttachment = new AttachmentBuilder(path.join(__dirname, 'resource', timeImage), { name: timeImage });
                
            await interaction.update({ 
                embeds: [statusEmbed], 
                components: [contentRow, navigationRow],
                files: [imageAttachment]
            });
        }
        
        else if (interaction.customId.startsWith('accept_quest_')) {
            const questId = parseInt(interaction.customId.split('_')[2]);
            
            // ì˜ë¢° ì°¾ê¸°
            const allClients = [
                ...QUEST_CLIENTS.villagers,
                ...QUEST_CLIENTS.merchants,
                ...QUEST_CLIENTS.scammers,
                ...QUEST_CLIENTS.travelers
            ];
            const quest = allClients.find(q => q.id === questId);
            
            if (!quest) {
                await interaction.update({ content: 'ì˜ë¢°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!', embeds: [], components: [] });
                return;
            }

            // ì¿¨íƒ€ì„ ì¶”ê°€
            addQuestCooldown(interaction.user.id);
            
            let resultEmbed;
            let embedColor;
            let resultTitle;
            let resultDescription;
            
            if (quest.type === 'scam') {
                // ì‚¬ê¸° ì˜ë¢° - ê³¨ë“œ ì°¨ê°
                if (user.gold < quest.scamAmount) {
                    resultEmbed = new EmbedBuilder()
                        .setColor('#95a5a6')
                        .setTitle('ğŸ’¸ ê³¨ë“œ ë¶€ì¡±')
                        .setDescription(`**${quest.name}**\n\n"ì•„... ê³¨ë“œê°€ ë¶€ì¡±í•˜ì‹œêµ°ìš”. ê·¸ëŸ¼ ë‹¤ìŒì— ë‹¤ì‹œ ì˜¤ì„¸ìš”!"`)
                        .addFields(
                            { name: 'ğŸ’° í˜„ì¬ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                            { name: 'ğŸ’¸ í•„ìš” ê³¨ë“œ', value: `${quest.scamAmount.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true }
                        )
                        .setFooter({ text: 'ë‹¤í–‰íˆ ì‚¬ê¸°ë¥¼ ë‹¹í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!' });
                } else {
                    user.gold -= quest.scamAmount;
                    await user.save();
                    
                    resultEmbed = new EmbedBuilder()
                        .setColor('#e74c3c')
                        .setTitle('ğŸ’¸ ì‚¬ê¸°ë‹¹í–ˆìŠµë‹ˆë‹¤!')
                        .setDescription(`**${quest.name}**\n\n"í•˜í•˜í•˜! ê³ ë§ˆì›Œìš”! ê·¸ëŸ¼ ì „ ì´ë§Œ..." *ë‹¬ì•„ë‚œë‹¤*`)
                        .addFields(
                            { name: 'ğŸ’¸ ìƒì€ ê³¨ë“œ', value: `${quest.scamAmount.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                            { name: 'ğŸ’° ë‚¨ì€ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true }
                        )
                        .setFooter({ text: 'ë‹¤ìŒì—” ì¡°ì‹¬í•˜ì„¸ìš”...' });
                }
            } else {
                // ì •ìƒ ì˜ë¢° - ë³´ìƒ ì§€ê¸‰
                const reward = calculateQuestReward(user.level, quest.type);
                
                user.gold += reward.gold;
                user.exp += reward.exp;
                
                // ë ˆë²¨ì—… ì²´í¬
                let levelUpMessage = '';
                const maxExp = user.level * 100;
                if (user.exp >= maxExp) {
                    const levelsGained = Math.floor(user.exp / maxExp);
                    user.level += levelsGained;
                    user.exp = user.exp % maxExp;
                    levelUpMessage = `\nğŸ‰ **ë ˆë²¨ì—…!** Lv.${user.level - levelsGained} â†’ Lv.${user.level}`;
                }
                
                await user.save();
                
                resultEmbed = new EmbedBuilder()
                    .setColor('#2ecc71')
                    .setTitle('âœ… ì˜ë¢° ì™„ë£Œ!')
                    .setDescription(`**${quest.name}**\n\n"ì •ë§ ê³ ë§ˆì›Œìš”! ì•½ì†í•œ ë³´ìƒì„ ë“œë¦´ê²Œìš”!"${levelUpMessage}`)
                    .addFields(
                        { name: 'ğŸ’° íšë“ ê³¨ë“œ', value: `+${reward.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                        { name: 'âœ¨ íšë“ ê²½í—˜ì¹˜', value: `+${reward.exp} EXP`, inline: true },
                        { name: 'ğŸ’ í˜„ì¬ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true }
                    )
                    .setFooter({ text: 'ì˜ë¢° ì™„ë£Œ! 30ë¶„ í›„ì— ë‹¤ì‹œ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.' });
            }
            
            const newQuestButton = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('quest')
                        .setLabel('ğŸ“œ ìƒˆ ì˜ë¢° ì°¾ê¸°')
                        .setStyle(ButtonStyle.Primary)
                        .setDisabled(true) // ì¿¨íƒ€ì„ ë•Œë¬¸ì— ë¹„í™œì„±í™”
                );

            await interaction.update({ 
                embeds: [resultEmbed], 
                components: [newQuestButton]
            });
        }
        
        else if (interaction.customId === 'decline_quest') {
            const declineEmbed = new EmbedBuilder()
                .setColor('#95a5a6')
                .setTitle('âŒ ì˜ë¢° ê±°ì ˆ')
                .setDescription('ì˜ë¢°ë¥¼ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤. ì–¸ì œë“ ì§€ ë‹¤ì‹œ ì˜ë¢°ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')
                .setFooter({ text: 'ë‹¤ë¥¸ ì˜ë¢°ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!' });

            const newQuestButton = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('quest')
                        .setLabel('ğŸ“œ ìƒˆ ì˜ë¢° ì°¾ê¸°')
                        .setStyle(ButtonStyle.Primary)
                );

            await interaction.update({ 
                embeds: [declineEmbed], 
                components: [newQuestButton]
            });
        }
        
        else if (interaction.customId === 'quest') {
            // ì¿¨íƒ€ì„ ì²´í¬
            const cooldownMinutes = checkQuestCooldown(interaction.user.id);
            if (cooldownMinutes) {
                await interaction.reply({ 
                    content: `â° ì˜ë¢° ì¿¨íƒ€ì„ì´ **${cooldownMinutes}ë¶„** ë‚¨ì•˜ìŠµë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
                return;
            }

            // ëœë¤ ì˜ë¢° ì„ íƒ
            const quest = getRandomQuest();
            
            const questEmbed = new EmbedBuilder()
                .setColor('#f39c12')
                .setTitle(`${quest.emoji} ${quest.title}`)
                .setDescription(`**${quest.name}**\n\n"${quest.description}"`)
                .setFooter({ text: 'ì˜ë¢°ë¥¼ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' });

            if (quest.type === 'scam') {
                questEmbed.setColor('#e74c3c');
            }

            const questButtons = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId(`accept_quest_${quest.id}`)
                        .setLabel('âœ… ìˆ˜ë½')
                        .setStyle(ButtonStyle.Success),
                    new ButtonBuilder()
                        .setCustomId('decline_quest')
                        .setLabel('âŒ ê±°ì ˆ')
                        .setStyle(ButtonStyle.Danger)
                );

            if (interaction.replied || interaction.deferred) {
                await interaction.editReply({ 
                    embeds: [questEmbed], 
                    components: [questButtons]
                });
            } else {
                await interaction.reply({ 
                    embeds: [questEmbed], 
                    components: [questButtons], 
                    ephemeral: true 
                });
            }
        }
        
        else if (interaction.customId === 'back_to_game_menu') {
            // /ê²Œì„ ëª…ë ¹ì–´ì™€ ì™„ì „íˆ ë™ì¼í•œ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°
            // ì‹œê°„ëŒ€ë³„ ì´ë¯¸ì§€ ë° ì¸ì‚¬ë§ ì„¤ì •
            const now = new Date();
            const hour = now.getHours();
            
            let timeImage = '';
            let timeColor = '';
            
            if (hour >= 6 && hour < 12) {
                // ì•„ì¹¨ ì‹œê°„ëŒ€ (6:00 - 11:59)
                timeImage = 'kim_main_morning.png';
                timeColor = '#ffeb3b'; // ë…¸ë€ìƒ‰
            } else if (hour >= 12 && hour < 18) {
                // ì ì‹¬ ì‹œê°„ëŒ€ (12:00 - 17:59)
                timeImage = 'kim_main_lunch.png';
                timeColor = '#ff9800'; // ì£¼í™©ìƒ‰
            } else {
                // ì €ë…/ë°¤ ì‹œê°„ëŒ€ (18:00 - 5:59)
                timeImage = 'kim_main_night.png';
                timeColor = '#3f51b5'; // ë‚¨ìƒ‰
            }

            // ìƒíƒœì°½ (RPG ìŠ¤íƒ€ì¼)
            const greetings = [
                'ì˜¤ëŠ˜ë„ í˜ì°¨ê²Œ ëª¨í—˜ì„ ë– ë‚˜ë³¼ê¹Œìš”?',
                'ìƒˆë¡œìš´ í•˜ë£¨ê°€ ì‹œì‘ë˜ì—ˆë„¤ìš”!',
                'ëª¨í—˜ê°€ë‹˜, ì¤€ë¹„ëŠ” ë˜ì…¨ë‚˜ìš”?',
                'ì˜¤ëŠ˜ì€ ì–´ë–¤ ì¬ë¯¸ìˆëŠ” ì¼ì´ ìˆì„ê¹Œìš”?',
                'ê°•í™”ì™•ì˜ ì„¸ê³„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!',
                'ë ˆë²¨ì—…ì„ í–¥í•´ ë‹¬ë ¤ê°€ë³¼ê¹Œìš”?',
                'ì˜¤ëŠ˜ë„ ì¢‹ì€ í•˜ë£¨ ë˜ì„¸ìš”!',
                'ëª¨í—˜ì´ ì—¬ëŸ¬ë¶„ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì–´ìš”!',
                'í–‰ìš´ì´ í•¨ê»˜í•˜ê¸¸ ë°”ëë‹ˆë‹¤!',
                'ìƒˆë¡œìš´ ë„ì „ì´ ì‹œì‘ë©ë‹ˆë‹¤!'
            ];
            
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            
            // ê²½í—˜ì¹˜ ê³„ì‚° ìˆ˜ì • (ë ˆë²¨ì—… ì‹œ í•„ìš” ê²½í—˜ì¹˜ = ë ˆë²¨ * 100)
            const maxExp = user.level * 100;
            
            // ì¶œì„ í˜„í™© ê³„ì‚° (ì˜¤ëŠ˜ ì¶œì„ì²´í¬ ì—¬ë¶€)
            const today = new Date().toDateString();
            const attendanceStatus = user.lastDaily === today ? 'ì¶œì„' : 'ê²°ì„';

            const statusEmbed = new EmbedBuilder()
                .setColor(timeColor)
                .setTitle(`${getUserTitle(user)} ${user.nickname}ë‹˜, ${randomGreeting}`)
                .addFields(
                    { name: 'â­ ë ˆë²¨', value: `\`\`\`Lv.${user.level}\`\`\``, inline: true },
                    { name: 'âœ¨ ê²½í—˜ì¹˜', value: `\`\`\`${user.exp}/${maxExp}\`\`\``, inline: true },
                    { name: '<:currency_emoji:1377404064316522778> ê³¨ë“œ', value: `\`\`\`${user.gold.toLocaleString()}\`\`\``, inline: true },
                    { name: 'ğŸ“… ì¶œì„í˜„í™©', value: `\`\`\`${attendanceStatus}\`\`\``, inline: true },
                    { name: 'ğŸ† ì¢…í•©ìˆœìœ„', value: `\`\`\`ì¤€ë¹„ì¤‘\`\`\``, inline: true },
                    { name: 'ğŸ’– ì¸ê¸°ë„', value: `\`\`\`${user.popularity}\`\`\``, inline: true }
                )
                .setImage(`attachment://${timeImage}`)
                .setFooter({ text: 'ê²Œì„ ë©”ë‰´ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!' });

            // í˜ì´ì§€ë³„ ë²„íŠ¼ ì •ì˜ (/ê²Œì„ê³¼ ë™ì¼)
            const pages = [
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('daily')
                            .setLabel('ğŸ ì¶œì„ì²´í¬')
                            .setStyle(ButtonStyle.Success),
                        new ButtonBuilder()
                            .setCustomId('work')
                            .setLabel('âš’ï¸ ì¼í•˜ê¸°')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('quest')
                            .setLabel('ğŸ“œ ì˜ë¢°')
                            .setStyle(ButtonStyle.Primary)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('hunting')
                            .setLabel('âš”ï¸ ì‚¬ëƒ¥í•˜ê¸°')
                            .setStyle(ButtonStyle.Danger),
                        new ButtonBuilder()
                            .setCustomId('pvp')
                            .setLabel('ğŸ›¡ï¸ PvP')
                            .setStyle(ButtonStyle.Danger)
                            .setDisabled(true)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('stats')
                            .setLabel('ğŸ’ª ëŠ¥ë ¥ì¹˜')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('skills')
                            .setLabel('ğŸ”® ìŠ¤í‚¬')
                            .setStyle(ButtonStyle.Primary)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('shop')
                            .setLabel('ğŸ›’ ìƒì ')
                            .setStyle(ButtonStyle.Secondary),
                        new ButtonBuilder()
                            .setCustomId('inventory')
                            .setLabel('ğŸ’ ì¸ë²¤í† ë¦¬')
                            .setStyle(ButtonStyle.Secondary)
                    ]
                },
                {
                    buttons: [
                        new ButtonBuilder()
                            .setCustomId('equipment')
                            .setLabel('âš”ï¸ ì¥ë¹„')
                            .setStyle(ButtonStyle.Primary),
                        new ButtonBuilder()
                            .setCustomId('enhancement')
                            .setLabel('âš¡ ê°•í™”')
                            .setStyle(ButtonStyle.Primary)
                            .setDisabled(user.level < 10),
                        new ButtonBuilder()
                            .setCustomId('ranking')
                            .setLabel('ğŸ† ë­í‚¹')
                            .setStyle(ButtonStyle.Secondary),
                        new ButtonBuilder()
                            .setCustomId('info')
                            .setLabel('ğŸ‘¤ ë‚´ì •ë³´')
                            .setStyle(ButtonStyle.Secondary)
                    ]
                }
            ];

            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
            const navigationRow = new ActionRowBuilder()
                .addComponents(
                    new ButtonBuilder()
                        .setCustomId('prev_page')
                        .setLabel('â—€')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId('page_info')
                        .setLabel('1/5')
                        .setStyle(ButtonStyle.Secondary)
                        .setDisabled(true),
                    new ButtonBuilder()
                        .setCustomId('next_page')
                        .setLabel('â–¶')
                        .setStyle(ButtonStyle.Secondary)
                );

            // ì²« í˜ì´ì§€ ë²„íŠ¼ row
            const contentRow = new ActionRowBuilder()
                .addComponents(pages[0].buttons);
                
            const attachment = new AttachmentBuilder(path.join(__dirname, 'resource', timeImage), { name: timeImage });

            await interaction.update({ 
                embeds: [statusEmbed], 
                components: [contentRow, navigationRow], 
                files: [attachment] 
            });
        }
    } catch (error) {
        console.error('ì¸í„°ë ‰ì…˜ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    }
});

// Modal ì œì¶œ ì²˜ë¦¬
client.on('interactionCreate', async (interaction) => {
    if (!interaction.isModalSubmit()) return;
    
    if (interaction.customId === 'registerModal') {
        const nickname = interaction.fields.getTextInputValue('nickname');
        const email = interaction.fields.getTextInputValue('email');
        
        try {
            const user = await User.findOne({ discordId: interaction.user.id });
            if (!user) {
                await interaction.reply({ content: 'ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤. ë¨¼ì € /ê°€ì… ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ê°€ì…í•´ì£¼ì„¸ìš”!', ephemeral: true });
                return;
            }

            // ì´ë¯¸ íšŒì›ê°€ì… í–ˆëŠ”ì§€ í™•ì¸
            if (user.registered) {
                await interaction.editReply({ content: 'ì´ë¯¸ íšŒì›ê°€ì…ì„ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤!' });
                return;
            }

            // ë‹‰ë„¤ì„ ì¤‘ë³µ ì²´í¬
            const existingUser = await User.findOne({ nickname });
            if (existingUser) {
                await interaction.editReply({ content: 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤!' });
                return;
            }

            // ì´ë©”ì¼ í˜•ì‹ ê²€ì¦
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                await interaction.editReply({ content: 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤!' });
                return;
            }

            // ì¸ì¦ì½”ë“œ ìƒì„± ë° ì €ì¥
            const verificationCode = generateVerificationCode();
            const expiresAt = new Date(Date.now() + 10 * 60 * 1000); // 10ë¶„ í›„ ë§Œë£Œ

            user.nickname = nickname;
            user.email = email;
            user.emailVerificationCode = verificationCode;
            user.emailVerificationExpires = expiresAt;
            
            await user.save();

            // ì´ë©”ì¼ ì „ì†¡
            try {
                await sendVerificationEmail(email, verificationCode);
                await interaction.editReply({ 
                    content: `íšŒì›ê°€ì… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! \n**${email}**ë¡œ ì¸ì¦ì½”ë“œë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.\n\`/ì¸ì¦ [ì½”ë“œ]\` ëª…ë ¹ì–´ë¡œ ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.`
                });
            } catch (emailError) {
                console.error('ì´ë©”ì¼ ì „ì†¡ ì˜¤ë¥˜:', emailError);
                await interaction.editReply({ 
                    content: 'íšŒì›ê°€ì… ì •ë³´ëŠ” ì €ì¥ë˜ì—ˆì§€ë§Œ ì´ë©”ì¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.'
                });
            }
        } catch (error) {
            console.error('íšŒì›ê°€ì… ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            await interaction.editReply({ content: 'íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤!' });
        }
    }
});

// ì´ëª¨ì§€ ë°˜ì‘ ì¶”ê°€ ì´ë²¤íŠ¸
client.on('messageReactionAdd', async (reaction, user) => {
    try {
        // ë´‡ì˜ ë°˜ì‘ì€ ë¬´ì‹œ
        if (user.bot) return;
        
        // ë¶€ë¶„ì ì¸ ë©”ì‹œì§€ì¸ ê²½ìš° ì „ì²´ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
        if (reaction.partial) {
            try {
                await reaction.fetch();
            } catch (error) {
                console.error('ë°˜ì‘ fetch ì˜¤ë¥˜:', error);
                return;
            }
        }
        
        // ë©”ì‹œì§€ ì‘ì„±ìê°€ ë´‡ì¸ ê²½ìš° ë¬´ì‹œ
        if (reaction.message.author.bot) return;
        
        // ìê¸° ìì‹ ì˜ ë©”ì‹œì§€ì— ëŒ€í•œ ë°˜ì‘ ë¬´ì‹œ
        if (reaction.message.author.id === user.id) return;
        
        // ì¸ê¸°ë„ ê´€ë ¨ ì´ëª¨ì§€ í™•ì¸
        const popularityEmojis = {
            'â¤ï¸': 1,    // í•˜íŠ¸: +1
            'ğŸ‘': 1,    // ë”°ë´‰: +1
            'ğŸ˜¢': -1,   // ìŠ¬í””: -1
            'ğŸ˜­': -1    // ëŒ€ì„±í†µê³¡: -1 (ì¶”ê°€)
        };
        
        const emojiName = reaction.emoji.name;
        if (!popularityEmojis.hasOwnProperty(emojiName)) return;
        
        const value = popularityEmojis[emojiName];
        const result = await updatePopularity(
            reaction.message.author.id,
            emojiName,
            value,
            reaction.message.id,
            reaction.message.guild
        );
        
        // ê²°ê³¼ ë¡œê·¸
        if (result.success) {
            console.log(`ì¸ê¸°ë„ ì—…ë°ì´íŠ¸: ${reaction.message.author.tag} ${result.message}`);
        }
    } catch (error) {
        console.error('ë©”ì‹œì§€ ë°˜ì‘ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    }
});

// ì´ëª¨ì§€ ë°˜ì‘ ì œê±° ì´ë²¤íŠ¸ (ì„ íƒì‚¬í•­)
client.on('messageReactionRemove', async (reaction, user) => {
    try {
        // ë´‡ì˜ ë°˜ì‘ì€ ë¬´ì‹œ
        if (user.bot) return;
        
        // ë¶€ë¶„ì ì¸ ë©”ì‹œì§€ì¸ ê²½ìš° ì „ì²´ ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
        if (reaction.partial) {
            try {
                await reaction.fetch();
            } catch (error) {
                console.error('ë°˜ì‘ fetch ì˜¤ë¥˜:', error);
                return;
            }
        }
        
        // ë©”ì‹œì§€ ì‘ì„±ìê°€ ë´‡ì¸ ê²½ìš° ë¬´ì‹œ
        if (reaction.message.author.bot) return;
        
        // ìê¸° ìì‹ ì˜ ë©”ì‹œì§€ì— ëŒ€í•œ ë°˜ì‘ ë¬´ì‹œ
        if (reaction.message.author.id === user.id) return;
        
        // ë°˜ì‘ ì œê±° ì‹œ ì¸ê¸°ë„ ì›ë³µ (ì„ íƒì‚¬í•­)
        // í•„ìš”í•œ ê²½ìš° êµ¬í˜„ ê°€ëŠ¥
    } catch (error) {
        console.error('ë©”ì‹œì§€ ë°˜ì‘ ì œê±° ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    }
});

// ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ìƒí˜¸ì‘ìš© ì²˜ë¦¬
client.on('interactionCreate', async (interaction) => {
    if (!interaction.isStringSelectMenu() && !interaction.isButton()) return;
    
    try {
        const user = await getUser(interaction.user.id);
        if (!user || !user.registered) {
            await interaction.reply({ content: 'ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤. ë¨¼ì € /ê°€ì…ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!', ephemeral: true });
            return;
        }

        // ì— ë¸”ëŸ¼ ê³„ì—´ ì„ íƒ
        if (interaction.customId === 'emblem_category') {
            const category = interaction.values[0];
            const emblemData = EMBLEMS[category];
            
            if (!emblemData) {
                await interaction.reply({ content: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê³„ì—´ì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            // ì´ë¯¸ ì— ë¸”ëŸ¼ ë³´ìœ  í™•ì¸
            if (user.emblem) {
                await interaction.reply({ 
                    content: `ì´ë¯¸ **${user.emblem}** ì— ë¸”ëŸ¼ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤! ì— ë¸”ëŸ¼ì€ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, 
                    ephemeral: true 
                });
                return;
            }

            // ë ˆë²¨ 20 ì´ìƒ í™•ì¸
            if (user.level < 20) {
                await interaction.reply({ 
                    content: `ì— ë¸”ëŸ¼ì„ êµ¬ë§¤í•˜ë ¤ë©´ **ë ˆë²¨ 20 ì´ìƒ**ì´ì–´ì•¼ í•©ë‹ˆë‹¤! (í˜„ì¬ ë ˆë²¨: ${user.level})`, 
                    ephemeral: true 
                });
                return;
            }

            // êµ¬ë§¤ ê°€ëŠ¥í•œ ì— ë¸”ëŸ¼ ëª©ë¡ ìƒì„±
            const availableEmblems = emblemData.emblems.filter(emblem => user.level >= emblem.level);
            
            if (availableEmblems.length === 0) {
                await interaction.reply({ 
                    content: `ì´ ê³„ì—´ì˜ ì— ë¸”ëŸ¼ì„ êµ¬ë§¤í•˜ë ¤ë©´ ë” ë†’ì€ ë ˆë²¨ì´ í•„ìš”í•©ë‹ˆë‹¤!`, 
                    ephemeral: true 
                });
                return;
            }

            // ì— ë¸”ëŸ¼ ì„ íƒ ì„ë² ë“œ ìƒì„±
            const categoryEmbed = new EmbedBuilder()
                .setColor('#ff6b6b')
                .setTitle(`${emblemData.emoji} ${emblemData.name} ê³„ì—´ ì— ë¸”ëŸ¼`)
                .setDescription(`**${user.nickname}**ë‹˜ì´ êµ¬ë§¤ ê°€ëŠ¥í•œ ì— ë¸”ëŸ¼ ëª©ë¡ì…ë‹ˆë‹¤.\n\n**âš ï¸ í•œ ë²ˆ êµ¬ë§¤í•˜ë©´ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!**`)
                .setFooter({ text: 'ì›í•˜ëŠ” ì— ë¸”ëŸ¼ì„ ì„ íƒí•˜ì—¬ êµ¬ë§¤í•˜ì„¸ìš”!' });

            // ì— ë¸”ëŸ¼ ëª©ë¡ í…ìŠ¤íŠ¸ ìƒì„±
            let emblemList = '';
            availableEmblems.forEach((emblem, index) => {
                const canAfford = user.gold >= emblem.price;
                emblemList += `**${emblem.name}**\n`;
                emblemList += `ğŸ’° ê°€ê²©: ${emblem.price.toLocaleString()}<:currency_emoji:1377404064316522778> ${canAfford ? 'âœ…' : 'âŒ'}\n`;
                emblemList += `ğŸ“Š í•„ìš” ë ˆë²¨: Lv.${emblem.level}\n\n`;
            });

            categoryEmbed.addFields({ name: 'êµ¬ë§¤ ê°€ëŠ¥í•œ ì— ë¸”ëŸ¼', value: emblemList, inline: false });

            // ì— ë¸”ëŸ¼ êµ¬ë§¤ ë²„íŠ¼ë“¤
            const emblemButtons = new ActionRowBuilder();
            availableEmblems.slice(0, 5).forEach((emblem, index) => {
                emblemButtons.addComponents(
                    new ButtonBuilder()
                        .setCustomId(`buy_emblem_${category}_${index}`)
                        .setLabel(`${emblem.name} êµ¬ë§¤`)
                        .setStyle(user.gold >= emblem.price ? ButtonStyle.Primary : ButtonStyle.Secondary)
                        .setDisabled(user.gold < emblem.price)
                );
            });

            await interaction.reply({
                embeds: [categoryEmbed],
                components: [emblemButtons],
                ephemeral: true
            });
        }

        // ì— ë¸”ëŸ¼ êµ¬ë§¤
        else if (interaction.customId.startsWith('buy_emblem_')) {
            const parts = interaction.customId.split('_');
            const category = parts[2];
            const emblemIndex = parseInt(parts[3]);

            const emblemData = EMBLEMS[category];
            if (!emblemData || !emblemData.emblems[emblemIndex]) {
                await interaction.reply({ content: 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì— ë¸”ëŸ¼ì…ë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            const emblem = emblemData.emblems[emblemIndex];

            // ì¬í™•ì¸
            if (user.emblem) {
                await interaction.reply({ content: 'ì´ë¯¸ ì— ë¸”ëŸ¼ì„ ë³´ìœ í•˜ê³  ìˆìŠµë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            if (user.level < emblem.level) {
                await interaction.reply({ content: `ë ˆë²¨ì´ ë¶€ì¡±í•©ë‹ˆë‹¤! (í•„ìš”: Lv.${emblem.level}, í˜„ì¬: Lv.${user.level})`, ephemeral: true });
                return;
            }

            if (user.gold < emblem.price) {
                await interaction.reply({ content: 'ê³¨ë“œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!', ephemeral: true });
                return;
            }

            // êµ¬ë§¤ ì²˜ë¦¬
            user.gold -= emblem.price;
            user.emblem = emblem.name;
            await user.save();

            // Discord ì—­í•  ë¶€ì—¬
            try {
                const guild = interaction.guild;
                let role = guild.roles.cache.find(r => r.name === emblem.roleName);
                
                if (!role) {
                    role = await guild.roles.create({
                        name: emblem.roleName,
                        color: '#FF6B00',
                        reason: 'ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ìë™ ìƒì„±'
                    });
                }

                const member = await guild.members.fetch(interaction.user.id);
                await member.roles.add(role);
            } catch (error) {
                console.error('ì—­í•  ë¶€ì—¬ ì˜¤ë¥˜:', error);
            }

            const purchaseEmbed = new EmbedBuilder()
                .setColor('#00ff00')
                .setTitle('ğŸ† ì— ë¸”ëŸ¼ êµ¬ë§¤ ì„±ê³µ!')
                .setDescription(`**${emblem.name}** ì— ë¸”ëŸ¼ì„ ì„±ê³µì ìœ¼ë¡œ êµ¬ë§¤í–ˆìŠµë‹ˆë‹¤!`)
                .addFields(
                    { name: 'ğŸ’ íšë“í•œ ì¹­í˜¸', value: emblem.name, inline: true },
                    { name: 'ğŸ’° ê²°ì œ ê¸ˆì•¡', value: `${emblem.price.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true },
                    { name: 'ğŸ’° ì”ì—¬ ê³¨ë“œ', value: `${user.gold.toLocaleString()}<:currency_emoji:1377404064316522778>`, inline: true }
                )
                .setFooter({ text: 'ì´ì œ ê²Œì„ì—ì„œ ìƒˆë¡œìš´ ì¹­í˜¸ë¡œ í‘œì‹œë©ë‹ˆë‹¤!' });

            await interaction.reply({
                embeds: [purchaseEmbed],
                ephemeral: true
            });
        }

    } catch (error) {
        console.error('ì— ë¸”ëŸ¼ ì‹œìŠ¤í…œ ì˜¤ë¥˜:', error);
        await interaction.reply({ content: 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!', ephemeral: true });
    }
});

// ë´‡ ë¡œê·¸ì¸
client.login(TOKEN); 
